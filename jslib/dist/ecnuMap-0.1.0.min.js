/*!  ecnuMap-0.1.0.js  17-03-2016 */
function showOtherMap_eagle(){var a=eagleEye_self,b=a._tianContainer,c=a._eagleWidth,d=(a._eagleHeight,a.eCenterX),e=a.eCenterY,f=a.eagleZoom,g=f/c,h=parseInt(Math.log(g)/Math.log(2))+1;console.log("other zl",18-h);var i=gEcnu.Util.shToLngLat(d,e);switch(a.mapSource){case"GOOGLE":var j={center:new google.maps.LatLng(i.lat,i.lng),zoom:18-h,mapTypeControl:!1,panControl:!1,zoomControl:!1,scaleControl:!1,rotateControl:!1,streetViewControl:!1},k=new google.maps.Map(b,j);eagleEye_self.eagleBasemap=k;break;case"BAIDU":var l=new BMap.Point(i.lng,i.lat),k=new BMap.Map(b.id);k.centerAndZoom(l,19-h),eagleEye_self.eagleBasemap=k;break;case"TMAP":var i=gEcnu.Util.shToLngLat(d-400,e+230),k=new TMap(b.id);k.centerAndZoom(new TLngLat(i.lng,i.lat),18-h),eagleEye_self.eagleBasemap=k}}function showOtherMap_self(){var a=gSelf.coordsFlag;"GEOGRAPHIC"==a?addOther_geo():addOther_proj()}function addOther_geo(){var a=gSelf.getCenter(),b=gSelf.getZoom(),c=b.z;switch(gSelf.activeLayer.mapSource){case"google":var d=.001373291015625,e=d*gSelf.w,f=Math.ceil(10-Math.log(c/e)/Math.log(2));f>18&&(f=18),1>f&&(f=1);var g=e*Math.pow(2,10-f);gSelf.zoom=g;var h={center:new google.maps.LatLng(a.y,a.x),zoom:f,mapTypeControl:!1,panControl:!1,zoomControl:!1,scaleControl:!1,rotateControl:!1,streetViewControl:!1},i=document.getElementById(gSelf.activeLayer.id);gSelf.activeLayer.oMap=new google.maps.Map(i,h),gSelf.activeLayer.oMap.Minlevel=1,gSelf.activeLayer.oMap.MaxLevel=18;break;case"tianditu":var d=.0013767249999999897,e=d*gSelf.w,f=Math.ceil(10-Math.log(c/e)/Math.log(2));f>18&&(f=18),1>f&&(f=1);var g=e*Math.pow(2,10-f);gSelf.zoom=g,gSelf.activeLayer.oMap=new TMap(gSelf.activeLayer.id),gSelf.activeLayer.oMap.centerAndZoom(new TLngLat(a.x,a.y),f),gSelf.activeLayer.oMap.Minlevel=1,gSelf.activeLayer.oMap.MaxLevel=18;break;case"baidu":var d=.0011498312500000019,e=d*gSelf.w,f=Math.ceil(11-Math.log(c/e)/Math.log(2));f>19&&(f=19),1>f&&(f=1);var g=e*Math.pow(2,11-f);gSelf.zoom=g;var j=new BMap.Point(a.x,a.y);gSelf.activeLayer.oMap=new BMap.Map(gSelf.activeLayer.id),gSelf.activeLayer.oMap.centerAndZoom(j,f),gSelf.activeLayer.oMap.Minlevel=1,gSelf.activeLayer.oMap.MaxLevel=19}for(var k=gSelf.getAllLayers(),l=0;l<k.length;l++)"otherLayer"!=k[l].oClass&&k[l].renew()}function addOther_proj(){var a=gSelf.getCenter(),b=gSelf.getZoom(),c=gEcnu.Util.shToLngLat(a.x,a.y),d=gSelf.getSize().w,e=b.z/d,f=parseInt(Math.log(e)/Math.log(2))+1,e=Math.pow(2,f-1);switch(gSelf.zoom=e*d,gSelf.activeLayer.mapSource){case"google":var g={center:new google.maps.LatLng(c.lat,c.lng),zoom:18-f,mapTypeControl:!1,panControl:!1,zoomControl:!1,scaleControl:!1,rotateControl:!1,streetViewControl:!1},h=document.getElementById(gSelf.activeLayer.id);gSelf.activeLayer.oMap=new google.maps.Map(h,g),gSelf.activeLayer.oMap.Minlevel=1,gSelf.activeLayer.oMap.MaxLevel=18;break;case"baidu":var i=new BMap.Point(c.lng,c.lat);gSelf.activeLayer.oMap=new BMap.Map(gSelf.activeLayer.id),gSelf.activeLayer.oMap.centerAndZoom(i,19-f),gSelf.activeLayer.oMap.Minlevel=1,gSelf.activeLayer.oMap.MaxLevel=19;break;case"tianditu":var c=gEcnu.Util.shToLngLat(a.x-410,a.y+260);gSelf.activeLayer.oMap=new TMap(gSelf.activeLayer.id),gSelf.activeLayer.oMap.centerAndZoom(new TLngLat(c.lng,c.lat),18-f),gSelf.activeLayer.oMap.Minlevel=1,gSelf.activeLayer.oMap.MaxLevel=18}for(var j=gSelf.getAllLayers(),k=0;k<j.length;k++)"otherLayer"!=j[k].oClass&&j[k].renew()}var gEcnu={};gEcnu.config={version:"1.0.0",maxLevel:7,minLevel:1,tileWidth:250,tileHeight:200,tileMapURL:"http://webgis.ecnu.edu.cn:81/",tileMapURL_Ex:"https://ccgis.cn/mapb/",geoserver:"/mapb/",imgPath:"common/imgs/images/",cat:"webroot/slprj/acesy/"},gEcnu.setConfig=function(a){if(a&&"[object Object]"===Object.prototype.toString.call(a))for(var b in a)gEcnu.config[b]&&(gEcnu.config[b]=a[b])},function(){var a=!1;gClass=function(){},gClass.extend=function(b){function c(){a||(d&&(this._superprototype=d.prototype),this.init.apply(this,arguments))}var d=null;this!==gClass&&(d=this),d&&(a=!0,c.prototype=new d,c.prototype.constructor=c,a=!1),c.extend=arguments.callee;for(var e in b)b.hasOwnProperty(e)&&(d&&"function"==typeof b[e]&&"function"==typeof c.prototype[e]&&/\b_super\b/.test(b[e])?c.prototype[e]=function(a,b){return function(){return this._super=d.prototype[a],b.apply(this,arguments)}}(e,b[e]):c.prototype[e]=b[e]);return c}}(),gEcnu.Util={},gEcnu.Util.createDiv=function(a,b,c,d){var e=document.createElement("div");return e.id=a,e.style.width=b+"px",e.style.height=c+"px",d&&(e.style.position="absolute"),e.style.zIndex=1,e},gEcnu.Util.createTextArea=function(a,b,c,d){var e=document.createElement("textarea");return e.id=a,e.style.width=b+"px",e.style.height=c+"px",d&&(e.style.position="absolute"),e.style.zIndex=1,e},gEcnu.Util.createCanvas=function(a,b,c,d){var e=document.createElement("canvas");return 0!=gEcnu.Util.getIEVersion()&&(e=window.G_vmlCanvasManager.initElement(e)),e.id=a,e.width=b,e.height=c,e.style.width=b+"px",e.style.height=c+"px",d&&(e.style.position="absolute"),e},gEcnu.Util.isInArray=function(a,b){for(var c in a)if(a[c]==b)return!0;return!1},gEcnu.Util.isObjInArray=function(a,b){for(var c in a)if(a[c].id==b.id)return alert("已被添加，请更换图层id"+b.id),!0;return!1},gEcnu.Util.transformProj2Geo=function(a){for(var b=a.length,c=0;b>c;c++){var d=a[c],e=d.shape.Points,f=d.shape.shpBox,g=d._lineRings;d.shape.Points=gEcnu.Util.trans2Geo(e),d.shape.shpBox=gEcnu.Util.transShpbox2Geo(f);for(var h=0,i=g.length;i>h;h++){var j=g[h].points;d._lineRings[h].points=gEcnu.Util.trans2Geo(j)}}return a},gEcnu.Util.trans2Geo=function(a){for(var b=a.length,c=[],d=0;b>d;d++){var e=a[d],f=gEcnu.Util.shToLngLat(e.x,e.y),g={x:f.lng,y:f.lat};c.push(g)}return c},gEcnu.Util.transShpbox2Geo=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=gEcnu.Util.shToLngLat(b,c),g=gEcnu.Util.shToLngLat(d,e),h=f.lat,i=g.lat,j=f.lng,k=g.lng,l=[j,h,k,i];return l},gEcnu.Util.transformGeo2Proj=function(a){for(var b=a.length,c=0;b>c;c++){var d=a[c],e=d.shape.Points,f=d.shape.shpBox,g=d._lineRings;d.shape.Points=gEcnu.Util.trans2Proj(e),d.shape.shpBox=gEcnu.Util.transShpbox2Proj(f);for(var h=0,i=g.length;i>h;h++){var j=g[h].points;d._lineRings[h].points=gEcnu.Util.trans2Proj(j)}}return a},gEcnu.Util.trans2Proj=function(a){for(var b=a.length,c=[],d=0;b>d;d++){var e=a[d],f=gEcnu.Util.lnglatToSh(e.x,e.y),g={x:f.x,y:f.y};c.push(g)}return c},gEcnu.Util.transShpbox2Proj=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=gEcnu.Util.lnglatToSh(b,c),g=gEcnu.Util.lnglatToSh(d,e),b=f.x,d=g.x,c=f.y,e=g.y,h=[b,c,d,e];return h},gEcnu.Util.worldToScreen=function(a,b){var c=gSelf.getCenter(),d=c.x,e=c.y,f=parseInt(gSelf.w)/2,g=parseInt(gSelf.h)/2,h=gSelf.zoom/parseInt(gSelf.w),i=parseFloat(f)+parseFloat((a-d)/h)+.5,j=parseFloat(g)-parseFloat((b-e)/h)+.5;return{x:i,y:j}},gEcnu.Util.screenToWorld=function(a,b){var c=gSelf.getCenter(),d=c.x,e=c.y,f=parseInt(gSelf.w)/2,g=parseInt(gSelf.h)/2,h=gSelf.zoom/parseInt(gSelf.w),i=parseFloat(d)+parseFloat((a-f)*h),j=parseFloat(e)-parseFloat((b-g)*h);return{x:i,y:j}},gEcnu.Util.worldToScreen_geo=function(a,b){var c=gSelf.getCenter(),d=c.x,e=c.y,f=parseInt(gSelf.w)/2,g=parseInt(gSelf.h)/2,h=gSelf.zoom/parseInt(gSelf.w);if("GEOGRAPHIC"==gSelf.coordsFlag){var i=c.x,j=c.y;d=111e3*i*Math.cos(j),e=111e3*j;var k=111.31955*gSelf.zoom*1e3;h=k/parseInt(gSelf.w)}var l=f+parseFloat(a-d)/h+.5,m=g-parseFloat(b-e)/h+.5;return{x:l,y:m}},gEcnu.Util.screenToWorld_geo=function(a,b){var c=gSelf.getCenter(),d=c.x,e=c.y,f=parseInt(gSelf.w)/2,g=parseInt(gSelf.h)/2,h=gSelf.zoom/parseInt(gSelf.w);if("GEOGRAPHIC"==gSelf.coordsFlag){var i=c.x,j=c.y;d=111e3*i*Math.cos(j),e=111e3*j;var k=111.31955*gSelf.zoom*1e3;h=k/parseInt(gSelf.w)}var l=d+parseFloat(a-f)*h,m=e-parseFloat(b-g)*h;return{x:l,y:m}},gEcnu.Util.getMouseXY=function(a,b){var c=0,d=0,e=b.srcElement?b.srcElement:b.target;if(1!=e.nodeType)return{x:c,y:d};if(document.attachEvent){var f="medium"==gEcnu.Util.getEleStyle(e,"border-top-width")?0:gEcnu.Util.delpx(gEcnu.Util.getEleStyle(e,"border-top-width")),g="medium"==gEcnu.Util.getEleStyle(e,"border-left-width")?0:gEcnu.Util.delpx(gEcnu.Util.getEleStyle(e,"border-left-width"));c=b.layerX-g,d=b.layerY-f}else{for(;e&&e!=a;){var f="medium"==gEcnu.Util.getEleStyle(e,"border-top-width")?0:gEcnu.Util.delpx(gEcnu.Util.getEleStyle(e,"border-top-width")),g="medium"==gEcnu.Util.getEleStyle(e,"border-left-width")?0:gEcnu.Util.delpx(gEcnu.Util.getEleStyle(e,"border-left-width"));c+=e.offsetLeft+g,d+=e.offsetTop+f,e=e.offsetParent}c=b.offsetX+c+document.body.scrollLeft,d=b.offsetY+d+document.body.scrollTop}return{x:c,y:d}},gEcnu.Util.getTouchXY=function(a){for(var b=0;b<a.targetTouches.length;b++){var c=a.targetTouches[b];ox=c.pageX,oy=c.pageY}return x=ox-gSelf.mapLeft,y=oy-gSelf.mapTop,{x:x,y:y}},gEcnu.Util.getTouchPos=function(a){var b={x:0,y:0};try{b.x=a.touches[0].screenX,b.y=a.touches[0].screenY}catch(c){console.log(c.toString())}return b},gEcnu.Util.getShpBox=function(a){var b=a.length;if(b>=1){var c=[],d=a[0].x,e=a[0].y,f=a[0].x,g=a[0].y;if(b>=2)for(var h=1;b>h;h++){var i=a[h];d>=i.x&&(d=i.x),f<=i.x&&(f=i.x),e>=i.y&&(e=i.y),g<=i.y&&(g=i.y)}return c=[d,e,f,g]}return void alert("获取最小外接矩形失败！")},gEcnu.Util.getType=function(a){var b;return("object"==(b=typeof a)?null==a&&"null"||Object.prototype.toString.call(a).slice(8,-1):b).toLowerCase()},gEcnu.Util.extend=function(a,b){for(var c in b)"array"==gEcnu.Util.getType(b[c])||"object"==gEcnu.Util.getType(b[c])?(a[c]="array"==gEcnu.Util.getType(b[c])?[]:{},arguments.callee(a[c],b[c])):a[c]=b[c]},gEcnu.Util.getTouchPt=function(a){var b=a.pageX-gSelf.mapLeft,c=a.pageY-gSelf.mapTop;return{x:b,y:c}},gEcnu.Util.getMousePos=function(a){var b=a||window.event;return{x:b.screenX,y:b.screenY}},gEcnu.Util.p1top2Dis=function(a,b){var c=parseInt(a.x-b.x),d=parseInt(a.y-b.y),e=parseInt(Math.sqrt(c*c+d*d));return e},gEcnu.Util.getEleStyle=function(a,b){var c=b.split("-"),d=c[0];if(d.length>1)for(var e=1;e<c.length;e++)d+=c[e].substring(0,1).toUpperCase()+c[e].substring(1);else d=b;return a.currentStyle?a.currentStyle[d]:document.defaultView.getComputedStyle(a,!1)[d]},gEcnu.Util.setOptions=function(a,b){var c=gEcnu.Util.cloneObj(a.options);for(var d in b)null==b[d]&&void 0==b[d]&&""==b[d]||(c[d]=b[d]);return c},gEcnu.Util.shToLngLat=function(a,b){var c=95418.0172735741,d=48.3052839794785,e=-11592069.1853624,f=63.9932503167748,g=110821.847990882,h=-3469087.15690168,i=(f*a-c*b-(e*f-c*h))/(d*f-c*g),j=(g*a-d*b-(e*g-d*h))/(c*g-d*f);return{lat:i,lng:j}},gEcnu.Util.lnglatToSh=function(a,b){var c=95418.0172735741,d=48.3052839794785,e=-11592069.1853624,f=63.9932503167748,g=110821.847990882,h=-3469087.15690168,i=c*a+d*b+e-50+470,j=f*a+g*b+h-50-235;return{x:i,y:j}},gEcnu.Util.delpx=function(a){return""==a?0:parseInt(a.substring(0,a.length-2))},gEcnu.Util.ajax=function(a,b,c,d,e,f,g,h){function i(a){}var j,l=arguments.length;7!=arguments.length&&8!=arguments.length||(j=setTimeout(function(){n?n.abort():m&&(alert(m),m.abort()),f()},g));var m=null,n=null;if(c instanceof Object){var o="";for(k in c)o+=k+"="+encodeURIComponent(c[k])+"&";c=o}window.XDomainRequest?(n=new XDomainRequest,n&&(n.onerror=i,n.onload=function(){j&&clearTimeout(j),8==arguments.length?e(n.responseText,h):e(n.responseText)},"get"==a.toLowerCase()?(null==c||""==c?n.open("get",b):n.open("get",b+"?"+c),n.send()):"post"==a.toLowerCase()&&(n.open("post",b),n.setRequestHeader("content-Type","application/x-www-form-urlencoded"),n.send(c)))):(window.XMLHttpRequest?m=new XMLHttpRequest:window.ActiveXObject&&(m=new ActiveXObject("Microsoft.XMLHTTP")),m.onreadystatechange=function(a){4==m.readyState&&(200==m.status?e&&(j&&clearTimeout(j),8==l?e(m.responseText,h):e(m.responseText)):404==m.status?hander404&&hander404():500==m.status&&hander500&&hander500())},"get"==a.toLowerCase()?(null==c||""==c?m.open("get",b,d):m.open("get",b+"?"+c,d),m.send(null)):"post"==a.toLowerCase()&&(m.open("post",b,d),m.setRequestHeader("content-Type","application/x-www-form-urlencoded"),m.send(c)))},gEcnu.Util.cloneObj=function(a){var b,c;if("object"==typeof a){if(b=a.constructor===Object?{}:[],window.JSON)c=JSON.stringify(a),b=JSON.parse(c);else if(b.constructor===Array)b.concat(a);else for(var d in a)b[d]=a[d];return b}},gEcnu.Util.drawLine=function(a,b,c,d,e){a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.closePath(),a.stroke()},gEcnu.Util.getPolylineLength=function(a){for(var b=a.length,c=0,d=0;b-1>d;d++){var e=Math.sqrt((a[d].x-a[d+1].x)*(a[d].x-a[d+1].x)+(a[d].y-a[d+1].y)*(a[d].y-a[d+1].y));c+=e}return c},gEcnu.Util.calcAreaMap=function(a){for(var b=0,c=a,d=0;d<c.length;d++)b+=c[d].x*c[(d+1)%c.length].y-c[(d+1)%c.length].x*c[d].y;var e=parseInt(Math.abs(.5*b));return e},gEcnu.Util.drawCalPolyline=function(a,b){gEcnu.Util.setStyle(a);b.length;a.beginPath();var c=gEcnu.Util.worldToScreen(b[0].x,b[0].y);"GEOGRAPHIC"==gSelf.coordsFlag&&(c=gEcnu.Util.worldToScreen_geo(b[0].x,b[0].y)),a.moveTo(c.x,c.y);for(var d=1;d<b.length;d++)c=gEcnu.Util.worldToScreen(b[d].x,b[d].y),"GEOGRAPHIC"==gSelf.coordsFlag&&(c=gEcnu.Util.worldToScreen_geo(b[d].x,b[d].y)),a.lineTo(c.x,c.y);a.stroke()},gEcnu.Util.setStyle=function(a,b){var c={fillColor:"blue",strokeColor:"blue",lineWeight:2,borderStatus:!0,fillStatus:!0,vtxStatus:!1,vtxRadius:3,tlr:5,opacity:1};return arguments.length>1&&(c=b),a.fillStyle=c.fillColor,a.strokeStyle=c.strokeColor,a.lineWidth=c.lineWeight,a.globalAlpha=c.opacity,c},gEcnu.Util.debounce=function(a,b,c,d){var e;return function(){function f(){c||a.apply(g,h),e=null}var g=this,h=arguments;e?clearTimeout(e):c&&a.apply(g,h),e=setTimeout(f,b||100),d()}},gEcnu.Util.addEvtHandler=function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,c):a["on"+b]=c,"mousewheel"==b&&0==gEcnu.Util.getIEVersion()&&a.addEventListener("DOMMouseScroll",c,!1)},gEcnu.Util.removeEvtHandler=function(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent?a.detachEvent("on"+b,c):a["on"+b]=c,"mousewheel"==b&&a.removeEventListener("DOMMouseScroll",c,!1)},gEcnu.Util.preventDefault=function(a){a.preventDefault?a.preventDefault():window.event.returnValue=!1},gEcnu.Util.stopPropagation=function(a){a.stopPropagation?a.stopPropagation():window.event.cancelBubble=!0},gEcnu.Util.bindCusEvt=function(a,b,c){var d=document.createEvent("Event");d.initEvent(b,!1,!1),gSelf.cusEvtArr[b]=d,a.addEventListener(b,c,!1)},gEcnu.Util.triggerCusEvt=function(a,b){a.dispatchEvent(gSelf.cusEvtArr[b])},gEcnu.Util.ifctrl=function(a){var b=!!window.Event;return b?!!("undefined"!=typeof a.ctrlKey?a.ctrlKey:a.modifiers&Event.CONTROL_MASK>0):!!window.event.ctrlKey},gEcnu.Util.ifshift=function(a){var b=!!window.Event;return b?!!("undefined"!=typeof a.shiftKey?a.shiftKey:a.modifiers&Event.SHIFT_MASK>0):!!window.event.shiftKey},gEcnu.Util.getIEVersion=function(){var a=window.navigator.userAgent.toLowerCase();return/msie 8\.0/i.test(a)?8:/msie 7\.0/i.test(a)?7:/msie 6\.0/i.test(a)?6:0},Array.indexOf||(Array.prototype.indexOf=function(a){for(var b=0;b<this.length;b++)if(this[b]==a)return b;return-1}),gEcnu.Util.getButton=function(a){if(a=a||window.event,+[1])return a.button;switch(a.button){case 0:case 1:case 3:case 5:case 7:return 0;case 2:case 6:return 2;case 4:return 1}},gEcnu.Util.bindFunction=function(a,b){return function(){b.apply(a,arguments),console.log("util",arguments)}};var gEcnu_reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;gEcnu.Util.colorRgb=function(a,b){var c=a.toLowerCase();if(c&&gEcnu_reg.test(c)){if(4===c.length){for(var d="#",e=1;4>e;e+=1)d+=c.slice(e,e+1).concat(c.slice(e,e+1));c=d}for(var f=[],e=1;7>e;e+=2)f.push(parseInt("0x"+c.slice(e,e+2)));return"RGBA("+f.join(",")+","+b+")"}return c},gEcnu.Util.colorHex=function(a){console.log(a,a.length);var b=a.replace(/\s/g,"");if(console.log("that",b),/^(rgb|RGB)/.test(b)){var c=b.replace(/(?:\(|\)|rgba|rgb|RGB)*/gi,"").split(",");console.log("aColor",c);for(var d="#",e=c.length>3?3:c.length,f=0;e>f;f++){var g=parseInt(c[f]).toString(16);console.log("hex",g),0==g&&(console.log(0),g+=g),d+=g}return console.log("strHex",d),7!==d.length&&(d=b),d}if(!gEcnu_reg.test(b))return b;var h=b.replace(/#/,"").split("");if(6===h.length)return b;if(3===h.length){for(var i="#",f=0;f<h.length;f+=1)i+=h[f]+h[f];return i}},gEcnu.Util.resizeDivByContent=function(a,b,c){var d=parseInt(c/a),e=b.length,f=parseInt(e/d)+1,g=a*f+3*f;if(1==f)var h=e*a;else var h=c;return{w:h,h:g}},gEcnu.Util.decode=function(a){var b=a.scale;if(!a.UTF8Encoding)for(var c=a.features,d=0;d<c.length;d++){var e=c[d],f=e.geometry.coordinates,g=e.geometry.encodeOffsets[0],h=(e.properties.cp,e.geometry.Parts||[0]);e.geometry.coordinates=gEcnu.Util.decodePolygon(h,f,g,b)}return a},gEcnu.Util.decodePolygon=function(a,b,c,d){for(var e=[],f=parseFloat(c[0]),g=parseFloat(c[1]),h=a.length,i=[],j=0;h>j;j++){var k=[],l=a[j];if(j==h-1)var m=b.length/2;else var m=a[j+1];for(var n=2*l;2*m>n;n+=2){var o=parseFloat(b[n]),p=parseFloat(b[n+1]);if(0==n){var q=parseFloat(f/d),r=parseFloat(g/d),s=[Number(q.toFixed(4)),Number(r.toFixed(4))];k.push(s),i=s}else{var t=i,q=parseFloat(t[0])+parseFloat(o/d),r=parseFloat(t[1])+parseFloat(p/d),s=[Number(q.toFixed(4)),Number(r.toFixed(4))];i=s,k.push(s)}}e.push(k)}return e},gEcnu.Util.getMapParamByScale=function(a,b,c){var d=a.getSize(),e=a.getCenter(),f=e.x,g=e.y,h=d.w,i=d.h,j=a.getZoom().z,k=j/h*i;k>14e4&&(k=14e4),j=k*c;var l=b/100,m=j/l,n=parseInt(m/2.54*96),o=parseInt(n*c);return{w:o,h:n,zoom:j,cx:f,cy:g}},gEcnu.Util.getTimeInfo=function(){var a=new Date,b=a.getFullYear(),c=a.getMonth()+1,d=a.getDate();return{year:b,month:c,day:d}},gEcnu.Util.webColor2dbColor=function(a){var b=a.substring(1),c=b.substr(0,2),d=b.substr(2,2),e=b.substr(4,2);return newColor="$00"+e+d+c,newColor},gEcnu.Util.dbColor2webColor=function(a){var b="";if(0==a.indexOf("$")){var c=a.substring(3),d=c.substr(0,2),e=c.substr(2,2),f=c.substr(4,2);b="#"+f+e+d}else 0==a.indexOf("cl")&&(b=a.substring(2).toLowerCase(),b=gEcnu.Util.corlorName2Hex(b));return b},gEcnu.Util.corlorName2Hex=function(a){for(var b="",c=[["aliceblue","#f0f8ff","rgb(240,248,255)","rgb(94.1%,96.9%,100%)"],["antiquewhite","#faebd7","rgb(250,235,215)","rgb(98%,92.2%,84.3%)"],["aqua","#00ffff","rgb(0,255,255)","rgb(0%,100%,100%)"],["aquamarine","#7fffd4","rgb(127,255,212)","rgb(49.8%,100%,83.1%)"],["azure","#f0ffff","rgb(240,255,255)","rgb(94.1%,100%,100%)"],["beige","#f5f5dc","rgb(245,245,220)","rgb(96.1%,96.1%,86.3%)"],["bisque","#ffe4c4","rgb(255,228,196)","rgb(100%,89.4%,76.9%)"],["black","#000000","rgb(0,0,0)","rgb(0%,0%,0%)"],["blanchedalmond","#ffebcd","rgb(255,235,205)","rgb(100%,92.2%,80.4%)"],["blue","#0000ff","rgb(0,0,255)","rgb(0%,0%,100%)"],["blueviolet","#8a2be2","rgb(138,43,226)","rgb(54.1%,16.9%,88.6%)"],["brown","#a52a2a","rgb(165,42,42)","rgb(64.7%,16.5%,16.5%)"],["burlywood","#deb887","rgb(222,184,135)","rgb(87.1%,72.2%,52.9%)"],["cadetblue","#5f9ea0","rgb(95,158,160)","rgb(37.3%,62%,62.7%)"],["chartreuse","#7fff00","rgb(127,255,0)","rgb(49.8%,100%,0%)"],["chocolate","#d2691e","rgb(210,105,30)","rgb(82.4%,41.1%,11.8%)"],["coral","#ff7f50","rgb(255,127,80)","rgb(100%,49.8%,31.4%)"],["cornflowerblue","#6495ed","rgb(100,149,237)","rgb(39.2%,58.4%,92.9%)"],["cornsilk","#fff8dc","rgb(255,248,220)","rgb(100%,97.3%,86.3%)"],["crimson","#dc143c","rgb(220,20,60)","rgb(86.3%,7.8%,23.5%)"],["cyan","#00ffff","rgb(0,255,255)","rgb(0%,100%,100%)"],["darkblue","#00008b","rgb(0,0,139)","rgb(0%,0%,54.5%)"],["darkcyan","#008b8b","rgb(0,139,139)","rgb(0%,54.5%,54.5%)"],["darkgoldenrod","#b8860b","rgb(184,134,11)","rgb(72.2%,52.5%,4.3%)"],["darkgray","#a9a9a9","rgb(169,169,169)","rgb(66.3%,66.3%,66.3%)"],["darkgreen","#006400","rgb(0,100,0)","rgb(0%,39.2%,0%)"],["darkgrey","#a9a9a9","rgb(169,169,169)","rgb(66.3%,66.3%,66.3%)"],["darkkhaki","#bdb76b","rgb(189,183,107)","rgb(74.1%,71.8%,42%)"],["darkmagenta","#8b008b","rgb(139,0,139)","rgb(54.5%,0%,54.5%)"],["darkolivegreen","#556b2f","rgb(85,107,47)","rgb(33.3%,42%,18.4%)"],["darkorange","#ff8c00","rgb(255,140,0)","rgb(100%,54.9%,0%)"],["darkorchid","#9932cc","rgb(153,50,204)","rgb(60%,19.6%,80%)"],["darkred","#8b0000","rgb(139,0,0)","rgb(54.5%,0%,0%)"],["darksalmon","#e9967a","rgb(233,150,122)","rgb(91.4%,58.8%,47.8%)"],["darkseagreen","#8fbc8f","rgb(143,188,143)","rgb(56.1%,73.7%,56.1%)"],["darkslateblue","#483d8b","rgb(72,61,139)","rgb(28.2%,23.9%,54.5%)"],["darkslategray","#2f4f4f","rgb(47,79,79)","rgb(18.4%,31%,31%)"],["darkslategrey","#2f4f4f","rgb(47,79,79)","rgb(18.4%,31%,31%)"],["darkturquoise","#00ced1","rgb(0,206,209)","rgb(0%,80.8%,82%)"],["darkviolet","#9400d3","rgb(148,0,211)","rgb(58%,0%,82.7%)"],["deeppink","#ff1493","rgb(255,20,147)","rgb(100%,7.8%,57.6%)"],["deepskyblue","#00bfff","rgb(0,191,255)","rgb(0%,74.9%,100%)"],["dimgray","#696969","rgb(105,105,105)","rgb(41.1%,41.1%,41.1%)"],["dimgrey","#696969","rgb(105,105,105)","rgb(41.1%,41.1%,41.1%)"],["dodgerblue","#1e90ff","rgb(30,144,255)","rgb(11.8%,56.5%,100%)"],["firebrick","#b22222","rgb(178,34,34)","rgb(69.8%,13.3%,13.3%)"],["floralwhite","#fffaf0","rgb(255,250,240)","rgb(100%,98%,94.1%)"],["forestgreen","#228b22","rgb(34,139,34)","rgb(13.3%,54.5%,13.3%)"],["fuchsia","#ff00ff","rgb(255,0,255)","rgb(100%,0%,100%)"],["gainsboro","#dcdcdc","rgb(220,220,220)","rgb(86.3%,86.3%,86.3%)"],["ghostwhite","#f8f8ff","rgb(248,248,255)","rgb(97.3%,97.3%,100%)"],["gold","#ffd700","rgb(255,215,0)","rgb(100%,84.3%,0%)"],["goldenrod","#daa520","rgb(218,165,32)","rgb(85.5%,64.7%,12.5%)"],["gray","#808080","rgb(128,128,128)","rgb(50.2%,50.2%,50.2%)"],["green","#008000","rgb(0,128,0)","rgb(0%,50.2%,0%)"],["greenyellow","#adff2f","rgb(173,255,47)","rgb(67.8%,100%,18.4%)"],["grey","#808080","rgb(128,128,128)","rgb(50.2%,50.2%,50.2%)"],["honeydew","#f0fff0","rgb(240,255,240)","rgb(94.1%,100%,94.1%)"],["hotpink","#ff69b4","rgb(255,105,180)","rgb(100%,41.1%,70.6%)"],["indianred","#cd5c5c","rgb(205,92,92)","rgb(80.4%,36%,36%)"],["indigo","#4b0082","rgb(75,0,130)","rgb(29.4%,0%,51%)"],["ivory","#fffff0","rgb(255,255,240)","rgb(100%,100%,94.1%)"],["khaki","#f0e68c","rgb(240,230,140)","rgb(94.1%,90.2%,54.9%)"],["lavender","#e6e6fa","rgb(230,230,250)","rgb(90.2%,90.2%,98%)"],["lavenderblush","#fff0f5","rgb(255,240,245)","rgb(100%,94.1%,96.1%)"],["lawngreen","#7cfc00","rgb(124,252,0)","rgb(48.6%,98.8%,0%)"],["lemonchiffon","#fffacd","rgb(255,250,205)","rgb(100%,98%,80.4%)"],["lightblue","#add8e6","rgb(173,216,230)","rgb(67.8%,84.7%,90.2%)"],["lightcoral","#f08080","rgb(240,128,128)","rgb(94.1%,50.2%,50.2%)"],["lightcyan","#e0ffff","rgb(224,255,255)","rgb(87.8%,100%,100%)"],["lightgoldenrodyellow","#fafad2","rgb(250,250,210)","rgb(98%,98%,82.4%)"],["lightgray","#d3d3d3","rgb(211,211,211)","rgb(82.7%,82.7%,82.7%)"],["lightgreen","#90ee90","rgb(144,238,144)","rgb(56.5%,93.3%,56.5%)"],["lightgrey","#d3d3d3","rgb(211,211,211)","rgb(82.7%,82.7%,82.7%)"],["lightpink","#ffb6c1","rgb(255,182,193)","rgb(100%,71.4%,75.7%)"],["lightsalmon","#ffa07a","rgb(255,160,122)","rgb(100%,62.7%,47.8%)"],["lightseagreen","#20b2aa","rgb(32,178,170)","rgb(12.5%,69.8%,66.7%)"],["lightskyblue","#87cefa","rgb(135,206,250)","rgb(52.9%,80.8%,98%)"],["lightslategray","#778899","rgb(119,136,153)","rgb(46.7%,53.3%,60%)"],["lightslategrey","#778899","rgb(119,136,153)","rgb(46.7%,53.3%,60%)"],["lightsteelblue","#b0c4de","rgb(176,196,222)","rgb(69%,76.9%,87.1%)"],["lightyellow","#ffffe0","rgb(255,255,224)","rgb(100%,100%,87.8%)"],["lime","#00ff00","rgb(0,255,0)","rgb(0%,100%,0%)"],["limegreen","#32cd32","rgb(50,205,50)","rgb(19.6%,80.4%,19.6%)"],["linen","#faf0e6","rgb(250,240,230)","rgb(98%,94.1%,90.2%)"],["magenta","#ff00ff","rgb(255,0,255)","rgb(100%,0%,100%)"],["maroon","#800000","rgb(128,0,0)","rgb(50.2%,0%,0%)"],["mediumaquamarine","#66cdaa","rgb(102,205,170)","rgb(40%,80.4%,66.7%)"],["mediumblue","#0000cd","rgb(0,0,205)","rgb(0%,0%,80.4%)"],["mediumorchid","#ba55d3","rgb(186,85,211)","rgb(72.9%,33.3%,82.7%)"],["mediumpurple","#9370db","rgb(147,112,219)","rgb(57.6%,43.9%,85.9%)"],["mediumseagreen","#3cb371","rgb(60,179,113)","rgb(23.5%,70.2%,44.3%)"],["mediumslateblue","#7b68ee","rgb(123,104,238)","rgb(48.2%,40.8%,93.3%)"],["mediumspringgreen","#00fa9a","rgb(0,250,154)","rgb(0%,98%,60.4%)"],["mediumturquoise","#48d1cc","rgb(72,209,204)","rgb(28.2%,82%,80%)"],["mediumvioletred","#c71585","rgb(199,21,133)","rgb(78%,8.2%,52.2%)"],["midnightblue","#191970","rgb(25,25,112)","rgb(9.8%,9.8%,43.9%)"],["mintcream","#f5fffa","rgb(245,255,250)","rgb(96.1%,100%,98%)"],["mistyrose","#ffe4e1","rgb(255,228,225)","rgb(100%,89.4%,88.2%)"],["moccasin","#ffe4b5","rgb(255,228,181)","rgb(100%,89.4%,71%)"],["navajowhite","#ffdead","rgb(255,222,173)","rgb(100%,87.1%,67.8%)"],["navy","#000080","rgb(0,0,128)","rgb(0%,0%,50.2%)"],["oldlace","#fdf5e6","rgb(253,245,230)","rgb(99.2%,96.1%,90.2%)"],["Olive","#808000","rgb(128,128,0)","rgb(50.2%,50.2%,0%)"],["olivedrab","#6b8e23","rgb(107,142,35)","rgb(42%,55.7%,13.7%)"],["orange","#ffa500","rgb(255,165,0)","rgb(100%,64.7%,0%)"],["orangered","#ff4500","rgb(255,69,0)","rgb(100%,27.1%,0%)"],["orchid","#da70d6","rgb(218,112,214)","rgb(85.5%,43.9%,83.9%)"],["palegoldenrod","#eee8aa","rgb(238,232,170)","rgb(93.3%,91%,66.7%)"],["palegreen","#98fb98","rgb(152,251,152)","rgb(59.6%,98.4%,59.6%)"],["paleturquoise","#afeeee","rgb(175,238,238)","rgb(68.6%,93.3%,93.3%)"],["palevioletred","#db7093","rgb(219,112,147)","rgb(85.9%,43.9%,57.6%)"],["papayawhip","#ffefd5","rgb(255,239,213)","rgb(100%,93.7%,83.5%)"],["peachpuff","#ffdab9","rgb(255,218,185)","rgb(100%,85.5%,72.5%)"],["peru","#cd853f","rgb(205,133,63)","rgb(80.4%,52.2%,24.7%)"],["pink","#ffc0cb","rgb(255,192,203)","rgb(100%,75.3%,79.6%)"],["plum","#dda0dd","rgb(221,160,221)","rgb(86.7%,62.7%,86.7%)"],["powderblue","#b0e0e6","rgb(176,224,230)","rgb(69%,87.8%,90.2%)"],["purple","#800080","rgb(128,0,128)","rgb(50.2%,0%,50.2%)"],["red","#ff0000","rgb(255,0,0)","rgb(100%,0%,0%)"],["rosybrown","#bc8f8f","rgb(188,143,143)","rgb(73.7%,56.1%,56.1%)"],["royalblue","#4169e1","rgb(65,105,225)","rgb(25.5%,41.1%,100%)"],["saddlebrown","#8b4513","rgb(139,69,19)","rgb(54.5%,27.1%,7.5%)"],["salmon","#fa8072","rgb(250,128,114)","rgb(98%,50.2%,44.7%)"],["sandybrown","#f4a460","rgb(244,164,96)","rgb(95.7%,64.3%,37.6%)"],["seagreen","#2e8b57","rgb(46,139,87)","rgb(18%,54.5%,34.1%)"],["seashell","#fff5ee","rgb(255,245,238)","rgb(100%,96.1%,93.3%)"],["sienna","#a0522d","rgb(160,82,45)","rgb(62.7%,32.2%,17.6%)"],["silver","#c0c0c0","rgb(192,192,192)","rgb(75.3%,75.3%,75.3%)"],["skyblue","#87ceeb","rgb(135,206,235)","rgb(52.9%,80.8%,92.2%)"],["slateblue","#6a5acd","rgb(106,90,205)","rgb(41.6%,35.3%,80.4%)"],["slategray","#708090","rgb(112,128,144)","rgb(43.9%,50.2%,56.5%)"],["slategrey","#708090","rgb(112,128,144)","rgb(43.9%,50.2%,56.5%)"],["snow","#fffafa","rgb(255,250,250)","rgb(100%,98%,98%)"],["springgreen","#00ff7f","rgb(0,255,127)","rgb(0%,100%,49.8%)"],["steelblue","#4682b4","rgb(70,130,180)","rgb(27.5%,51%,70.6%)"],["tan","#d2b48c","rgb(210,180,140)","rgb(82.4%,70.6%,54.9%)"],["teal","#008080","rgb(0,128,128)","rgb(0%,50.2%,50.2%)"],["thistle","#d8bfd8","rgb(216,191,216)","rgb(84.7%,74.9%,84.7%)"],["tomato","#ff6347","rgb(255,99,71)","rgb(100%,38.8%%,27.8%)"],["turquoise","#40e0d0","rgb(64,224,208)","rgb(25.1%,87.7%,81.6%)"],["violet","#ee82ee","rgb(238,130,238)","rgb(93.3%,51%,93.3%)"],["wheat","#f5deb3","rgb(245,222,179)","rgb(96.1%,87.1%,70.2%)"],["white","#ffffff","rgb(255,255,255)","rgb(100%,100%,100%)"],["whitesmoke","#f5f5f5","rgb(245,245,245)","rgb(96.1%,96.1%,96.1%)"],["yellow","#ffff00","rgb(255,255,0)","rgb(100%,100%,0%)"],["yellowgreen","#9acd32","rgb(154,205,50)","rgb(60.4%,80.4%,19.6%)"]],d=0,e=c.length;e>d;d++)for(var f=c[d],g=0,h=f.length;h>g;g++)if(a==f[0])return b=f[1];return b},gEcnu.Util.insertAfter_cust=function(a,b){var c=b.parentNode;c.lastChild==b?c.appendChild(a):c.insertBefore(a,b.nextSibling)},gEcnu.Util.dragDiv=function(a,b){var c=document.getElementById(a),d=document.getElementById(b);d.style.cursor="move";var e=c.currentStyle?c.currentStyle.width:document.defaultView.getComputedStyle(c,null).width,f=c.currentStyle?c.currentStyle.height:document.defaultView.getComputedStyle(c,null).height,g=e.substring(0,e.length-2),h=f.substring(0,f.length-2);d.onmousedown=function(a){var b=a.clientX-c.offsetLeft,d=a.clientY-c.offsetTop;document.onmousemove=function(a){var e=a.clientX-b,f=a.clientY-d;0>e?e=0:e>document.body.clientWidth-g&&(e=document.body.clientWidth-g),0>f?f=0:f>document.body.clientHeight-h&&(f=document.body.clientHeight-h),c.style.left=e+"px",c.style.top=f+"px"},document.onmouseup=function(a){document.onmousemove=null,document.onmouseup=null}}},gEcnu.Util.Trim=function(a,b){var c;return c=a.replace(/(^\s+)|(\s+$)/g,""),b&&"g"==b.toLowerCase()&&(c=c.replace(/\s/g,"")),c},gEcnu.Util.isClockWise=function(a){for(var b=0,c=0,d=a.length;d-1>c;c++){var e=a[c],f=a[c+1],g=(e.y+f.y)*(f.x-e.x)/2;b+=g}return b>0},gEcnu.Util.getOuterPolyIndex=function(a){for(var b=0,c=0,d={},e=0,f=a.length;f>e;e++){var g=a[e].points,h=gEcnu.Util.getArea(g);d[e]=h,h>c&&(c=h)}for(var i in d)if(c==d[i])return b=i;return 0},gEcnu.Util.getArea=function(a){for(var b=0,c=a,d=0;d<c.length;d++)b+=c[d].x*c[(d+1)%c.length].y-c[(d+1)%c.length].x*c[d].y;var e=parseInt(Math.abs(.5*b));return e},gEcnu.Util.isPolyInPoly=function(a,b){for(var c=a.length,d=(b.length,0);c-1>d;d++){var e=a[d],f=a[d+1],g=[e,f],h=gEcnu.Util.pointInPoly(e,b),i=gEcnu.Util.pointInPoly(f,b);if(!h||!i)return!1;var j=gEcnu.Util.isLineInPoly(g,b);if(!j)return!1}return!0},gEcnu.Util.isLineInPoly=function(a,b){for(var c=[],d=a[0],e=a[1],f=0,g=b.length;g-1>f;f++){var h=b[f],i=b[f+1],j=[h,i],k=gEcnu.Util.isPtEqualLinept(d,j),l=gEcnu.Util.isPtEqualLinept(e,j),m=gEcnu.Util.isPtEqualLinept(h,a),n=gEcnu.Util.isPtEqualLinept(i,a);if(k||l)k&&c.push(k),l&&c.push(l);else if(m||n)m&&c.push(m),n&&c.push(n);else if(gEcnu.Util.isLineIntersect(a,j))return!1}if(c.length>0)for(var o=gEcnu.Util.sortObj(c),f=0,p=o.length;p-1>f;f++){var q=o[f],r=o[f+1],s=(q.x+r.x)/2,t=(q.y+r.y)/2,u={x:s,y:t};if(!gEcnu.Util.pointInPoly(u,b))return!1}return!0},gEcnu.Util.sortObj=function(a){return a.sort(gEcnu.Util.compareFun),a},gEcnu.Util.compareFun=function(a,b){return a.x-b.x},gEcnu.Util.isPtEqualLinept=function(a,b){var c=b[0],d=b[1];return a.x==c.x&&a.y==c.y?c:a.x==d.x&&a.y==d.y?d:null},gEcnu.Util.isLineIntersect=function(a,b){var c=a[0],d=a[1],e=b[0],f=b[1],g=(d.x-c.x)*(f.y-e.y)-(d.y-c.y)*(f.x-e.x);(c.y-e.y)*(f.x-e.x)-(c.x-e.x)*(f.y-e.x);if(0==g)return!1;var h=((c.y-e.y)*(f.x-e.x)-(c.x-e.x)*(f.y-e.y))/g,i=((c.y-e.y)*(d.x-c.x)-(c.x-e.x)*(d.y-c.y))/g;return h>0&&1>h&&i>0&&1>i},gEcnu.Util.isPtOnLine=function(a,b){var c=b[0],d=b[1],e=Math.min(c.x,d.x),f=Math.max(c.x,d.x),g=Math.min(c.y,d.y),h=Math.max(c.y,d.y);if(c.x==d.x){if(a.x==c.x&&a.y>=g&&a.y<=h)return!0}else{if(c.y!=d.y){var i=(d.y-c.y)/(d.x-c.x),j=i*(a.x-c.x)+c.y;return j==a.y&&j>=g&&h>=j}if(a.y==c.y&&a.x>=e&&a.x<=f)return!0}},gEcnu.Util.pointInPoly=function(a,b){for(var c=!1,d=-1,e=b.length,f=e-1;++d<e;f=d)(b[d].y<=a.y&&a.y<b[f].y||b[f].y<=a.y&&a.y<b[d].y)&&a.x<(b[f].x-b[d].x)*(a.y-b[d].y)/(b[f].y-b[d].y)+b[d].x&&(c=!c);return c};var eagleEye_self=null;gEcnu.Control=gClass.extend({init:function(a,b){this.id=a,this.options={top:15,left:15,zIndex:500}},setPos:function(){this._container.style.left=this.options.left+"px",this._container.style.top=this.options.top+"px",this._container.style.zIndex=this.options.zIndex},renew:function(){}}),gEcnu.Control.Zoom=gEcnu.Control.extend({init:function(a,b){this._super(a,b),this.options=gEcnu.Util.setOptions(this,b),this.posOption=b||{right:"15",bottom:"10"}},_initContainer:function(){var a=35,b=70,c=gEcnu.Util.createDiv("zoomCtrl",a,b,!0);c.style.boxShadow="3px 3px 6px rgba(0,0,0,0.9)";var d=gEcnu.Util.createDiv("zoomInDiv",a,b/2,!1),e=new Image;e.src=gEcnu.config.imgPath+"zoomin.png",e.style.width=a,e.style.height=b/2,d.appendChild(e);var f=gEcnu.Util.createDiv("zoomOutDiv",a,b/2,!1),g=new Image;g.style.width=a,g.style.height=b/2,g.src=gEcnu.config.imgPath+"zoomout.png",e.onmouseup=function(a){gEcnu.Util.stopPropagation(a),gSelf.zoomIn()},g.onmouseup=function(a){gEcnu.Util.stopPropagation(a),
gSelf.zoomOut()},f.appendChild(g),c.appendChild(d),c.appendChild(f),this._container=c},onAdd:function(a){var b=a.getContainer();this._initContainer(),this.setPos(),b.appendChild(this._container)},setPos:function(){var a=this.posOption;a?(void 0!=typeof a.right&&(this._container.style.right=a.right+"px"),void 0!=a.bottom&&(this._container.style.bottom=a.bottom+"px"),void 0!=a.left&&(this._container.style.left=a.left+"px"),void 0!=a.top&&(this._container.style.top=a.top+"px")):(this._container.style.right="15px",this._container.style.bottom="10px"),this._container.style.zIndex=this.options.zIndex}}),gEcnu.Control.Scale=gEcnu.Control.extend({init:function(a,b){this._super(a,b),this.options={zIndex:15,fontColor:"#000"},this.oClass="scaleControl",this.options=gEcnu.Util.setOptions(this,b)},setScalePos:function(a){this.posOption=a},onAdd:function(a){this.scaleLeft=20,this.scaleTop=7,this._initContainer(a),this.setPos(),a.getContainer().appendChild(this._container)},setPos:function(){var a=this.posOption;a?(void 0!=a.right&&(this._container.style.right=a.right+"px"),void 0!=a.bottom&&(this._container.style.bottom=a.bottom+"px"),void 0!=a.left&&(this._container.style.left=a.left+"px"),void 0!=a.top&&(this._container.style.top=a.top+"px")):(this._container.style.right="15px",this._container.style.bottom="10px"),this._container.style.zIndex=this.options.zIndex},_initContainer:function(a){this._map=a;var b=a.getSize(),c=180,d=30,e=gEcnu.Util.createCanvas("scaleCtrl",c,d,!0);e.style.backgroundColor="rgba(224,224,224,0.75)";var f=e.getContext("2d");this._container=e,this._ctx=f,this._showScale(b)},_showScale:function(a){var b=a.h,c=this._ctx,d=this._showScaleText(c,b),e=d.allpx,f=d.halfpx,g=this.scaleLeft,h=this.scaleTop;c.beginPath(),c.strokeStyle=this.options.fontColor,c.fillStyle=this.options.fontColor,c.linewidth=1,c.moveTo(g,h),c.lineTo(g,h+3),c.lineTo(e+g,h+3),c.lineTo(e+g,h),c.closePath(),c.fill(),c.beginPath(),c.moveTo(g+1,h+3),c.lineTo(g+1,h+6),c.closePath(),c.stroke(),c.beginPath(),c.moveTo(e+g-1,h+3),c.lineTo(e+g-1,h+6),c.closePath(),c.stroke(),c.beginPath(),c.moveTo(f+g-1,h+3),c.lineTo(f+g-1,h+6),c.closePath(),c.stroke()},_showScaleText:function(a,b){var c;if("GEOGRAPHIC"==gSelf.coordsFlag){var d=111.31955*gSelf.zoom*1e3;c=d/parseInt(gSelf.w)}else c=gSelf.zoom/parseInt(gSelf.w);var e=this._getScaleWidth(c),f=e.halfmeter,g=e.allmeter,h=e.allpx,i=e.halfpx,j=this.scaleLeft,k=this.scaleTop;return a.clearRect(0,0,200,b),a.font="14px serif",a.fillStyle=this.options.fontColor,a.fillText("0",j,k+20),a.fillText(f,j+i-5,k+20),a.fillText(g,j+h,k+20),e},_getScaleWidth:function(a){var b={};return 16>=a?(b.halfpx=50,b.allpx=100,b.halfmeter=Math.round(50*a)+"m",b.allmeter=2*Math.round(50*a)+"m"):(b.halfpx=50,b.allpx=100,b.halfmeter=Math.round(50*a/1e3)+"km",b.allmeter=2*Math.round(50*a/1e3)+"km"),b},clear:function(){var a=this._container;this._ctx.clearRect(0,0,a.width,a.height)},renew:function(){this.clear(),this._showScale(this._map)}}),gEcnu.Control.Scale_bak=gEcnu.Control.extend({init:function(a,b){this._super(a,b),this.options={top:0,left:0,zIndex:15,fontColor:"#000"},this.oClass="scaleControl",this.options=gEcnu.Util.setOptions(this,b)},onAdd:function(a){this.scaleLeft=this.scaleLeft||26,this.scaleTop=this.scaleTop||a.getSize().h-33,this._initContainer(a),this.setPos(),a.getContainer().appendChild(this._container)},_initContainer:function(a){this._map=a;var b=a.getSize(),c=gEcnu.Util.createCanvas("scaleCtrl",b.w,b.h,!0),d=c.getContext("2d");this._container=c,this._ctx=d,this._showScale(b)},setScalePos:function(a,b){var b=b||{},c=a.getSize(),d=b.left?b.left:b.right?c.w-b.right:26,e=b.top?b.top:b.bottom?c.h-b.bottom:c.h-33;this.scaleLeft=d,this.scaleTop=e},_showScale:function(a){var b=a.h,c=this._ctx,d=this._showScaleText(c,b),e=d.allpx,f=d.halfpx,g=this.scaleLeft,h=this.scaleTop;c.beginPath(),c.strokeStyle=this.options.fontColor,c.fillStyle=this.options.fontColor,c.linewidth=1,c.moveTo(g,h),c.lineTo(g,h+3),c.lineTo(e+g,h+3),c.lineTo(e+g,h),c.closePath(),c.fill(),c.beginPath(),c.moveTo(g+1,h+3),c.lineTo(g+1,h+6),c.closePath(),c.stroke(),c.beginPath(),c.moveTo(e+g-1,h+3),c.lineTo(e+g-1,h+6),c.closePath(),c.stroke(),c.beginPath(),c.moveTo(f+g-1,h+3),c.lineTo(f+g-1,h+6),c.closePath(),c.stroke()},_showScaleText:function(a,b){var c;if("GEOGRAPHIC"==gSelf.coordsFlag){var d=111.31955*gSelf.zoom*1e3;c=d/parseInt(gSelf.w)}else c=gSelf.zoom/parseInt(gSelf.w);var e=this._getScaleWidth(c),f=e.halfmeter,g=e.allmeter,h=e.allpx,i=e.halfpx,j=this.scaleLeft,k=this.scaleTop;return a.clearRect(0,0,200,b),a.font="14px serif",a.fillStyle=this.options.fontColor,a.fillText("0",j,k+20),a.fillText(f,j+i-5,k+20),a.fillText(g,j+h,k+20),e},_getScaleWidth:function(a){var b={};return 16>=a?(b.halfpx=50,b.allpx=100,b.halfmeter=Math.round(50*a)+"m",b.allmeter=2*Math.round(50*a)+"m"):(b.halfpx=50,b.allpx=100,b.halfmeter=Math.round(50*a/1e3)+"km",b.allmeter=2*Math.round(50*a/1e3)+"km"),b},clear:function(){var a=this._container;this._ctx.clearRect(0,0,a.width,a.height)},renew:function(){this.clear(),this._showScale(this._map)}}),gEcnu.Control.EagleEye=gEcnu.Control.extend({init:function(a,b,c){eagleEye_self=this,this.id=a,this.mapSource=b,this.options={top:0,left:0,zIndex:500},this.oClass="eagleMapControl",this.options=gEcnu.Util.setOptions(this,c)},_initContainer:function(){var a=document.getElementById(this.id),b=gEcnu.Util.delpx(gEcnu.Util.getEleStyle(a,"width")),c=gEcnu.Util.delpx(gEcnu.Util.getEleStyle(a,"height")),d=gEcnu.Util.createDiv("eagle_tMap",b,c,!0),e=gEcnu.Util.createDiv("eagle_dynlyr",b,c,!0),f=gEcnu.Util.createCanvas("canvas_grid",b,c,!0);f.style.zIndex=10,a.appendChild(d),a.appendChild(e),a.appendChild(f),this._container=a,this._tianContainer=d,this._dynContainer=e,this._posCanvas=f,this._eagleWidth=b,this._eagleHeight=c},setPos:function(){},onAdd:function(a){this._map=a,this._initContainer(),this._initProp(a),this.reqEagle()},_initProp:function(a){var b=a.getZoom(),c=a.getCenter();this._mapzoom=b.z,this.eagleZoom=2*b.z,this.eCenterX=c.x,this.eCenterY=c.y,this.eagleBasemap=null},eagleMapChange:function(a,b,c){this.eagleZoom=a,this.eCenterX=b,this.eCenterY=c,this.reqEagle()},reqEagle:function(){this._reqMap(),this._showPosinEagle()},_reqMap:function(){null!=this.eagleBasemap?this._renewBasemap():this._firstReqmap()},_renewBasemap:function(){var a=this._eagleWidth,b=this.eCenterX,c=this.eCenterY,d=this.eagleZoom,e=d/a,f=parseInt(Math.log(e)/Math.log(2))+1;console.log("other zl",18-f);var g=gEcnu.Util.shToLngLat(b,c);switch(this.mapSource){case"GOOGLE":this.eagleBasemap.setCenter(new google.maps.LatLng(g.lat,g.lng)),this.eagleBasemap.setZoom(18-f);break;case"BAIDU":this.eagleBasemap.centerAndZoom(new BMap.Point(g.lng,g.lat),19-f);break;case"TMAP":var g=gEcnu.Util.shToLngLat(b-400,c+230);this.eagleBasemap.centerAndZoom(new TLngLat(g.lng,g.lat),18-f)}},_firstReqmap:function(){var a=this,b=document.createElement("script");switch(this.mapSource){case"GOOGLE":b.src="https://maps.googleapis.com/maps/api/js?sensor=false&callback=showOtherMap_eagle",document.getElementsByTagName("head")[0].appendChild(b);break;case"BAIDU":b.src="http://api.map.baidu.com/api?v=1.4&callback=showOtherMap_eagle",document.getElementsByTagName("head")[0].appendChild(b);break;case"TMAP":var c="http://api.tianditu.com/js/maps.js";a._isLoadScript(c)?showOtherMap_eagle():(b.src=c,b.onload=showOtherMap_eagle,document.getElementsByTagName("head")[0].appendChild(b));break;case"NONE":}},_isLoadScript:function(a){var b=document.getElementsByTagName("head")[0].getElementsByTagName("script");if(void 0==b)return!1;for(var c=0,d=b.length;d>c;c++)if(b[c].src==a)return!0;return!1},_reqDyn:function(){var a=this._dynContainer,b=document.getElementById("eagleImg");void 0==b&&(b=new Image,b.id="eagleImg",a.appendChild(b));this.eCenterX,this.eCenterY,this._eagleWidth,this._eagleHeight,this.eagleZoom},_showPosinEagle:function(){var a=this._map,b=a.getCenter(),c=(this._eagleWidth,this._eagleHeight,this.eCenterX,this.eCenterY,this.eagleZoom,a.getBounds()),d=c.nw.x,e=c.nw.y,f=c.se.x,g=c.se.y,h=this._worldToScr_eagle(b.x,b.y),i=this._worldToScr_eagle(d,e),j=this._worldToScr_eagle(f,g),k=(h.x,h.y,j.x-i.x),l=j.y-i.y;this._drawPosCanvas(i.x,i.y,k,l)},isInEagleEyemap:function(){var a=this._map.getBounds(),b=a.nw.x,c=a.nw.y,d=a.se.x,e=a.se.y,f=this._worldToScr_eagle(b,c),g=this._worldToScr_eagle(d,e),h=f.x,i=f.y,j=g.x,k=g.y,l=this._eagleWidth,m=this._eagleHeight;return!(0>h||0>i||j>l||k>m)},_drawPosCanvas:function(a,b,c,d){var e=this._posCanvas,f=e.getContext("2d");f.clearRect(0,0,this._eagleWidth,this._eagleHeight),f.strokeStyle="red",f.lineWidth=1,f.strokeRect(a,b,c,d)},_worldToScr_eagle:function(a,b){var c=this._eagleWidth,d=this._eagleHeight,e=this.eCenterX,f=this.eCenterY,g=this.eagleZoom,h=g/c,i=c/2+(a-e)/h,j=d/2-(b-f)/h;return{x:i,y:j}},renew:function(){var a=this._map.getZoom(),b=a.z,c=this._mapzoom;b==c&&this.isInEagleEyemap()?this._showPosinEagle():(this._initProp(this._map),this.reqEagle())}}),gEcnu.Marker=gClass.extend({init:function(a,b,c){this.name=a,this._img=new Image,this._img.src=b.src,this.src=b.src,this._img.style.position="absolute",this._img.style.zIndex=100,this.info=b},onAdd:function(a){this._layer=a;var b=(a.getMap(),this._container=a.getLayerContainer());this.x=this.info.x,this.y=this.info.y;var c=gEcnu.Util.worldToScreen(this.info.x,this.info.y);this._img.style.left=c.x+this.info.offset.x+"px",this._img.style.top=c.y+this.info.offset.y+"px",this._img.style.cursor="pointer",b.appendChild(this._img)},onRemove:function(){this._container.removeChild(this._img)},getContainer:function(){return this._img},regEvent:function(a,b){if("click"==a){var c=this;gEcnu.Util.addEvtHandler(this.getContainer(),"mousedown",function(a){gEcnu.Util.preventDefault(a),gEcnu.Util.stopPropagation(a),0==gEcnu.Util.getButton(a)&&b.apply(c,arguments)}),this._img.onmouseup=function(a){gEcnu.Util.preventDefault(a),gEcnu.Util.stopPropagation(a)},this._img.onclick=function(a){gEcnu.Util.preventDefault(a),gEcnu.Util.stopPropagation(a)}}else if("Rclick"==a){var c=this;gEcnu.Util.addEvtHandler(this.getContainer(),"mousedown",function(a){gEcnu.Util.preventDefault(a),gEcnu.Util.stopPropagation(a),2==gEcnu.Util.getButton(a)&&b.apply(c,arguments)}),this._img.onmouseup=function(a){gEcnu.Util.preventDefault(a),gEcnu.Util.stopPropagation(a)},this._img.onclick=function(a){gEcnu.Util.preventDefault(a),gEcnu.Util.stopPropagation(a)}}},renew:function(){var a=(this._layer.getMap(),gEcnu.Util.worldToScreen(this.info.x,this.info.y));this._img.style.left=a.x+this.info.offset.x+"px",this._img.style.top=a.y+this.info.offset.y+"px"},showInfo:function(){console.log("Hello WebGIS")}}),gEcnu.Text=gClass.extend({init:function(a,b,c,d){this.id=a,this.startPoint=b.startPoint,this.boxMaxWidth=b.boxMaxWidth,this.text=b.text,this.fields=c,this.boxScrSize={xmin:0,ymin:0,xmax:0,ymax:0}},addFields:function(a){for(var b in a)this.fields[b]=a[b]},delFields:function(a){for(var b=a.length,c=0;b>c;c++){var d=a[c];delete this.fields[d]}},delAllFields:function(){this.fields={}},onAdd:function(a){var b=this.id;this._w=this.boxMaxWidth,this._h=50;var c=gEcnu.Util.createTextArea(b,this._w,this._h,!0);c.style.borderWidth=0,this._textContainer=c;var d=this._container=a.getLayerContainer();d.appendChild(this._textContainer),this._layer=a,this.onDraw(a)},onDraw:function(a){var b=a.style,c=gEcnu.Util.worldToScreen(this.startPoint.x,this.startPoint.y),d=a.resetStyle;("undefined"==typeof this.style||d)&&(this.style=b),this._textContainer.style.fontSize=this.style.fontSize+"px",this._textContainer.style.fontFamily=this.style.fontFamily+",SimSun",this._textContainer.style.color=this.style.fontColor,this._textContainer.style.borderRadius="3px",this._textContainer.style.padding="2px";var e=gEcnu.Util.resizeDivByContent(this.style.fontSize,this.text,this._w);this._textContainer.style.width=e.w+"px",this._textContainer.style.height=e.h+"px";var f=gEcnu.Util.colorRgb(this.style.bgColor,this.style.opacity-.1);this._textContainer.style.background=f,this._textContainer.textContent=this.text,this._textContainer.style.left=c.x+"px",this._textContainer.style.top=c.y+"px",this.boxScrSize={xmin:c.x,ymin:c.y,xmax:c.x+e.w,ymax:c.y+e.h},a._layerContainer.appendChild(this._textContainer)},setContent:function(a){this.text=a},setPosition:function(a,b){this.startPoint.x=a,this.startPoint.y=b},setSize:function(a){this._w=this.boxMaxWidth=a},onRemove:function(){this._container.removeChild(this._textContainer)},getContainer:function(){return this._textContainer},renew:function(){var a=this._layer;this.onDraw(a)},refresh:function(){this.renew()}}),function(a,b,c){"undefined"!=typeof module&&module.exports?module.exports=c():"function"==typeof define&&define.amd?define(c):b[a]=c()}("gHeatmap",this,function(){var a={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}},b=function(){var b=function(a){this._coordinator={},this._data=[],this._radi=[],this._min=0,this._max=1,this._xField=a.xField||a.defaultXField,this._yField=a.yField||a.defaultYField,this._valueField=a.valueField||a.defaultValueField,a.radius&&(this._cfgRadius=a.radius)},c=a.defaultRadius;return b.prototype={_organiseData:function(a,b){var d=a[this._xField],e=a[this._yField],f=this._radi,g=this._data,h=this._max,i=this._min,j=a[this._valueField]||1,k=a.radius||this._cfgRadius||c;return this.radius=k,g[d]||(g[d]=[],f[d]=[]),g[d][e]?g[d][e]+=j:(g[d][e]=j,f[d][e]=k),g[d][e]>h?(b?this.setDataMax(g[d][e]):this._max=g[d][e],!1):{x:d,y:e,value:j,radius:k,min:i,max:h}},_unOrganizeData:function(){var a=[],b=this._data,c=this._radi;for(var d in b)for(var e in b[d])a.push({x:d,y:e,radius:c[d][e],value:b[d][e]});return{min:this._min,max:this._max,data:a}},_onExtremaChange:function(){this._coordinator.emit("extremachange",{min:this._min,max:this._max})},addData:function(){if(arguments[0].length>0)for(var a=arguments[0],b=a.length;b--;)this.addData.call(this,a[b]);else{var c=this._organiseData(arguments[0],!0);c&&this._coordinator.emit("renderpartial",{min:this._min,max:this._max,data:[c]})}return this},setData:function(a){var b=a.data,c=b.length;this._data=[],this._radi=[];for(var d=0;c>d;d++)this._organiseData(b[d],!1);return this._max=a.max,this._min=a.min||0,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},removeData:function(){},setDataMax:function(a){return this._max=a,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setDataMin:function(a){return this._min=a,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setCoordinator:function(a){this._coordinator=a},_getInternalData:function(){return{max:this._max,min:this._min,data:this._data,radi:this._radi}},getData:function(){return this._unOrganizeData()}},b}(),c=function(){function a(a){var c=a.container,d=this.shadowCanvas=document.createElement("canvas"),e=this.canvas=a.canvas||document.createElement("canvas"),f=(this._renderBoundaries=[1e4,1e4,0,0],getComputedStyle(a.container)||{});e.className="heatmap-canvas",this._width=e.width=d.width=+f.width.replace(/px/,""),this._height=e.height=d.height=+f.height.replace(/px/,""),this.shadowCtx=d.getContext("2d"),this.ctx=e.getContext("2d"),e.style.cssText=d.style.cssText="position:absolute;left:0;top:0;",c.style.position="relative",c.appendChild(e),this._palette=b(a),this._templates={},this._setStyles(a)}var b=function(a){var b=a.gradient||a.defaultGradient,c=document.createElement("canvas"),d=c.getContext("2d");c.width=256,c.height=1;var e=d.createLinearGradient(0,0,256,1);for(var f in b)e.addColorStop(f,b[f]);return d.fillStyle=e,d.fillRect(0,0,256,1),d.getImageData(0,0,256,1).data},c=function(a,b){var c=document.createElement("canvas"),d=c.getContext("2d"),e=a,f=a;if(c.width=c.height=2*a,1==b)d.beginPath(),d.arc(e,f,a,0,2*Math.PI,!1),d.fillStyle="rgba(0,0,0,1)",d.fill();else{var g=d.createRadialGradient(e,f,a*b,e,f,a);g.addColorStop(0,"rgba(0,0,0,1)"),g.addColorStop(1,"rgba(0,0,0,0)"),d.fillStyle=g,d.fillRect(0,0,2*a,2*a)}return c},d=function(a){for(var b=[],c=a.min,d=a.max,e=a.radi,a=a.data,f=Object.keys(a),g=f.length;g--;)for(var h=f[g],i=Object.keys(a[h]),j=i.length;j--;){var k=i[j],l=a[h][k],m=e[h][k];b.push({x:h,y:k,value:l,radius:m})}return{min:c,max:d,data:b}};return a.prototype={renderPartial:function(a){this._drawAlpha(a),this._colorize()},renderAll:function(a){this._clear(),this._drawAlpha(d(a)),this._colorize()},_updateGradient:function(a){this._palette=b(a)},updateConfig:function(a){a.gradient&&this._updateGradient(a),this._setStyles(a)},setDimensions:function(a,b){this._width=a,this._height=b,this.canvas.width=this.shadowCanvas.width=a,this.canvas.height=this.shadowCanvas.height=b},_clear:function(){this.shadowCtx.clearRect(0,0,this._width,this._height),this.ctx.clearRect(0,0,this._width,this._height)},_setStyles:function(a){this._blur=0==a.blur?0:a.blur||a.defaultBlur,a.backgroundColor&&(this.canvas.style.backgroundColor=a.backgroundColor),this._opacity=255*(a.opacity||0),this._maxOpacity=255*(a.maxOpacity||a.defaultMaxOpacity),this._minOpacity=255*(a.minOpacity||a.defaultMinOpacity),this._useGradientOpacity=!!a.useGradientOpacity,this.canvas.style.zIndex=a.zIndex||10},_drawAlpha:function(a){for(var b=this._min=a.min,d=this._max=a.max,a=a.data||[],e=a.length,f=1-this._blur;e--;){var g,h=a[e],i=h.x,j=h.y,k=h.radius,l=Math.min(h.value,d),m=i-k,n=j-k,o=this.shadowCtx;this._templates[k]?g=this._templates[k]:this._templates[k]=g=c(k,f),o.globalAlpha=(l-b)/(d-b),o.drawImage(g,m,n),m<this._renderBoundaries[0]&&(this._renderBoundaries[0]=m),n<this._renderBoundaries[1]&&(this._renderBoundaries[1]=n),m+2*k>this._renderBoundaries[2]&&(this._renderBoundaries[2]=m+2*k),n+2*k>this._renderBoundaries[3]&&(this._renderBoundaries[3]=n+2*k)}},_colorize:function(){var a=this._renderBoundaries[0],b=this._renderBoundaries[1],c=this._renderBoundaries[2]-a,d=this._renderBoundaries[3]-b,e=this._width,f=this._height,g=this._opacity,h=this._maxOpacity,i=this._minOpacity,j=this._useGradientOpacity;0>a&&(a=0),0>b&&(b=0),a+c>e&&(c=e-a),b+d>f&&(d=f-b);for(var k=this.shadowCtx.getImageData(a,b,c,d),l=k.data,m=l.length,n=this._palette,o=3;m>o;o+=4){var p=l[o],q=4*p;if(q){var r;r=g>0?g:h>p?i>p?i:p:h,l[o-3]=n[q],l[o-2]=n[q+1],l[o-1]=n[q+2],l[o]=j?n[q+3]:r}}k.data=l,this.ctx.putImageData(k,a,b),this._renderBoundaries=[1e3,1e3,0,0]},getValueAt:function(a){var b,c=this.shadowCtx,d=c.getImageData(a.x,a.y,1,1),e=d.data[3],f=this._max,g=this._min;return b=Math.abs(f-g)*(e/255)>>0},getDataURL:function(){return this.canvas.toDataURL()}},a}(),d=function(){var b=!1;return"canvas2d"===a.defaultRenderer&&(b=c),b}(),e={merge:function(){for(var a={},b=arguments.length,c=0;b>c;c++){var d=arguments[c];for(var e in d)a[e]=d[e]}return a}},f=function(){function c(){var c=this._config=e.merge(a,arguments[0]||{});if(this._coordinator=new f,c.plugin){var h=c.plugin;if(!a.plugins[h])throw new Error("Plugin '"+h+"' not found. Maybe it was not registered.");var i=a.plugins[h];this._renderer=new i.renderer(c),this._store=new i.store(c)}else this._renderer=new d(c),this._store=new b(c);g(this)}var f=function(){function a(){this.cStore={}}return a.prototype={on:function(a,b,c){var d=this.cStore;d[a]||(d[a]=[]),d[a].push(function(a){return b.call(c,a)})},emit:function(a,b){var c=this.cStore;if(c[a])for(var d=c[a].length,e=0;d>e;e++){var f=c[a][e];f(b)}}},a}(),g=function(a){var b=a._renderer,c=a._coordinator,d=a._store;c.on("renderpartial",b.renderPartial,b),c.on("renderall",b.renderAll,b),c.on("extremachange",function(b){a._config.onExtremaChange&&a._config.onExtremaChange({min:b.min,max:b.max,gradient:a._config.gradient||a._config.defaultGradient})}),d.setCoordinator(c)};return c.prototype={addData:function(){return this._store.addData.apply(this._store,arguments),this},removeData:function(){return this._store.removeData&&this._store.removeData.apply(this._store,arguments),this},setData:function(){return this._store.setData.apply(this._store,arguments),this},setDataMax:function(){return this._store.setDataMax.apply(this._store,arguments),this},setDataMin:function(){return this._store.setDataMin.apply(this._store,arguments),this},configure:function(a){return this._config=e.merge(this._config,a),this._renderer.updateConfig(this._config),this._coordinator.emit("renderall",this._store._getInternalData()),this},repaint:function(){return this._coordinator.emit("renderall",this._store._getInternalData()),this},getData:function(){return this._store.getData()},clear:function(){this._renderer._clear()},getDataURL:function(){return this._renderer.getDataURL()},getValueAt:function(a){return this._store.getValueAt?this._store.getValueAt(a):this._renderer.getValueAt?this._renderer.getValueAt(a):null}},c}(),g={create:function(a){return new f(a)},register:function(b,c){a.plugins[b]=c}};return g}),gEcnu.Layer=gClass.extend({init:function(a,b){this.id=a,this.visible=!0,this.options={opacity:1,zIndex:0}},onAdd:function(a){this._map=a,this._container=a.getContainer();var b=a.getSize();this._initLayerContainer(this.id,b.w,b.h),this._initProp(a),this._initParams(a),this._container.appendChild(this._layerContainer),this.setzIndex(),this.setOpacity(this.options.opacity)},onRemove:function(a){var b=a.getContainer();b.removeChild(this._layerContainer)},_initProp:function(a){},_initParams:function(a){},onDrag:function(a,b){this._layerContainer.style.left=this.startLeft+a+"px",this._layerContainer.style.top=this.startTop+b+"px"},zoomIn:function(){this.renew()},zoomOut:function(){this.renew()},zoomTo:function(){this.renew()},renew:function(){this._layerContainer.style.left="0px",this._layerContainer.style.top="0px"},show:function(){this.zoomTo(),this._layerContainer.style.display="block",this.visible=!0},hide:function(){this._layerContainer.style.display="none",this.visible=!1},getSize:function(){return{w:this._layerContainer.clientWidth,h:this._layerContainer.clientHeight}},getScreenCenter:function(){return{x:parseInt(this._layerContainer.clientWidth/2),y:parseInt(this._layerContainer.clientHeight/2)}},getMap:function(){return this._map},getLayerContainer:function(){return this._layerContainer},setzIndex:function(){isNaN(this.options.zIndex)||(this._layerContainer.style.zIndex=this.options.zIndex)},setOpacity:function(a){this.getLayerContainer().style.opacity=a},resize:function(){this._layerContainer.style.width=this._map.w+"px",this._layerContainer.style.height=this._map.h+"px"}}),gEcnu.Layer.Dyn=gEcnu.Layer.extend({init:function(a,b,c,d){this._super(b,d),this.options={zIndex:5},this.lyrStr=c,this.ws=a,this.oClass="dynLayer"},_initParams:function(a){var b=a.getCenter(),c=a.getZoom(),d=a.getSize();this.webMapURL=a.webMapURL,this.fileServer=a.fileServer,this._params={map:this.ws,w:d.w,h:d.h,mt:"zoomto",cx:b.x,cy:b.y,zoom:c.z,"return":"json",lyrs:""}},_initProp:function(a){var b=a.getSize();this._mapImg=new Image,this.img_copy=new Image,this._layerContainer.appendChild(this._mapImg),this._mapImg.width=b.w,this._mapImg.height=b.h,this.ctrlLyrs=[],this.mapUrl=null,this.startLeft=0,this.startTop=0,this.requestTimer=null,this.ifInit=!0,this.refreshFlag=!1},_initLayerContainer:function(a,b,c){var d=gEcnu.Util.createDiv(a,b,c,!0);d.style.zIndex=2,this._layerContainer=d},onAdd:function(a){a.ownDyn=!0,this._super(a),this.addLyr(this.lyrStr);var b=function(a){var b=a._map.mapTool;"pan"==b&&(a.img_copy.onload=null)};gEcnu.Layer.Dyn._removeDynLoad=b},addLyr:function(a,b){b&&(this.ctrlLyrs=["empty"]);for(var c=a.split(","),d=0;d<c.length;d++){var e=this.ctrlLyrs.indexOf(c[d]);0>e&&this.ctrlLyrs.push(c[d])}this._params.lyrs=this.ctrlLyrs.join(","),this._params.mt="zoomto",b&&(this._params.lyrs="empty,"+a),this._request(this._params)},removeLyr:function(a){for(var b=a.split(","),c=0;c<b.length;c++){var d=this.ctrlLyrs.indexOf(b[c]);if(d>=0){for(var e=d;e<this.ctrlLyrs.length-1;e++)this.ctrlLyrs[e]=this.ctrlLyrs[e+1];this.ctrlLyrs.length--}}this._params.lyrs=this.ctrlLyrs.join(","),this._params.mt="zoomto",this._request(this._params)},zoomIn:function(a){var b=this._params;b.zoom=b.zoom/2,this.scaleMap("zoomin",a),this.renew()},zoomOut:function(a){var b=this._params;b.zoom=2*b.zoom,this.scaleMap("zoomout",a),this.renew()},zoomTo:function(){this._params.zoom=this._map.zoom,this._params.cx=this._map.cx,this._params.cy=this._map.cy,this.renew()},scaleMap:function(a,b){var c=this._layerContainer;if("undefined"==typeof b);else{var d=b.x,e=b.y,f=d+"px "+e+"px";c.style.webkitTransformOrigin=f,c.style.transformOrigin=f}c.style.transition="transform 100ms ease-in-out",c.style.transition="-webkit-transform 100ms ease-in-out","zoomin"==a&&(c.style.transform="scale(2,2)",c.style.webkitTransform="scale(2,2)"),"zoomout"==a&&(c.style.transform="scale(0.5,0.5)",c.style.webkitTransform="scale(0.5,0.5)")},renew:function(){this._params.cx=this._map.cx,this._params.cy=this._map.cy,this._params.zoom=this._map.zoom;var a=this;a.requestTimer&&clearTimeout(a.requestTimer),a.requestTimer=setTimeout(function(){a._request(a._params)},250)},resize:function(){this._super();var a=(this.getMap(),this.getSize());this._mapImg.width=a.w,this._mapImg.height=a.h,this._params.w=a.w,this._params.h=a.h,this._params.zoom="",this.renew()},getAllVisibleLyrs:function(){return this.ctrlLyrs},refresh:function(){this.refreshFlag=!0,this._params.clearmap=this.ws,this._request(this._params)},_request:function(a){var b=this,c=this.webMapURL,d=this._layerContainer;try{gEcnu.Util.ajax("get",c,a,!0,function(c){if(b.refreshFlag=!1,b._params.clearmap&&(b._params.clearmap="",delete b._params.clearmap),c=JSON.parse(c),!c.mapURL)return void alert("地图请求失败！");var e=a.lyrs.toLowerCase().replace(/(^\s+)|(\s+$)/g,""),f=c.visibleLayers.toLowerCase().replace(/(^\s+)|(\s+$)/g,""),g=parseInt(a.zoom,10),h=parseInt(c.mapZoom,10),i=Math.round(a.cx),j=Math.round(a.cy),k=Math.round(c.centerX),l=Math.round(c.centerY);if(g==h&&i==k&&j==l&&e==f){if(gSelf.dragging)return;b.img_copy&&(b.img_copy.onload=null);var m=new Image,n=b.getSize();m.style.width=n.w+"px",m.style.height=n.h+"px",m.width=n.w,m.height=n.h,m.style.position="absolute",m.style.left="0px",m.style.top="0px",m.style.zIndex="10",b.img_copy=m,b.img_copy.onload=function(){d.removeChild(b._mapImg),d.style.left="0px",d.style.top="0px",d.appendChild(m),b._mapImg=m,d.style.transform="scale(1,1)",d.style.webkitTransform="scale(1,1)",d.style.transition="transform 0ms ease-in-out",d.style.transition="-webkit-transform 0ms ease-in-out"},m.src=b.fileServer+c.mapURL}})}catch(e){alert("出现异常在："+e)}}}),gEcnu.Layer.Tile=gEcnu.Layer.extend({init:function(a,b,c){this._super(a,c),this.options={opacity:1,zIndex:3},this.tileName=b?b:"shImg2012a",this.oClass="tileLayer",this.minLevel=gEcnu.config.minLevel,this.maxLevel=gEcnu.config.maxLevel,c&&(this.minLevel=c.minLevel?c.minLevel:this.minLevel,this.maxLevel=c.maxLevel?c.maxLevel:this.maxLevel)},_initLayerContainer:function(a,b,c){var d=gEcnu.Util.createDiv(a,b,c,!0);this._layerContainer=d},_initMapView:function(a,b){var c=new Date-0;this.mapView=document.createElement("div"),this.mapView.id="mapView_"+c,this.mapView.width=this.w,this.mapView.height=this.h,this.mapView.style.position="absolute",this.mapView.style.top="0px",this.mapView.style.left="0px",this.mapView.style.width=a+"px",this.mapView.style.height=b+"px",this.mapView.style.overflow="hidden",this.mapView.style.zIndex=1,this.baseMap=document.createElement("div"),this.baseMap.id="baseMap"+c,this.baseMap.style.position="absolute",this.baseMap.style.left=this.xOffset+"px",this.baseMap.style.top=this.yOffset+"px",this.baseMap.style.width=this.nWidth*this.tileWidth+"px",this.baseMap.style.height=this.nHeight*this.tileHeight+"px",this.baseMap.style.zIndex=2,this.baseBgMap=this.baseMap.cloneNode(),this.baseBgMap.id="baseBgMap"+c,this.mapView.appendChild(this.baseMap),this.mapView.appendChild(this.baseBgMap),this._layerContainer.appendChild(this.mapView),this.baseBgMap.style.zIndex=1},_initParams:function(a){var b=a.getSize(),c=a.getCenter(),d=a.getZoom(),e=this.tileName;this._params={req:"getmap",w:b.w,h:b.h,zl:d.zl,cx:c.x,cy:c.y,"return":"json",map:e}},_initProp:function(a){this.mapLeft=this._container.offsetLeft,this.mapTop=this._container.offsetTop,this.startLeft=0,this.startTop=0,this.xOffset=-100,this.yOffset=-100,this.xMinus=0,this.yMinus=0,this.imgURL=gEcnu.config.imgPath+"blank.png",this.hasImgURL=[],this.tileWidth=a.tileWidth,this.tileHeight=a.tileHeight;var b=a.getSize();this.nWidth=Math.ceil(parseInt(b.w)/a.tileWidth)+1,this.nHeight=Math.ceil(parseInt(b.h)/a.tileHeight)+1,this.tileMapURL=a.tileMapURL,this.fileServer=a.tileFileServer,this.mapTool="pan",this.ifInit=!1,this.ifZoomTo=!1,this.requestTimer=null;var b=this.getMap().getSize();this._initMapView(b.w,b.h)},onAdd:function(a){a.ownTile=!0,a.tileCount++,this._super(a),this._createTiles(),this.ifInit=!0,this._request(this._params)},onRemove:function(a){this._super(a),a.tileCount--},onDrag:function(a,b){this.visible&&(this.baseMap.style.left=this.startLeft+a+"px",this.baseMap.style.top=this.startTop+b+"px")},_panMap:function(){for(this.hideLayer("baseMap");this.xOffset>0;)this.wrapR2L();for(;this.yOffset>0;)this.wrapB2T();for(;this.xOffset<-this.tileWidth;)this.wrapL2R();for(;this.yOffset<-this.tileHeight;)this.wrapT2B();this.showLayer("baseMap")},zoomIn:function(a){this.mapTool="zoomin",this.ifzoominOrout=!0,this.scaleMap(a),this.renew()},zoomOut:function(a){this.mapTool="zoomout",this.ifzoominOrout=!0,this.scaleMap(a),this.renew()},zoomTo:function(){this.ifZoomTo=!0,this._params.zl=this._map.zl,this._params.cx=this._map.cx,this._params.cy=this._map.cy,this._resetTile(),this.renew(),this.mapTool="pan"},getCurrentLevel:function(){var a=this._map.zl;return a},isInLevel:function(){var a=this.getCurrentLevel(),b=this.minLevel,c=this.maxLevel;return a>=b&&c>=a},scaleMap:function(a){this.hideLayer("baseMap");var b,c,d=this.getScreenCenter(),e=this.baseBgMap,f=this.baseMap.childNodes.length;"undefined"==typeof a?(b=d.x-this.xMinus,c=d.y-this.yMinus):(b=a.x-this.xMinus,c=a.y-this.yMinus);var g=(this.tileWidth*this.nWidth/2,this.tileHeight*this.nHeight/2,b+"px "+c+"px");e.style.webkitTransformOrigin=g,e.style.transformOrigin=g;var f=this.baseMap.childNodes.length,h=0,i=0;e.style.left=this.xMinus+"px",e.style.top=this.yMinus+"px";for(var j=0;f>j;j++){var k=this.baseMap.childNodes[0];if(0==j)h=gEcnu.Util.delpx(k.style.left),i=gEcnu.Util.delpx(k.style.top),k.style.left="0px",k.style.top="0px";else{var l=gEcnu.Util.delpx(k.style.left)-h+"px",m=gEcnu.Util.delpx(k.style.top)-i+"px";k.style.left=l,k.style.top=m}e.appendChild(k)}"zoomin"==this.mapTool&&(e.style.transform="scale(2,2)",e.style.webkitTransform="scale(2,2)"),"zoomout"==this.mapTool&&(e.style.transform="scale(0.5,0.5)",e.style.webkitTransform="scale(0.5,0.5)"),e.style.transition="transform 100ms ease-in-out",e.style.transition="-webkit-transform 100ms ease-in-out"},renew:function(){this._params.cx=this._map.cx,this._params.cy=this._map.cy,this._params.zl=this._map.zl,"pan"==this.mapTool&&(this.ifzoominOrout=!1,this._panMap());var a=this;a.requestTimer&&clearTimeout(a.requestTimer),a.requestTimer=setTimeout(function(){a._request(a._params)},250)},resize:function(){this._super();var a=this.getMap(),b=a.getSize();this.nWidth=Math.ceil(parseInt(b.w)/a.tileWidth)+1,this.nHeight=Math.ceil(parseInt(b.h)/a.tileHeight)+1,this.mapView.style.width=b.w+"px",this.mapView.style.height=b.h+"px",this.baseMap.style.width=this.baseBgMap.style.width=this.nWidth*this.tileWidth+"px",this.baseMap.style.height=this.baseBgMap.style.height=this.nHeight*this.tileHeight+"px",this._params.w=b.w,this._params.h=b.h;for(var c=this.baseMap.childNodes.length-1;c>=0;c--){var d=this.baseMap.childNodes[c];this.baseMap.removeChild(d),d=null}this.ifZoomTo=!0,this._createTiles(),this.renew()},_request:function(a){var b=this,c=this.tileMapURL;
try{var d=!1;d=!this.ifInit,gEcnu.Util.ajax("get",c,a,d,function(a){a=JSON.parse(a),b._showMap(a)})}catch(e){alert("出现异常在："+e)}},_showMap:function(a){function b(){var o=e*f;if(l>=g||l>=o)return void(c.mapTool="pan");var p=a.tiles[l].row,q=a.tiles[l].col;if(f>=p&&e>=q){var r=(p-1)*e+(q-1),s=d.childNodes[r],t=a.tiles[l].url,u=t.split("/")[2],v=u.substr(1,u.length-1),w=this.tileWidth*this.nWidth/2,x=this.tileHeight*this.nHeight/2;if("undefined"!=typeof s&&v==c._params.zl&&h==j&&k==i){var y=c.fileServer+t;void 0!=n[p+"_"+q]?"pan"!=c.mapTool&&m++:n[p+"_"+q]=!0,s.src=y,s.onerror=function(){s.src=gEcnu.config.imgPath+"blank.png"},s.onload=function(){m++;var a=e*f;if(m==g||m==a){var b=c.baseBgMap;b.style.left=c.baseMap.style.left,b.style.top=c.baseMap.style.top,c.showLayer("baseMap");for(var d=b.childNodes.length;d>0;d--){var h=b.childNodes[d-1];b.removeChild(h),h=null}b.style.webkitTransform="scale(1,1)",b.style.transform="scale(1,1)";var i=w+"px "+x+"px";b.style.webkitTransformOrigin=i,b.style.transformOrigin=i,b.style.transition="transform 10ms ease-in-out",b.style.transition="-webkit-transform 10ms ease-in-out"}},c.hasImgURL[s.id]=!0}}l++,b()}var c=this,d=this.baseMap,e=this.nWidth,f=this.nHeight;this.xMinus=a.tileInfo.xoff,this.yMinus=a.tileInfo.yoff,(this.ifInit||this.ifZoomTo||this.ifzoominOrout)&&(this.xOffset=a.tileInfo.xoff,this.yOffset=a.tileInfo.yoff,d.style.left=this.xOffset+"px",d.style.top=this.yOffset+"px",(this.ifInit||this.ifZoomTo)&&(this.ifZoomTo=!1,this._map.setZoom(a.tileInfo.zoom))),this.ifInit&&(this.baseBgMap.style.left=d.style.left,this.baseBgMap.style.top=d.style.top,this.ifInit=!1),this.ifzoominOrout&&this._resetTile();var g=a.tiles.length,h=parseInt(a.tileInfo.cx,10),i=parseInt(a.tileInfo.cy,10),j=parseInt(this._params.cx,10),k=parseInt(this._params.cy,10),l=0,m=0,n=(a.tiles,c.baseBgMap,this.tileWidth*this.nWidth/2,this.tileHeight*this.nHeight/2,{});b()},_resetTile:function(){for(var a=this.baseMap,b=a.childNodes.length;b>0;b--){var c=a.childNodes[b-1];a.removeChild(c),c=null}this._createTiles()},_createTiles:function(){for(var a,b,c=this.nWidth*this.nHeight,d=0;c>d;d++){var e=document.createElement("img");e.id="mt_"+d,e.src=this.imgURL,this.hasImgURL[e.id]=!1,e.style.position="absolute",b=Math.floor(d/this.nWidth)*this.tileHeight,a=Math.floor(d%this.nWidth)*this.tileWidth,e.style.left=a+"px",e.style.top=b+"px",e.style.width=this.tileWidth+"px",e.style.height=this.tileHeight+"px",this.baseMap.appendChild(e)}},wrapR2L:function(){this.xOffset=this.xOffset-this.tileWidth;var a=this.baseMap;if(void 0!=a.childNodes[0])for(var b=gEcnu.Util.delpx(a.childNodes[0].style.left),c=0;c<this.nHeight;c++){var d=a.childNodes[(c+1)*this.nWidth-1],e=a.childNodes[c*this.nWidth];d.style.left=b-this.tileWidth+"px",d.src=this.imgURL,a.removeChild(d),a.insertBefore(d,e),this.hasImgURL[d.id]=!1}},wrapL2R:function(){this.xOffset=this.xOffset+this.tileWidth;var a=this.baseMap;if(void 0!=a.childNodes[this.nWidth-1])for(var b=gEcnu.Util.delpx(a.childNodes[this.nWidth-1].style.left),c=0;c<this.nHeight;c++){var d,e=a.childNodes[c*this.nWidth];d=c<this.nHeight-1?a.childNodes[(c+1)*this.nWidth]:null,e.style.left=b+this.tileWidth+"px",e.src=this.imgURL,a.removeChild(e),d?a.insertBefore(e,d):a.appendChild(e),this.hasImgURL[e.id]=!1}},wrapT2B:function(){this.yOffset=this.yOffset+this.tileHeight;var a=this.baseMap;if(void 0!=a.childNodes[this.nHeight*this.nWidth-1])for(var b=gEcnu.Util.delpx(a.childNodes[this.nHeight*this.nWidth-1].style.top),c=0;c<this.nWidth;c++){var d=a.childNodes[0];d.style.top=b+this.tileHeight+"px",d.src=this.imgURL,a.removeChild(d),a.appendChild(d),this.hasImgURL[d.id]=!1}},wrapB2T:function(){this.yOffset=this.yOffset-this.tileHeight;var a=this.baseMap;if(void 0!=a.childNodes[0])for(var b=gEcnu.Util.delpx(a.childNodes[0].style.top),c=0;c<this.nWidth;c++){var d=a.childNodes[this.nHeight*this.nWidth-1];d.style.top=b-this.tileHeight+"px",d.src=this.imgURL,a.removeChild(d),a.insertBefore(d,a.childNodes[0]),this.hasImgURL[d.id]=!1}},showLayer:function(a){switch(a){case"baseMap":this.baseMap.style.display="block";break;case"bgMap":this.baseBgMap.style.display="block"}},hideLayer:function(a){switch(a){case"baseMap":this.baseMap.style.display="none";break;case"bgMap":this.baseBgMap.style.display="none"}}}),gEcnu.Layer.Tile_Ex=gEcnu.Layer.extend({init:function(a,b,c){this._super(a,c),this.options={opacity:1,zIndex:4},this.tileName=b,this.oClass="tileLayer",this.minLevel=14,this.maxLevel=21,c&&(this.minLevel=c.minLevel||14,this.maxLevel=c.maxLevel||21),this.xScale=1,this.yScale=1},_initLayerContainer:function(a,b,c){var d=gEcnu.Util.createDiv(a,b,c,!0);this._layerContainer=d},_initMapView:function(a,b){var c=new Date-0;this.mapView=document.createElement("div"),this.mapView.id="mapView_"+c,this.mapView.width=this.w,this.mapView.height=this.h,this.mapView.style.position="absolute",this.mapView.style.top="0px",this.mapView.style.left="0px",this.mapView.style.width=a+"px",this.mapView.style.height=b+"px",this.mapView.style.overflow="hidden",this.mapView.style.zIndex=1,this.baseMap=document.createElement("div"),this.baseMap.id="baseMap"+c,this.baseMap.style.position="absolute",this.baseMap.style.left=this.xOffset+"px",this.baseMap.style.top=this.yOffset+"px",this.baseMap.style.width=this.nWidth*this.tileWidth+"px",this.baseMap.style.height=this.nHeight*this.tileHeight+"px",this.baseMap.style.zIndex=2,this.baseBgMap=this.baseMap.cloneNode(),this.baseBgMap.id="baseBgMap"+c,this.mapView.appendChild(this.baseMap),this.mapView.appendChild(this.baseBgMap),this._layerContainer.appendChild(this.mapView),this.baseBgMap.style.zIndex=1},_initParams:function(a){var b=a.getSize(),c=a.getCenter(),d=a.getZoom(),e=this.tileName;this._params={req:"getmap",w:b.w,h:b.h,zl:d.zl+17,cx:c.x,cy:c.y,"return":"json",map:e},this.zl=this._params.zl},_initProp:function(a){this.mapLeft=this._container.offsetLeft,this.mapTop=this._container.offsetTop,this.startLeft=0,this.startTop=0,this.xOffset=-100,this.yOffset=-100,this.xMinus=0,this.yMinus=0,this.imgURL=gEcnu.config.imgPath+"blank.png",this.hasImgURL=[],this.tileWidth=a.tileWidth,this.tileHeight=a.tileHeight;var b=a.getSize();this.mapSize=b,this.nWidth=Math.ceil(parseInt(b.w)/a.tileWidth)+1,this.nHeight=Math.ceil(parseInt(b.h)/a.tileHeight)+1,this.tileMapURL=a.tileMapURL_Ex,this.fileServer=a.fileServer_Ex,this.mapTool="pan",this.ifInit=!1,this.ifZoomTo=!1,this.requestTimer=null;var b=this.getMap().getSize();this._initMapView(b.w,b.h)},onAdd:function(a){a.ownTile=!0,a.tileCount++,this._super(a),this.createTileFlag=!0,this.ifInit=!0,this._request(this._params)},onRemove:function(a){this._super(a),a.tileCount--},onDrag:function(a,b){this.visible&&(this.baseMap.style.left=this.startLeft+a+"px",this.baseMap.style.top=this.startTop+b+"px")},_panMap:function(){for(this.hideLayer("baseMap");this.xOffset>0;)this.wrapR2L();for(;this.yOffset>0;)this.wrapB2T();for(;this.xOffset<-this.tileWidth;)this.wrapL2R();for(;this.yOffset<-this.tileHeight;)this.wrapT2B();this.showLayer("baseMap")},zoomIn:function(a){var b=this.getCurrentLevel();b<this.minLevel||(this.mapTool="zoomin",this.ifzoominOrout=!0,this.scaleMap(a),this.renew())},zoomOut:function(a){var b=this.getCurrentLevel();b>this.maxLevel||(this.mapTool="zoomout",this.ifzoominOrout=!0,this.scaleMap(a),this.renew())},zoomTo:function(){this.ifZoomTo=!0,this._params.zl=this._map.zl+17,this._params.cx=this._map.cx,this._params.cy=this._map.cy,this._resetTile(),this.renew(),this.mapTool="pan"},getCurrentLevel:function(){var a=this._map.zl+17;return a},isInLevel:function(){var a=this.getCurrentLevel(),b=this.minLevel,c=this.maxLevel;return a>=b&&c>=a},scaleMap:function(a){this.hideLayer("baseMap");var b,c,d=this.getScreenCenter(),e=this.baseBgMap,f=this.baseMap.childNodes.length;"undefined"==typeof a?(b=d.x-this.xMinus,c=d.y-this.yMinus):(b=a.x-this.xMinus,c=a.y-this.yMinus);var g=(this.tileWidth*this.nWidth/2,this.tileHeight*this.nHeight/2,b+"px "+c+"px");e.style.webkitTransformOrigin=g,e.style.transformOrigin=g;var f=this.baseMap.childNodes.length,h=0,i=0;e.style.left=this.xMinus+"px",e.style.top=this.yMinus+"px";for(var j=0;f>j;j++){var k=this.baseMap.childNodes[0];if(0==j)h=gEcnu.Util.delpx(k.style.left),i=gEcnu.Util.delpx(k.style.top),k.style.left="0px",k.style.top="0px";else{var l=gEcnu.Util.delpx(k.style.left)-h+"px",m=gEcnu.Util.delpx(k.style.top)-i+"px";k.style.left=l,k.style.top=m}e.appendChild(k)}"zoomin"==this.mapTool&&(e.style.transform="scale(2,2)",e.style.webkitTransform="scale(2,2)"),"zoomout"==this.mapTool&&(e.style.transform="scale(0.5,0.5)",e.style.webkitTransform="scale(0.5,0.5)"),e.style.transition="transform 100ms ease-in-out",e.style.transition="-webkit-transform 100ms ease-in-out"},renew:function(){this._params.cx=this._map.cx,this._params.cy=this._map.cy,this._params.zl=this._map.zl+17,"pan"==this.mapTool&&(this.ifzoominOrout=!1,this._panMap());var a=this;a.requestTimer&&clearTimeout(a.requestTimer),a.requestTimer=setTimeout(function(){a._request(a._params)},250)},resize:function(){var a=this;a.resizeTimerID&&clearTimeout(a.resizeTimerID),a.resizeTimerID=setTimeout(function(){a._resize()},250)},_resize:function(){this._layerContainer.style.width=this._map.w+"px",this._layerContainer.style.height=this._map.h+"px";var a=this.getMap(),b=a.getSize();this.nWidth=Math.ceil(parseInt(b.w)/this.tileWidth)+1,this.nHeight=Math.ceil(parseInt(b.h)/this.tileHeight)+1,this.mapView.style.width=b.w+"px",this.mapView.style.height=b.h+"px",this.baseMap.style.width=this.baseBgMap.style.width=this.nWidth*this.tileWidth+"px",this.baseMap.style.height=this.baseBgMap.style.height=this.nHeight*this.tileHeight+"px",this._params.w=b.w,this._params.h=b.h;for(var c=this.baseMap.childNodes.length-1;c>=0;c--){var d=this.baseMap.childNodes[c];this.baseMap.removeChild(d),d=null}this.ifZoomTo=!0,this._createTiles(),this.renew()},_request:function(a){var b=this,c=this.tileMapURL;try{var d=!1;d=!this.ifInit,a.zl<=this.maxLevel&&a.zl>=this.minLevel&&gEcnu.Util.ajax("get",c,a,d,function(a){a=JSON.parse(a),b.resetTileInfo(a),b._showMap(a)})}catch(e){alert("出现异常在："+e)}},resetTileInfo:function(a){this.tileWidth="undefined"==typeof a.tileInfo.tileWidth?this.tileWidth:a.tileInfo.tileWidth,this.tileHeight="undefined"==typeof a.tileInfo.tileHeight?this.tileHeight:a.tileInfo.tileHeight,this.xScale=a.tileInfo.xScale,this.yScale=a.tileInfo.yScale;var b=this.getMap(),c=b.getSize();this.nWidth=Math.ceil(parseInt(c.w)/this.tileWidth)+1,this.nHeight=Math.ceil(parseInt(c.h)/this.tileHeight)+1,this.baseMap.style.width=this.nWidth*this.tileWidth+"px",this.baseMap.style.height=this.nHeight*this.tileHeight+"px",this.baseBgMap.style.width=this.nWidth*this.tileWidth+"px",this.baseBgMap.style.height=this.nHeight*this.tileHeight+"px",this.createTileFlag&&(this._createTiles(),this.createTileFlag=!1)},_showMap:function(a){function b(){var k=e*f;if(h>=g||h>=k)return void(c.mapTool="pan");var l=a.tiles[h].row,m=a.tiles[h].col;if(f>=l&&e>=m){var n=(l-1)*e+(m-1),o=d.childNodes[n],p=a.tiles[h].url,q=(p.split("/")[2],this.tileWidth*this.nWidth/2),r=this.tileHeight*this.nHeight/2;if("undefined"!=typeof o){var s=c.fileServer+p;void 0!=j[l+"_"+m]?"pan"!=c.mapTool&&i++:j[l+"_"+m]=!0,o.src=s,o.onerror=function(){o.src=gEcnu.config.imgPath+"blank.png"},o.onload=function(){i++;var a=e*f;if(i==g||i==a){var b=c.baseBgMap;b.style.left=c.baseMap.style.left,b.style.top=c.baseMap.style.top,c.showLayer("baseMap");for(var d=b.childNodes.length;d>0;d--){var h=b.childNodes[d-1];b.removeChild(h),h=null}b.style.webkitTransform="scale(1,1)",b.style.transform="scale(1,1)";var j=q+"px "+r+"px";b.style.webkitTransformOrigin=j,b.style.transformOrigin=j,b.style.transition="transform 10ms ease-in-out",b.style.transition="-webkit-transform 10ms ease-in-out"}},c.hasImgURL[o.id]=!0}}h++,b()}var c=this,d=this.baseMap,e=this.nWidth,f=this.nHeight;this.xMinus=a.tileInfo.xoff,this.yMinus=a.tileInfo.yoff,(this.ifInit||this.ifZoomTo||this.ifzoominOrout)&&(this.xOffset=a.tileInfo.xoff,this.yOffset=a.tileInfo.yoff,d.style.left=this.xOffset+"px",d.style.top=this.yOffset+"px",(this.ifInit||this.ifZoomTo)&&(this.ifZoomTo=!1,this._map.setZoom(a.tileInfo.zoom))),this.ifInit&&(this.baseBgMap.style.left=d.style.left,this.baseBgMap.style.top=d.style.top,this.ifInit=!1),this.ifzoominOrout&&this._resetTile();var g=a.tiles.length,h=(parseInt(a.tileInfo.cx,10),parseInt(a.tileInfo.cy,10),parseInt(this._params.cx,10),parseInt(this._params.cy,10),0),i=0,j=(a.tiles,c.baseBgMap,this.tileWidth*this.nWidth/2,this.tileHeight*this.nHeight/2,{});b()},_scaleTile:function(){var a=this.baseMap,b=this.getMap().getZoom().zl,c=Math.pow(2,b-1),d=c/this.xScale,e=c/this.yScale;a.style.transformOriogin="50% 50%",a.style.webkitTransformOriogin="50% 50%",a.style.transform="scale("+d+","+e+")",a.style.webkitTransform="scale("+d+","+e+")"},_normalTile:function(){var a=this.baseMap;a.style.transformOriogin="50% 50%",a.style.webkitTransformOriogin="50% 50%",a.style.transform="scale(1,1)",a.style.webkitTransform="scale(1,1)"},_resetTile:function(){for(var a=this.baseMap,b=a.childNodes.length;b>0;b--){var c=a.childNodes[b-1];a.removeChild(c),c=null}this._createTiles()},_createTiles:function(){for(var a,b,c=this.nWidth*this.nHeight,d=0;c>d;d++){var e=document.createElement("img");e.id="mt_"+d,e.src=this.imgURL,this.hasImgURL[e.id]=!1,e.style.position="absolute",b=Math.floor(d/this.nWidth)*this.tileHeight,a=Math.floor(d%this.nWidth)*this.tileWidth,e.style.left=a+"px",e.style.top=b+"px",e.style.width=this.tileWidth+"px",e.style.height=this.tileHeight+"px",this.baseMap.appendChild(e)}},wrapR2L:function(){this.xOffset=this.xOffset-this.tileWidth;var a=this.baseMap;if(void 0!=a.childNodes[0])for(var b=gEcnu.Util.delpx(a.childNodes[0].style.left),c=0;c<this.nHeight;c++){var d=a.childNodes[(c+1)*this.nWidth-1],e=a.childNodes[c*this.nWidth];d.style.left=b-this.tileWidth+"px",d.src=this.imgURL,a.removeChild(d),a.insertBefore(d,e),this.hasImgURL[d.id]=!1}},wrapL2R:function(){this.xOffset=this.xOffset+this.tileWidth;var a=this.baseMap;if(void 0!=a.childNodes[this.nWidth-1])for(var b=gEcnu.Util.delpx(a.childNodes[this.nWidth-1].style.left),c=0;c<this.nHeight;c++){var d,e=a.childNodes[c*this.nWidth];d=c<this.nHeight-1?a.childNodes[(c+1)*this.nWidth]:null,e.style.left=b+this.tileWidth+"px",e.src=this.imgURL,a.removeChild(e),d?a.insertBefore(e,d):a.appendChild(e),this.hasImgURL[e.id]=!1}},wrapT2B:function(){this.yOffset=this.yOffset+this.tileHeight;var a=this.baseMap;if(void 0!=a.childNodes[this.nHeight*this.nWidth-1])for(var b=gEcnu.Util.delpx(a.childNodes[this.nHeight*this.nWidth-1].style.top),c=0;c<this.nWidth;c++){var d=a.childNodes[0];d.style.top=b+this.tileHeight+"px",d.src=this.imgURL,a.removeChild(d),a.appendChild(d),this.hasImgURL[d.id]=!1}},wrapB2T:function(){this.yOffset=this.yOffset-this.tileHeight;var a=this.baseMap;if(void 0!=a.childNodes[0])for(var b=gEcnu.Util.delpx(a.childNodes[0].style.top),c=0;c<this.nWidth;c++){var d=a.childNodes[this.nHeight*this.nWidth-1];d.style.top=b-this.tileHeight+"px",d.src=this.imgURL,a.removeChild(d),a.insertBefore(d,a.childNodes[0]),this.hasImgURL[d.id]=!1}},showLayer:function(a){switch(a){case"baseMap":this.baseMap.style.display="block";break;case"bgMap":this.baseBgMap.style.display="block"}},hideLayer:function(a){switch(a){case"baseMap":this.baseMap.style.display="none";break;case"bgMap":this.baseBgMap.style.display="none"}}}),gEcnu.Layer.Other=gEcnu.Layer.extend({init:function(a,b,c){this._super(a,c),this.options={opacity:1,zIndex:2},this.options=gEcnu.Util.setOptions(this,c),this.mapSource=b,this.oClass="otherLayer";this.oMap=null},_initLayerContainer:function(a,b,c){var d=gEcnu.Util.createDiv(a,b,c,!0);this._layerContainer=d,gSelf.activeLayer=this},onAdd:function(a){var b=this;a.ownOther=!0,this._map=a,this._super(a),this.oMapMinlevel=1,this.oMapMaxLevel=18;var c=document.createElement("script"),d=this._isExistScript();if(d)return void showOtherMap_self();switch(this.mapSource){case"google":b.otherPxScale=.001373291015625,c.src="http://maps.googleapis.com/maps/api/js?sensor=false&callback=showOtherMap_self";break;case"baidu":b.otherPxScale=.0011498312500000019,c.src="http://api.map.baidu.com/api?v=1.4&callback=showOtherMap_self",this.oMapMaxLevel=19;break;case"tianditu":b.otherPxScale=.0013767249999999897,c.src="http://api.tianditu.com/js/maps.js",c.onload=showOtherMap_self}document.getElementsByTagName("head")[0].appendChild(c)},_isExistScript:function(){var a=document.getElementsByTagName("head")[0].getElementsByTagName("script"),b="";switch(this.mapSource){case"google":b="http://maps.googleapis.com/maps/api/js?sensor=false&callback=showOtherMap_self";break;case"tianditu":b="http://api.tianditu.com/js/maps.js";break;case"baidu":b="http://api.map.baidu.com/api?v=1.4&callback=showOtherMap_self"}for(var c=0,d=a.length;d>c;c++){var e=a[c].src;if(b==e)return!0}return!1},zoomIn:function(){this.renew()},zoomOut:function(){this.renew()},zoomTo:function(){this.renew()},setMapType:function(a){switch(this.mapSource){case"google":switch(a){case"ROAD":this.oMap.setMapTypeId(google.maps.MapTypeId.ROADMAP);break;case"SATELLITE":this.oMap.setMapTypeId(google.maps.MapTypeId.SATELLITE);break;case"HYBRID":this.oMap.setMapTypeId(google.maps.MapTypeId.HYBRID)}break;case"baidu":switch(a){case"ROAD":this.oMap.setMapType(BMAP_NORMAL_MAP);break;case"SATELLITE":this.oMap.setMapType(BMAP_SATELLITE_MAP);break;case"HYBRID":this.oMap.setMapType(BMAP_HYBRID_MAP)}break;case"tianditu":switch(a){case"ROAD":this.oMap.setMapType(TMAP_NORMAL_MAP);break;case"SATELLITE":this.oMap.setMapType(TMAP_SATELLITE_MAP);break;case"HYBRID":this.oMap.setMapType(TMAP_HYBRID_MAP)}}},resize:function(){var a=this._map.getSize(),b=document.getElementById(this._layerContainer.id);b.style.width=a.w+"px",b.style.height=a.h+"px",this._layerContainer=b;var c=gSelf.coordsFlag;"GEOGRAPHIC"==c?this._resize_geo():this._resize_proj()},_resize_geo:function(){var a=gSelf.getCenter();switch(this.mapSource){case"google":this.oMap.setCenter(new google.maps.LatLng(a.y,a.x));break;case"baidu":this.oMap.setCenter(new BMap.Point(a.x,a.y));break;case"tianditu":this.oMap.setCenterAtLngLat(new TLngLat(a.x,a.y))}},_resize_proj:function(){var a=gSelf.getCenter(),b=gEcnu.Util.shToLngLat(a.x,a.y);switch(this.mapSource){case"google":this.oMap.setCenter(new google.maps.LatLng(b.lat,b.lng));break;case"baidu":this.oMap.setCenter(new BMap.Point(b.lng,b.lat));break;case"tianditu":var b=gEcnu.Util.shToLngLat(a.x-410,a.y+260);this.oMap.setCenterAtLngLat(new TLngLat(b.lng,b.lat))}},renew:function(){this._super();var a=gSelf.coordsFlag;"GEOGRAPHIC"==a?this._renew_geo():this._renew_proj()},_renew_geo:function(){var a=this._map.getCenter(),b=this._map.getZoom(),c=this.mapSource,d=this.otherPxScale,e=b.z,f=d*gSelf.w;switch(c){case"google":this.oMap.setCenter(new google.maps.LatLng(a.y,a.x));var g=10-Math.log(e/f)/Math.log(2);this.oMap.setZoom(g);break;case"tianditu":var g=10-Math.log(e/f)/Math.log(2);this.oMap.centerAndZoom(new TLngLat(a.x,a.y),g);break;case"baidu":var g=11-Math.log(e/f)/Math.log(2);this.oMap.centerAndZoom(new BMap.Point(a.x,a.y),g)}},_renew_proj:function(){this._super();var a=this._map.getCenter(),b=this._map.getZoom(),c=gEcnu.Util.shToLngLat(a.x,a.y),d=this.mapSource;switch(d){case"google":this.oMap.setCenter(new google.maps.LatLng(c.lat,c.lng)),this.oMap.setZoom(18-b.zl);break;case"tianditu":var c=gEcnu.Util.shToLngLat(a.x-410,a.y+260);this.oMap.centerAndZoom(new TLngLat(c.lng,c.lat),18-b.zl);break;case"baidu":this.oMap.centerAndZoom(new BMap.Point(c.lng,c.lat),19-b.zl)}}}),gEcnu.Layer.Feature=gEcnu.Layer.extend({init:function(a,b,c,d){if(this._super(a),this.options={zIndex:6},this._land_label=!1,"undefined"!=typeof d&&(this._autoLabel=d.autoLabel,this._labelField=d.lableField,"undefined"!=typeof d.Mapping&&(this._labelFieldMapping=d.Mapping)),this.options=gEcnu.Util.setOptions(this,c),arguments.length>1)this.style=b;else{var e=new gEcnu.Style({});this.style=e}this.oClass="featureLayer",this.featureID=0,this.ctrlLyrs=[],this._opacity=!1,this.resetStyle=!1},_initLayerContainer:function(a,b,c){var d=gEcnu.Util.createCanvas(a,b,c,!0);this._layerContainer=d,this._ctx=d.getContext("2d"),this._layerContainer.style.left="0px",this._layerContainer.style.top="0px"},onAdd:function(a){this._map=a;var b=a.getSize(),c=this._map.getContainer();this._initLayerContainer(this.id,b.w,b.h),c.appendChild(this._layerContainer),this.setzIndex(),this.oFeatures=[]},setStyle:function(a){this.style=a,this.resetStyle=!0,this.renew()},setLabelSize:function(a){if(a=parseInt(a),this.style instanceof gEcnu.Style_Ex)for(var b=this.style.styles,c=b.length,d=0;c>d;d++){var e=b[d];e.fontSize=a}else this.style instanceof gEcnu.Style&&(this.style.fontSize=a);this.resetStyle=!0,this.renew()},setLabelOptions:function(a){"undefined"!=typeof a&&(this._autoLabel=a.autoLabel,this._labelField=a.lableField,"undefined"!=typeof a.Mapping&&(this._labelFieldMapping=a.Mapping))},activeLabel:function(){return"undefined"==typeof this._labelField?void alert("未定义标注字段！"):void(this._autoLabel||(this._autoLabel=!0,this.renew()))},deactiveLabel:function(){this._autoLabel&&(this._autoLabel=!1,this.renew())},activeOpacity:function(){this._opacity=!0,this.renew()},deactiveOpacity:function(){this._opacity=!1,this.renew()},addFeature:function(a){var b=this.getAllFeatures();gEcnu.Util.isInArray(b,a)||(b.push(a),a.onAdd(this))},removeFeature:function(a){for(var b=[],c=0,d=0;c<this.oFeatures.length;c++)this.oFeatures[c]!=a?(b[d]=this.oFeatures[c],d++):a.onRemove(this);this.oFeatures=b;this.getMap();this.renew()},addFeatures:function(a){for(var b=0;b<a.length;b++)this.addFeature(a[b])},removeFeatures:function(a){for(var b=0;b<a.length;b++)this.removeFeature(a[b])},removeFeaturesByFiled:function(a,b){for(var c=this.getAllFeatures(),d=c.length,e=0;d>e;e++){var f=c[e];f.fields[a]==b&&this.removeFeature(f)}},removeAllFeatures:function(){this.oFeatures=[],this.renew()},draw:function(){for(var a=this.getAllFeatures(),b=0;b<a.length;b++)this.setFeatureStyle(this,a[b].info),a[b].onDraw(this)},setFeatureStyle:function(){},renew:function(){this._super(),this._map.overLayer.clear(),this.clear(),this.draw()},refresh:function(){for(var a=this.getAllFeatures(),b=0;b<a.length;b++)a[b].onAdd(this)},resize:function(){this._super(),this._layerContainer.width=this._map.w,this._layerContainer.height=this._map.h,this.renew()},clear:function(){var a=this.getLayerContainer();this._ctx.clearRect(0,0,a.width,a.height)},getAllFeatures:function(){return this.oFeatures},updateFea:function(a,b){for(var c=this.oFeatures,d=c.length,e=d-1;e>=0;e--)if(c[e]==a){c.splice(e,1,b);break}},getScrFeatures:function(){var a=[],b=this.oFeatures,c=this._map,d=b.length;if(0>=d)return a;for(var e=0;d>e;e++){var f=b[e],g=f.shape.shpBox,h=g[0],i=g[1],j=g[2],k=g[3],l=c.getBounds(),m=l.nw.x,n=l.se.y,o=l.se.x,p=l.nw.y,q=h>=m&&o>h&&i>=n&&p>=i,r=h>=m&&o>h&&k>=n&&p>=k,s=j>=m&&o>j&&i>=n&&p>=i,t=j>=m&&o>j&&k>=n&&p>=k;(q||r||s||t)&&a.push(f)}return a},getCtx:function(){return this._ctx}}),gEcnu.Layer.Overlay=gEcnu.Layer.Feature.extend({init:function(a,b){this._super(a,b),this.options={opacity:1,zIndex:10},this.options=gEcnu.Util.setOptions(this,b),this.oClass="overlayLayer"},setStyle:function(a){this.style=a},initStyle:function(){var a=this.getCtx();a.strokeStyle="green",a.fillStyle="green",this._layerContainer.style.left="0px",this._layerContainer.style.top="0px",a.gloablAlpha=.7},onAdd:function(a){this._super(a),this.initStyle()},resize:function(){this._super(),this._layerContainer.width=this._map.w,this._layerContainer.height=this._map.h,this.renew()}}),gEcnu.Layer.Text=gEcnu.Layer.extend({init:function(a,b,c){this._super(a,c),this.options={opacity:1,zIndex:19},this.options=gEcnu.Util.setOptions(this,c),this.id=a,this.oClass="textLayer",this.oTexts=[],this.style=b,this.resetStyle=!1},_initLayerContainer:function(a,b,c){var d=gEcnu.Util.createDiv(a,b,c,!0);this._layerContainer=d},addText:function(a){gEcnu.Util.isInArray(this.oTexts,a)||(this.oTexts.push(a),a.onAdd(this))},removeText:function(a){for(var b=[],c=0,d=0;c<this.oTexts.length;c++)this.oTexts[c]!=a?(b[d]=this.oTexts[c],d++):this.oTexts[c].onRemove(this);this.oTexts=b,this.renew()},addTexts:function(a){for(var b=(this.oTexts,0);b<a.length;b++)this.addText(a[b])},removeTexts:function(a){for(var b=a,c=b.length,d=0;c>d;d++){var e=b[d];this.removeText(e)}},removeTextsByField:function(a,b){for(var c=this.oTexts,d=c.length,e=0;d>e;e++){var f=c[e];f.fields[a]==b&&this.removeText(f)}},getAllTexts:function(){return this.oTexts},removeAllTexts:function(){this._layerContainer.innerHTML="",this.oTexts=[],this.renew()},setStyle:function(a){this.style=a,this.resetStyle=!0,this.renew()},renew:function(){this._super();for(var a=0;a<this.oTexts.length;a++)this.oTexts[a].renew()},resize:function(){this._super(),this.renew()},getTextsInWindow:function(){var a=this.oTexts,b=[],c=a.length,d=this._map.getBounds(),e=d.sw.x,f=d.ne.x,g=d.sw.y,h=d.ne.y,i=gEcnu.Util.worldToScreen(e,h),j=gEcnu.Util.worldToScreen(f,g);e=i.x,f=j.x,g=i.y,h=j.y;for(var k=0;c>k;k++){var l=a[k],i=l.boxScrSize.xmin>e&&l.boxScrSize.xmin<f&&l.boxScrSize.ymax>g&&l.boxScrSize.ymax<h,m=l.boxScrSize.xmax>e&&l.boxScrSize.xmax<f&&l.boxScrSize.ymax>g&&l.boxScrSize.ymax<h,n=l.boxScrSize.xmin>e&&l.boxScrSize.xmin<f&&l.boxScrSize.ymin>g&&l.boxScrSize.ymin<h,i=l.boxScrSize.xmax>e&&l.boxScrSize.xmax<f&&l.boxScrSize.ymin>g&&l.boxScrSize.ymin<h;(i||m||n||i)&&b.push(l)}return b}}),gEcnu.Layer.Marker=gEcnu.Layer.extend({init:function(a,b){this._super(a,b),this.options={opacity:1,zIndex:20},this.options=gEcnu.Util.setOptions(this,b),this.id=a,this.oClass="markerLayer",this.oMarkers=[]},_initLayerContainer:function(a,b,c){var d=gEcnu.Util.createDiv(a,b,c,!0);this._layerContainer=d},addMarker:function(a){gEcnu.Util.isInArray(this.oMarkers,a)||(this.oMarkers.push(a),a.onAdd(this))},removeMarker:function(a){for(var b=[],c=0,d=0;c<this.oMarkers.length;c++)this.oMarkers[c]!=a?(b[d]=this.oMarkers[c],d++):this.oMarkers[c].onRemove(this);this.oMarkers=b,this.renew()},getAllMarkers:function(){return this.oMarkers},addMarkers:function(a){for(var b=(this.oMarkers,0);b<a.length;b++)this.addMarker(a[b])},removeMarkers:function(a){for(var b=a,c=b.length,d=0;c>d;d++){var e=b[d];this.removeMarker(e)}},removeAllMarkers:function(){var a=this.oMarkers;this.removeMarkers(a)},renew:function(){this._super();for(var a=0;a<this.oMarkers.length;a++)this.oMarkers[a].renew()},resize:function(){this._super(),this.renew()},getMarkersInWindow:function(){for(var a=this.oMarkers,b=[],c=a.length,d=this._map.getBounds(),e=0;c>e;e++){var f=a[e],g=d.sw.x,h=d.ne.x,i=d.sw.y,j=d.ne.y;f.x>g&&f.x<h&&f.y>i&&f.y<j&&b.push(f)}return b}}),gEcnu.Layer.Heatmap=gEcnu.Layer.Feature.extend({init:function(a,b){this._super(a,b),this.options={opacity:1,zIndex:19},this.options=gEcnu.Util.setOptions(this,b),this.oClass="heatmapLayer",this.heatmap={},this.multi=1},onAdd:function(a){this._super(a),this._map=a;var b=this._map.getContainer();this.heatmap=gHeatmap.create({container:b,canvas:this._layerContainer,radius:20})},setFtsData:function(a){this.data=a;var b=a.field,c=a.points,d=this.getScrFeatures(c),e={};void 0!=a.max&&(e.max=a.max),void 0!=a.min&&(e.min=a.min);for(var f=[],g=0,h=d.length;h>g;g++){var i=d[g].shape.Points[0].X,j=d[g].shape.Points[0].Y,k=gEcnu.Util.worldToScreen(i,j),l=d[g].fields[b],m={x:k.x,y:k.y,value:l};f.push(m)}e.data=f,this.heatmap.setData(e)},setData:function(a){this.data=a;var b=a.data,c={};void 0!=a.max&&(c.max=a.max),void 0!=a.min&&(c.min=a.min);for(var d=[],e=b.length;e--;){var f={},g=gEcnu.Util.worldToScreen(b[e].x,b[e].y);f.x=g.x,f.y=g.y,void 0!=b[e].value&&(f.value=b[e].value),void 0!=b[e].radius&&(f.radius=b[e].radius*this.multi),d.push(f)}c.data=d,this.heatmap.setData(c)},clearHeatmap:function(){this.heatmap.clear(),this.data=null},resize:function(){this._super(),this._layerContainer.width=this._map.w,this._layerContainer.height=this._map.h,this.renew()},zoomIn:function(){this.multi*=2,this.renew()},zoomOut:function(){this.multi*=.5,this.renew()},zoomAll:function(){this.multi=1,this.renew()},renew:function(){this._super(),console.log(this.data),this.data&&null!=this.data&&this.setData(this.data,this.multi)},getScrFeatures:function(a){var b=[],c=this._map,d=a.length;if(0>=d)return b;for(var e=0;d>e;e++){var f=a[e],g=f.shape.shpBox,h=g[0],i=g[1],j=g[2],k=g[3],l=c.getBounds(),m=l.nw.x,n=l.se.y,o=l.se.x,p=l.nw.y,q=h>=m&&o>h&&i>=n&&p>=i,r=h>=m&&o>h&&k>=n&&p>=k,s=j>=m&&o>j&&i>=n&&p>=i,t=j>=m&&o>j&&k>=n&&p>=k;(q||r||s||t)&&b.push(f)}return b}});var gSelf;gEcnu.Map=gClass.extend({init:function(a){gSelf=this,this._initContainer(a),this._initProp(),this.overLayer=new gEcnu.Layer.Overlay("overlay"),this.mLayer=new gEcnu.Layer.Marker("markerLayer"),this.addLayer(this.mLayer),this.addLayer(this.overLayer),this._initEvent(),this.activeLayer=null,document.ondragstart=function(){return!1}},_initContainer:function(a){this._container=document.getElementById(a),this.w=this._container.clientWidth,this.h=this._container.clientHeight,this._container.style.overflow="hidden"},_initProp:function(){this.oLayers=[],this.mode="map",this.mapTool="pan",this.dragging=!1,this.isTouch=!1,this.coordsFlag="PROJECTED",this.oLayers=[],this.cx=0,this.cy=0,this.zl=1,this.zl_pre=1,this.zoom=parseInt(1*this.w),this.ownDyn=!1,this.ownTile=!1,this.ownOther=!1,this.maxLevel=gEcnu.config.maxLevel,this.minLevel=gEcnu.config.minLevel,this.tileWidth=gEcnu.config.tileWidth,this.tileHeight=gEcnu.config.tileHeight,this.cusEvtArr=[],this.tileCount=0,this.disUnit="米",this.areaUnit="平方米",this.cursorStyle={pan:"default",dis:"default",area:"default",select:"default",addpoint:"default",delpoint:"default",mark:"default",draw:"default"},this.mapLeft=this._container.offsetLeft,this.mapTop=this._container.offsetTop,this.disMinus=0,this.pinchPt1,this.pinchPt2,this.startDis,this.endDis,this.startX=0,this.startY=0,this.startScrX=0,this.startSrcY=0,this.lengthPtArr=[],this.areaPtArr=[],this.oControls=[],this.resizeTimer=null,this.forbidPan_ex=!1,this.curScrPolys=[],this.tlr=5,this.serverURL=gEcnu.config.geoserver,this.webMapURL=this.serverURL+"WebMap",this.tileMapURL=gEcnu.config.tileMapURL+"TileMap",this.tileFileServer=gEcnu.config.tileMapURL+"FileServer?fn=",this.tileMapURL_Ex=gEcnu.config.tileMapURL_Ex+"webtilemap",this.fileServer_Ex=gEcnu.config.tileMapURL_Ex+"FileServer?fn=map/",this.fileServer=this.serverURL+"FileServer?fn="},_initEvent:function(){function a(a){"map"==gSelf.mode?l(a):gSelf.mousedblclickCustom(a)}function b(a){var a=a?a:window.event;if(window.event||a.preventDefault(),gSelf.tmpMapmode=gSelf.mode,gSelf.tmpMaptool=gSelf.mapTool,gEcnu.Util.ifctrl(a)&&(gSelf.mode="map",gSelf.mapTool="pan"),"map"==gSelf.mode&&"rulerLength"!=gSelf.mapTool&&"rulerArea"!=gSelf.mapTool){if(gSelf.forbidPan_ex)return gSelf.mode=gSelf.tmpMapmode,void(gSelf.mapTool=gSelf.tmpMaptool);c(a),document.onmousemove=function(a){return gSelf.forbidPan_ex?(gSelf.mode=gSelf.tmpMapmode,void(gSelf.mapTool=gSelf.tmpMaptool)):void e(a)},document.onmouseup=function(a){return gSelf.forbidPan_ex?(gSelf.mode=gSelf.tmpMapmode,void(gSelf.mapTool=gSelf.tmpMaptool)):(document.onmousemove=null,document.onmouseup=null,void g(a))}}else c(a),d(a);var b=gEcnu.Util.getMouseXY(gSelf._container,a),f=gEcnu.Util.screenToWorld(b.x,b.y),h={screenX:b.x,screenY:b.y,geoX:f.x,geoY:f.y};gSelf._mousedown_EX(a,h)}function c(a){if("map"==gSelf.mode)if("touchstart"==a.type&&2==a.touches.length){var b=gEcnu.Util.getTouchPt(a.touches[0]),c=gEcnu.Util.getTouchPt(a.touches[1]);gSelf.pinchPt1=b,gSelf.pinchPt2=c,gSelf.startDis=gEcnu.Util.p1top2Dis(b,c)}else{"pan"==gSelf.mapTool&&(gSelf.dragging=!0);var d,e;"touchstart"==a.type?(d=gEcnu.Util.getTouchXY(a),e=gEcnu.Util.getTouchPos(a)):(d=gEcnu.Util.getMouseXY(gSelf._container,a),e=gEcnu.Util.getMousePos(a)),gSelf.startX=d.x,gSelf.startY=d.y,gSelf.startScrX=e.x,gSelf.startScrY=e.y;for(var f=gSelf.getAllLayers(),g=0;g<f.length;g++)"tileLayer"==f[g].oClass?(f[g].startLeft=gEcnu.Util.delpx(f[g].baseMap.style.left),
f[g].startTop=gEcnu.Util.delpx(f[g].baseMap.style.top)):(f[g].startLeft=gEcnu.Util.delpx(f[g]._layerContainer.style.left),f[g].startTop=gEcnu.Util.delpx(f[g]._layerContainer.style.top))}}function d(a){gEcnu.Util.preventDefault(a),gEcnu.Util.stopPropagation(a),"map"==gSelf.mode?j(a):gSelf.mousedownCustom(a)}function e(a){if(gEcnu.Util.preventDefault(a),"map"==gSelf.mode&&"pan"==gSelf.mapTool){var b,c;if("touchmove"==a.type&&2==a.touches.length){var d=gEcnu.Util.getTouchPt(a.touches[0]),e=gEcnu.Util.getTouchPt(a.touches[1]);gSelf.pinchPt1=d,gSelf.pinchPt2=e,gSelf.endDis=gEcnu.Util.p1top2Dis(d,e),gSelf.disMinus=gSelf.endDis-gSelf.startDis}else if("touchmove"==a.type?(b=gEcnu.Util.getTouchXY(a),c=gEcnu.Util.getTouchPos(a),gSelf.endScrX=c.x,gSelf.endScrY=c.y):(b=gEcnu.Util.getMouseXY(gSelf._container,a),c=gEcnu.Util.getMousePos(a)),gSelf.currentX=b.x,gSelf.currentY=b.y,gSelf.dragging&&"pan"==gSelf.mapTool){var f=c.x-gSelf.startScrX,g=c.y-gSelf.startScrY,h=gSelf.getAllLayers();if(Math.abs(f)>0||Math.abs(g)>0)for(var i=0;i<h.length;i++)h[i].visible&&(h[i].onDrag(f,g),"dynLayer"==h[i].oClass&&gEcnu.Layer.Dyn._removeDynLoad(h[i]))}}}function f(a){if(gEcnu.Util.preventDefault(a),"map"==gSelf.mode){var b;b="touchmove"==a.type?gEcnu.Util.getTouchXY(a):gEcnu.Util.getMouseXY(gSelf._container,a);var c=gSelf.mapTool;switch(c){case"pan":gSelf.mLayer.getLayerContainer().style.cursor=gSelf.cursorStyle.pan;break;case"rulerLength":gSelf.mLayer.getLayerContainer().style.cursor=gSelf.cursorStyle.dis;break;case"rulerArea":gSelf.mLayer.getLayerContainer().style.cursor=gSelf.cursorStyle.area}gSelf.currentX=b.x,gSelf.currentY=b.y,k(a)}else gSelf.mousemoveCustom(a);var d=gEcnu.Util.getMouseXY(gSelf._container,a),e=gEcnu.Util.screenToWorld(d.x,d.y),f={screenX:d.x,screenY:d.y,geoX:e.x,geoY:e.y};gSelf._mousemove_EX(a,f)}function g(a){if("map"==gSelf.mode&&"pan"==gSelf.mapTool){var b,c;if(Math.abs(gSelf.disMinus)>0)gSelf.disMinus>0?gSelf.zoomIn():gSelf.zoomOut(),gSelf.disMinus=0;else if("touchend"==a.type?c={x:gSelf.endScrX,y:gSelf.endScrY}:(b=gEcnu.Util.getMouseXY(gSelf._container,a),c=gEcnu.Util.getMousePos(a)),"pan"==gSelf.mapTool){var d=c.x-gSelf.startScrX,e=c.y-gSelf.startScrY;if(Math.abs(d)>0||Math.abs(e)>0){var f=gSelf.getScreenCenter(),g=f.x-d,h=f.y-e,i=gEcnu.Util.screenToWorld(g,h);gSelf.setCenter(i.x,i.y);for(var j=gSelf.getAllLayers(),k=j.length,l=0;k>l;l++)"tileLayer"==j[l].oClass&&j[l].visible&&(j[l].xOffset=j[l].xOffset+d,j[l].yOffset=j[l].yOffset+e,j[l].baseMap.style.left=j[l].startLeft+d+"px",j[l].baseMap.style.top=j[l].startTop+e+"px"),j[l].visible&&j[l].renew();gSelf.dragging=!1,gSelf.zl_pre=gSelf.zl,gSelf._boundsChanged()}}}gSelf.mode=gSelf.tmpMapmode,gSelf.mapTool=gSelf.tmpMaptool}function h(a){"map"==gSelf.mode||gSelf.mouseupCustom(a);var b=gEcnu.Util.getMouseXY(gSelf._container,a),c=gEcnu.Util.screenToWorld(b.x,b.y),d={screenX:b.x,screenY:b.y,geoX:c.x,geoY:c.y};gSelf._mouseup_EX(a,d)}function i(a){gEcnu.Util.preventDefault(a),gSelf.forbidPan_ex||(clearTimeout(p),p=setTimeout(function(){if("map"==gSelf.mode&&"pan"==gSelf.mapTool){var b=a.wheelDelta||-a.detail;if(b>0){gSelf.zl_pre=gSelf.zl;var c=gEcnu.Util.getMouseXY(gSelf._container,a),d=gEcnu.Util.screenToWorld(c.x,c.y),e=(d.x-gSelf.cx)/2,f=(d.y-gSelf.cy)/2,g=d.x-e,h=d.y-f;gSelf.setCenter(g,h),gSelf.zoomIn(c)}else{var c=gEcnu.Util.getMouseXY(gSelf._container,a),d=gEcnu.Util.screenToWorld(c.x,c.y),e=2*(d.x-gSelf.cx),f=2*(d.y-gSelf.cy),g=d.x-e,h=d.y-f;gSelf.setCenter(g,h),gSelf.zoomOut(c)}}else gSelf.mousewheelCustom(a)},280))}function j(a){var b=gSelf.overLayer.getCtx();if("rulerLength"==gSelf.mapTool){var c=gEcnu.Util.screenToWorld(gSelf.startX,gSelf.startY);"GEOGRAPHIC"==gSelf.coordsFlag&&(c=gEcnu.Util.screenToWorld_geo(gSelf.startX,gSelf.startY));var d={x:c.x,y:c.y};gSelf.lengthPtArr.push(d),gSelf.lengthPtArr.length>1&&gEcnu.Util.drawCalPolyline(b,gSelf.lengthPtArr)}else if("rulerArea"==gSelf.mapTool){var c=gEcnu.Util.screenToWorld(gSelf.startX,gSelf.startY);"GEOGRAPHIC"==gSelf.coordsFlag&&(c=gEcnu.Util.screenToWorld_geo(gSelf.startX,gSelf.startY));var d={x:c.x,y:c.y};gSelf.areaPtArr.push(d),gSelf.areaPtArr.length>1&&gEcnu.Util.drawCalPolyline(b,gSelf.areaPtArr)}else gSelf.overLayer.clear()}function k(a){var b=gSelf.overLayer.getCtx();if("rulerLength"==gSelf.mapTool){if(gSelf.lengthPtArr.length>0){gSelf.overLayer.clear();var c={x:gSelf.lengthPtArr[gSelf.lengthPtArr.length-1].x,y:gSelf.lengthPtArr[gSelf.lengthPtArr.length-1].y},d=gEcnu.Util.worldToScreen(c.x,c.y);if("GEOGRAPHIC"==gSelf.coordsFlag&&(d=gEcnu.Util.worldToScreen_geo(c.x,c.y)),gEcnu.Util.drawLine(b,d.x,d.y,gSelf.currentX,gSelf.currentY),gEcnu.Util.drawCalPolyline(b,gSelf.lengthPtArr),1==gSelf.lengthPtArr.length){var e=0,f=gEcnu.Util.screenToWorld(gSelf.currentX,gSelf.currentY);"GEOGRAPHIC"==gSelf.coordsFlag&&(f=gEcnu.Util.screenToWorld_geo(gSelf.currentX,gSelf.currentY)),e=Math.sqrt((f.x-gSelf.lengthPtArr[0].x)*(f.x-gSelf.lengthPtArr[0].x)+(f.y-gSelf.lengthPtArr[0].y)*(f.y-gSelf.lengthPtArr[0].y));var g="当前距离："+gSelf.convertUnit("dis",Math.round(e)),h="总距离:"+gSelf.convertUnit("dis",Math.round(e));b.font=" 13px 幼圆",b.fillStyle="#fff",b.fillRect(gSelf.currentX,gSelf.currentY-40,180,50),b.strokeStyle="#eaeaea",b.lineWidth=1,b.strokeRect(gSelf.currentX,gSelf.currentY-40,180,50),b.fillStyle="blue",b.fillText(g,gSelf.currentX,gSelf.currentY-20),b.fillText(h,gSelf.currentX,gSelf.currentY)}else{var e=0,i=0,j=gSelf.lengthPtArr.length-1,e="",f=gEcnu.Util.screenToWorld(gSelf.currentX,gSelf.currentY);"GEOGRAPHIC"==gSelf.coordsFlag&&(f=gEcnu.Util.screenToWorld_geo(gSelf.currentX,gSelf.currentY)),e=Math.sqrt((f.x-gSelf.lengthPtArr[j].x)*(f.x-gSelf.lengthPtArr[j].x)+(f.y-gSelf.lengthPtArr[j].y)*(f.y-gSelf.lengthPtArr[j].y)),i=gEcnu.Util.getPolylineLength(gSelf.lengthPtArr),i+=e;var g="当前距离："+gSelf.convertUnit("dis",Math.round(e)),h="总距离:"+gSelf.convertUnit("dis",Math.round(i));b.font=" 13px 幼圆",b.fillStyle="#fff",b.fillRect(gSelf.currentX,gSelf.currentY-40,180,50),b.strokeStyle="#333",b.lineWidth=1,b.strokeRect(gSelf.currentX,gSelf.currentY-40,180,50),b.fillStyle="blue",b.fillText(g,gSelf.currentX+5,gSelf.currentY-20),b.fillText(h,gSelf.currentX+5,gSelf.currentY)}}}else if("rulerArea"==gSelf.mapTool&&gSelf.areaPtArr.length>0){gSelf.overLayer.clear();var k=gSelf.areaPtArr.length-1,d=gEcnu.Util.worldToScreen(gSelf.areaPtArr[k].x,gSelf.areaPtArr[k].y);if("GEOGRAPHIC"==gSelf.coordsFlag&&(d=gEcnu.Util.worldToScreen_geo(gSelf.areaPtArr[k].x,gSelf.areaPtArr[k].y)),gEcnu.Util.drawLine(b,d.x,d.y,gSelf.currentX,gSelf.currentY),gSelf.areaPtArr.length>1){gEcnu.Util.drawCalPolyline(b,gSelf.areaPtArr);var d=gEcnu.Util.worldToScreen(gSelf.areaPtArr[0].x,gSelf.areaPtArr[0].y);"GEOGRAPHIC"==gSelf.coordsFlag&&(d=gEcnu.Util.worldToScreen_geo(gSelf.areaPtArr[0].x,gSelf.areaPtArr[0].y)),gEcnu.Util.drawLine(b,d.x,d.y,gSelf.currentX,gSelf.currentY);var l=0,i=gEcnu.Util.getPolylineLength(gSelf.areaPtArr),m=gEcnu.Util.screenToWorld(gSelf.currentX,gSelf.currentY);"GEOGRAPHIC"==gSelf.coordsFlag&&(m=gEcnu.Util.screenToWorld_geo(gSelf.currentX,gSelf.currentY));var n=Math.sqrt((m.x-gSelf.areaPtArr[k].x)*(m.x-gSelf.areaPtArr[k].x)+(m.y-gSelf.areaPtArr[k].y)*(m.y-gSelf.areaPtArr[k].y)),o=Math.sqrt((m.x-gSelf.areaPtArr[0].x)*(m.x-gSelf.areaPtArr[0].x)+(m.y-gSelf.areaPtArr[0].y)*(m.y-gSelf.areaPtArr[0].y));l=i+n+o;var p;p=gSelf.areaPtArr.concat();var q={x:m.x,y:m.y};p.push(q);var r=gEcnu.Util.calcAreaMap(p),g="周长："+gSelf.convertUnit("dis",Math.round(l)),h="面积："+gSelf.convertUnit("area",r);b.font=" 13px 幼圆",b.fillStyle="#fff",b.fillRect(gSelf.currentX,gSelf.currentY-40,200,50),b.strokeStyle="#333",b.lineWidth=1,b.strokeRect(gSelf.currentX,gSelf.currentY-40,200,50),b.fillStyle="blue",b.fillText(g,gSelf.currentX+5,gSelf.currentY-20),b.fillText(h,gSelf.currentX+5,gSelf.currentY)}}}function l(a){var b=gSelf.overLayer.getCtx(),c="";if("rulerLength"==gSelf.mapTool){gSelf.lengthPtArr.pop();var d=gEcnu.Util.getPolylineLength(gSelf.lengthPtArr);gSelf.overLayer.clear(),gEcnu.Util.drawCalPolyline(b,gSelf.lengthPtArr);var e=gSelf.lengthPtArr.length,f=gEcnu.Util.worldToScreen(gSelf.lengthPtArr[e-1].x,gSelf.lengthPtArr[e-1].y);"GEOGRAPHIC"==gSelf.coordsFlag&&(f=gEcnu.Util.worldToScreen_geo(gSelf.lengthPtArr[e-1].x,gSelf.lengthPtArr[e-1].y));var g=f.x,h=f.y;gSelf.lengthPtArr=[],c="总距离："+gSelf.convertUnit("dis",Math.round(d)),b.font=" 13px 幼圆",b.fillStyle="#fff",b.strokeStyle="#333",b.lineWidth=1,b.fillRect(g,h-15,180,25),b.strokeRect(g,h-15,180,25),b.fillStyle="blue",b.fillText(c,g+5,h)}else if("rulerArea"==gSelf.mapTool){if(gSelf.areaPtArr.pop(),gSelf.areaPtArr.length<3)return alert("绘制节点至少三个！"),c;var d=gEcnu.Util.getPolylineLength(gSelf.areaPtArr),i=0,j=gSelf.areaPtArr.length-1,k=Math.sqrt((gSelf.areaPtArr[j].x-gSelf.areaPtArr[0].x)*(gSelf.areaPtArr[j].x-gSelf.areaPtArr[0].x)+(gSelf.areaPtArr[j].y-gSelf.areaPtArr[0].y)*(gSelf.areaPtArr[j].y-gSelf.areaPtArr[0].y));i=d+k;var l=gEcnu.Util.calcAreaMap(gSelf.areaPtArr);gSelf.overLayer.clear(),gEcnu.Util.drawCalPolyline(b,gSelf.areaPtArr);var m=gEcnu.Util.worldToScreen(gSelf.areaPtArr[0].x,gSelf.areaPtArr[0].y),n=gEcnu.Util.worldToScreen(gSelf.areaPtArr[j].x,gSelf.areaPtArr[j].y);"GEOGRAPHIC"==gSelf.coordsFlag&&(m=gEcnu.Util.worldToScreen_geo(gSelf.areaPtArr[0].x,gSelf.areaPtArr[0].y),n=gEcnu.Util.worldToScreen_geo(gSelf.areaPtArr[j].x,gSelf.areaPtArr[j].y)),gEcnu.Util.drawLine(b,m.x,m.y,n.x,n.y);var f=gEcnu.Util.worldToScreen(gSelf.areaPtArr[gSelf.areaPtArr.length-1].x,gSelf.areaPtArr[gSelf.areaPtArr.length-1].y);"GEOGRAPHIC"==gSelf.coordsFlag&&(f=gEcnu.Util.worldToScreen_geo(gSelf.areaPtArr[gSelf.areaPtArr.length-1].x,gSelf.areaPtArr[gSelf.areaPtArr.length-1].y)),gSelf.areaPtArr=[],c="周长："+Math.round(i)+"米；面积："+Math.round(l)+"平方米",returnLenArea1="周长："+gSelf.convertUnit("dis",Math.round(i)),returnLenArea2="面积："+gSelf.convertUnit("area",Math.round(l)),b.font=" 13px 幼圆",b.fillStyle="#fff",b.fillRect(f.x,f.y-40,200,50),b.strokeStyle="#333",b.lineWidth=1,b.strokeRect(f.x,f.y-40,200,50),b.fillStyle="blue",b.fillText(returnLenArea1,f.x+5,f.y-20),b.fillText(returnLenArea2,f.x+5,f.y)}return c}var m,n="ontouchstart",o=document.documentElement;m=0==gEcnu.Util.getIEVersion()?this.mLayer.getLayerContainer():this._container,n in o&&(m.ontouchstart=b,m.ontouchmove=f,m.ontouchend=h),gEcnu.Util.addEvtHandler(m,"mousedown",b),gEcnu.Util.addEvtHandler(m,"mousemove",f),gEcnu.Util.addEvtHandler(m,"mouseup",h),gEcnu.Util.addEvtHandler(m,"mousewheel",i),gEcnu.Util.addEvtHandler(m,"dblclick",a);var p},addLayer:function(a){var b=this.oLayers;gEcnu.Util.isObjInArray(b,a)||(a.onAdd(this),b.push(a))},removeLayer:function(a){var b=[],c=this.oLayers;this.ownTile=!1,this.ownOther=!1;for(var d=0,e=0;d<c.length;d++)c[d]!=a?(b[e]=c[d],"tileLayer"==b[e].oClass&&(this.ownTile=!0),"otherLayer"==b[e].oClass&&(this.ownOther=!0),e++):a.onRemove(this);this.oLayers=b},removeLayerById:function(a){var b=[],c=this.oLayers;this.ownTile=!1;for(var d=0,e=0;d<c.length;d++)c[d].id!=a?(b[e]=c[d],"tileLayer"==b[e].oClass&&(this.ownTile=!0),e++):c[d].onRemove(this);this.oLayers=b},getLayerById:function(a){var b=this.oLayers;console.log(a);for(var c=0;c<b.length;c++)if(b[c].id==a)return b[c]},addLayers:function(a){var b=this.oLayers;for(var c in a)gEcnu.Util.isObjInArray(b,a[c])||(a[c].onAdd(this),b.push(a[c]))},removeLayers:function(a){var b=[],c=this.oLayers;this.ownTile=!1;for(var d in a)for(var e=0,f=0;e<c.length;e++)c[e]!=a[d]?(b[f]=c[e],"tileLayer"==b[f].oClass&&(this.ownTile=!0),f++):a[d].onRemove(this);c=b},showLayer:function(a){a.show()},hideLayer:function(a){a.hide()},addControl:function(a){var b=this.getAllControls();gEcnu.Util.isObjInArray(b,a)||(a.onAdd(this),b.push(a))},getAllLayers:function(){return this.oLayers},getAllControls:function(){return this.oControls},showTipWin:function(a){var b=document,c=b.createElement("div");c.id="tipWinID",b.body.appendChild(c),$("#tipWinID").html(a),$("#tipWinID").css({position:"none",position:"absolute",left:"0px",top:"-50px",right:"0px",bottom:"0px",margin:"auto auto",width:"200px",height:"40px","border-radius":"20px","background-color":"#757575","text-align":"center","line-height":"40px","font-size":"15px",color:"#fff","z-index":"999999"}),$("#tipWinID").fadeIn(200).delay(600).fadeOut(200),setTimeout(function(){b.body.removeChild(c)},900)},zoomIn:function(a){var b=gSelf.coordsFlag,c=this.getAllLayers();if(this.ownOther)if("PROJECTED"==b){var d=gSelf.activeLayer.oMap.MaxLevel-this.zl;if(d>=gSelf.activeLayer.oMap.MaxLevel)return void this.showTipWin("已经放大至最大级别")}else{var e=Math.floor(10-Math.log(gSelf.zoom/(gSelf.activeLayer.otherPxScale*gSelf.w))/Math.log(2));if(e>=gSelf.activeLayer.oMap.MaxLevel)return void this.showTipWin("已经放大至最大级别")}this.zoom=this.zoom/2;var f=this.zl;this.zl_pre=f,this.zl--;for(var g=0;g<c.length;g++){var h=c[g];"tileLayer"==h.oClass&&(h.isInLevel()?h.visible||h.show():h.hide()),h.visible&&h.zoomIn(a)}for(var i=this.getAllControls(),j=0;j<i.length;j++)i[j].renew();gSelf._boundsChanged()},zoomOut:function(a){var b=gSelf.coordsFlag,c=this.getAllLayers();if(this.ownOther)if("PROJECTED"==b){var d=gSelf.activeLayer.oMap.MaxLevel-this.zl;if(d<=gSelf.activeLayer.oMap.Minlevel+1)return void alert("已经缩小至最小级别")}else{var e=Math.floor(10-Math.log(gSelf.zoom/(gSelf.activeLayer.otherPxScale*gSelf.w))/Math.log(2));if(e<=gSelf.activeLayer.oMap.Minlevel)return void alert("已经缩小至最小级别")}this.zoom=2*this.zoom;var f=this.zl;this.zl_pre=f,this.zl++;for(var g=0;g<c.length;g++){var h=c[g];"tileLayer"==h.oClass&&(console.log(h.getCurrentLevel(),h.isInLevel()),h.isInLevel()?h.visible||h.show():h.hide()),h.visible&&h.zoomOut(a)}for(var i=this.getAllControls(),j=0;j<i.length;j++)i[j].renew();gSelf._boundsChanged()},zoomIn_bak:function(a){var b=gSelf.coordsFlag,c=this.getAllLayers();if(this.ownOther)if("PROJECTED"==b){var d=gSelf.activeLayer.oMap.MaxLevel-this.zl;if(d>=gSelf.activeLayer.oMap.MaxLevel)return void this.showTipWin("已经放大至最大级别")}else{var e=Math.floor(10-Math.log(gSelf.zoom/(gSelf.activeLayer.otherPxScale*gSelf.w))/Math.log(2));if(e>=gSelf.activeLayer.oMap.MaxLevel)return void this.showTipWin("已经放大至最大级别")}this.zoom=this.zoom/2;var f=this.zl;this.zl_pre=f,this.zl--;for(var g=0;g<c.length;g++)c[g].visible&&c[g].zoomIn(a);for(var h=this.getAllControls(),i=0;i<h.length;i++)h[i].renew();gSelf._boundsChanged()},zoomOut_bak:function(a){var b=gSelf.coordsFlag,c=this.getAllLayers();if(this.ownOther)if("PROJECTED"==b){var d=gSelf.activeLayer.oMap.MaxLevel-this.zl;if(d<=gSelf.activeLayer.oMap.Minlevel+1)return void alert("已经缩小至最小级别")}else{var e=Math.floor(10-Math.log(gSelf.zoom/(gSelf.activeLayer.otherPxScale*gSelf.w))/Math.log(2));if(e<=gSelf.activeLayer.oMap.Minlevel)return void alert("已经缩小至最小级别")}this.zoom=2*this.zoom;var f=this.zl;this.zl_pre=f,this.zl++;for(var g=0;g<c.length;g++)c[g].visible&&c[g].zoomOut(a);for(var h=this.getAllControls(),i=0;i<h.length;i++)h[i].renew();gSelf._boundsChanged()},zoomTo:function(a,b,c){this.setCenter(a,b);var d=this.getAllLayers();if("undefined"==typeof c)for(var e=0;e<d.length;e++)d[e].zoomTo();else if(c.hasOwnProperty("zl")){var f=c.zl;this.tileCount>0&&(f<gEcnu.config.minLevel?f=gEcnu.config.minLevel:f>gEcnu.config.maxLevel&&(f=gEcnu.config.maxLevel)),this.zl=f;var g=Math.pow(2,this.zl-1),h=this._container.clientWidth;this.zoom=g*h;for(var e=0;e<d.length;e++)d[e].zoomTo()}else if(c.hasOwnProperty("zoom")){this.zoom=c.zoom,_zoom=c.zoom;var h=this._container.clientWidth,g=_zoom/h,f=parseInt(Math.log(g)/Math.log(2))+1;this.tileCount>0&&(f<gEcnu.config.minLevel?f=gEcnu.config.minLevel:f>gEcnu.config.maxLevel&&(f=gEcnu.config.maxLevel));var g=Math.pow(2,f-1),i=g*h;this.zl=f,this.zoom=i;for(var e=0;e<d.length;e++)d[e].zoomTo()}for(var j=this.getAllControls(),k=0;k<j.length;k++)j[k].renew();gSelf._boundsChanged()},resize:function(){var a=this.w,b=this.zoom,c=b/a,d=(this.h,this._container.clientWidth),e=this._container.clientHeight;this.zoom=c*d;var f=gEcnu.Util.screenToWorld(d/2,e/2);this.cx=f.x,this.cy=f.y,this.w=d,this.h=e;for(var g=this.getAllLayers(),h=0;h<g.length;h++)g[h].resize();for(var i=this.getAllControls(),j=0;j<i.length;j++)i[j].renew();gSelf._boundsChanged()},getContainer:function(){return this._container},getSize:function(){return{w:this.w,h:this.h}},getZoom:function(){return{z:this.zoom,zl:this.zl}},getPreZl:function(){return this.zl_pre},setZoom:function(a){this.zoom=a},setZoomLevel:function(a){},getCenter:function(){return{x:this.cx,y:this.cy}},clearOverlay:function(){this.overLayer.clear()},forbidPan:function(){this.forbidPan_ex=!0},activePan:function(){this.forbidPan_ex=!1},setCenter:function(a,b){this.cx=a,this.cy=b},getScreenCenter:function(){return{x:this.w/2,y:this.h/2}},getBounds:function(){var a=this.getCenter(),b=this.getSize(),c=this.getZoom(),d=a.x-c.z/2,e=a.x+c.z/2,f=c.z/b.w,g=a.y-b.h*f/2,h=a.y+b.h*f/2;return{nw:{x:d,y:h},ne:{x:e,y:h},sw:{x:d,y:g},se:{x:e,y:g}}},getMode:function(){return this.mode},setMode:function(a){this.mode=a},getMapTool:function(){return this.mapTool},setMapTool:function(a){this.mapTool=a},setCursorStyle:function(a,b){this.cursorStyle[a]="url('"+b+"'),default"},events:{on:function(a,b){switch(a){case"boundsChanged":gEcnu.Map.prototype._boundsChanged_EX=function(a){b(a)};break;case"mousedown":gEcnu.Map.prototype._mousedown_EX=function(a,c){b(a,c)};break;case"mousemove":gEcnu.Map.prototype._mousemove_EX=function(a,c){b(a,c)};break;case"mouseup":gEcnu.Map.prototype._mouseup_EX=function(a,c){b(a,c)}}}},_boundsChanged:function(){for(var a=this.getAllControls(),b=0;b<a.length;b++)"eagleMapControl"==a[b].oClass&&a[b].renew();if(arguments.length>0){var c=arguments[0];this._boundsChanged_EX(c)}else this._boundsChanged_EX()},_boundsChanged_EX:function(){},_mousedown_EX:function(a,b){},_mousemove_EX:function(a,b){},_mouseup_EX:function(a,b){},mousedownCustom:function(a){gEcnu.Edit.graphMouseDownEvt(a,gSelf)},mousemoveCustom:function(a){gEcnu.Edit.graphMouseMoveEvt(a,gSelf)},mouseupCustom:function(a){gEcnu.Edit.graphMouseUpEvt(a,gSelf)},mousewheelCustom:function(a){},mousedblclickCustom:function(a){gEcnu.Edit.graphMouseDblClickEvt(a,gSelf)},setProjCoordsFlag:function(){gSelf.coordsFlag="PROJECTED"},setGeoCoordsFlag:function(){gSelf.coordsFlag="GEOGRAPHIC"},setRulerUnit:function(a){this.disUnit=a.disUnit||"米",this.areaUnit=a.areaUnit||"平方米"},convertUnit:function(a,b){var c=this.disUnit,d=this.areaUnit;if("dis"==a)switch(c){case"千米":return b/1e3+"千米";case"公里":return b/1e3+"公里";default:return b+"米"}else switch(d){case"平方千米":return(b/1e6).toFixed(2)+"平方千米";case"平方公里":return(b/1e6).toFixed(2)+"平方公里";case"亩":return(.0015*b).toFixed(2)+"亩";case"公顷":return(b/1e4).toFixed(2)+"公顷";default:return b.toFixed(2)+"平方米"}},saveImageToScale:function(a,b,c,d){var e=gSelf,f=this;this.printScale=b,this.MAXWIDTH=2e3,this.MAXHEIGHT=2e3,this.MINWIDTH=100,this.MINHEIGHT=100;var g=(this.webMapURL,d?d:"上海市1："+b+"用地数据");this._printTitle=g;var h=document.getElementById(a);h.innerHTML="",h.style.display="block";var i=gEcnu.Util.getMapParamByScale(e,b,c),j=i.w,k=i.h,l=i.cx,m=i.cy,n=i.zoom,o="",p="",q=this.getAllLayers();this.outerDiv=h;for(var r=0,s=q.length;s>r;r++)"dynLayer"==q[r].oClass&&(o=q[r].getAllVisibleLyrs().join(","),p=q[r].ws);this._createPrintDiv(h,j,k);var t,u,v=this.imgDiv,w=l-n/2,x=m+n/j*k/2,y=1,z=1;if(j>this.MAXWIDTH){var A=parseInt(j%this.MAXWIDTH);A<this.MINWIDTH?(y=parseInt(j/this.MAXWIDTH),t=this.MAXWIDTH+A):(y=Math.ceil(j/this.MAXWIDTH),t=A)}else t=j;if(k>this.MAXHEIGHT){var B=k%this.MAXHEIGHT;B<this.MINHEIGHT?(z=parseInt(k/this.MAXHEIGHT),u=this.MAXHEIGHT+B):(z=Math.ceil(k/this.MAXHEIGHT),u=B)}else u=k;var C=n/j*this.MAXWIDTH,D=n/j*this.MAXHEIGHT,E=z*y;this.dynImgCount=0,this.totalDynImgNum=E;var r=0,F=document.createElement("img"),G=function(){if(!(r>=E)){var a=Math.floor(r/y),b=Math.floor(r%y),c=(a*f.MAXHEIGHT,b*f.MAXWIDTH,F.cloneNode());if(c.style.position="absolute",c.setAttribute("crossOrigin","anonymous"),c.style.left=b*f.MAXWIDTH+"px",c.style.top=a*f.MAXHEIGHT+"px",v.appendChild(c),b!=y-1)var d=C,e=f.MAXWIDTH;else var e=t,d=n/j*e;if(a!=z-1)var g=f.MAXHEIGHT,h=D;else var g=u,h=n/j*g;var i=w+C*b+d/2,k=x-(D*a+h/2);c.setAttribute("cx",parseInt(i)),c.setAttribute("cy",parseInt(k));var l={map:p,w:e,h:g,mt:"zoomto",cx:i,cy:k,zoom:d,"return":"json",lyrs:o};f._reqImageByScale(l,c,v),r++,r>=E||G()}};G()},_createPrintDiv:function(a,b,c){var d=this,e=gEcnu.Util.createDiv("printBtnDiv",300,40,!1),f=document.createElement("input");f.type="button",f.style.width="60px",f.style.height="28px",f.style.marginLeft="30px";var g=f.cloneNode(),h=f.cloneNode(),i=f.cloneNode();g.value="打印",i.value="导出",h.value="关闭",e.style.lineHeight="40px",e.appendChild(h),e.appendChild(i),e.appendChild(g),a.appendChild(e);var j=parseInt(b+104),k=parseInt(c+40+4+20+20+30+10),l=gEcnu.Util.createDiv("_printDiv",j,k,!1);l.style.position="relative",l.style.left="30px",l.style.textAlign="center",l.style.border="2px solid #000",l.style.margin="0 auto",l.style.backgroundColor="#fff";var m=gEcnu.Util.createDiv("_printTitleDiv",b,50,!1);m.style.position="relative",m.innerHTML=this._printTitle,m.style.lineHeight="100px",m.style.margin="0 auto",m.style.textAlign="center",m.style.fontSize="1.3em",m.style.color="#333",m.style.fontWeight="bold";var n=gEcnu.Util.createDiv("_printMapDiv",b,c,!1);n.style.position="relative",n.style.top="25px",n.style.margin="0 auto",n.style.border="1px solid #555";var o=document.createElement("img"),p=gEcnu.Util.createCanvas("canvas2Drawing",b,c,!0),q=gEcnu.Util.createDiv("tmpImgContainer",b,c,!0),r=o.cloneNode(),s=p.getContext("2d");this._dynctx=s,this.cavasImg_export=r,this.cavas=p,this.imgDiv=q,this.printDiv=l;var t=gEcnu.Util.createDiv("_legendDiv",114,460,!0);t.style.backgroundColor="rgba(255,255,255,0.6)",t.style.left="2px",t.style.top="2px";var u=o.cloneNode();u.src="imgs/legend_print.png",t.style.zIndex="11111",t.appendChild(u),n.appendChild(t),q.style.display="block",q.style.left="0px",q.style.top="0px",p.style.left="0px",p.style.top="0px",r.style.position="absolute",r.style.left="0px",r.style.top="0px",r.id="export_img",r.style.width=b+"px",r.style.height=c+"px",r.style.zIndex=100,n.appendChild(q),n.appendChild(p),n.appendChild(r);var v=gEcnu.Util.createDiv("_scaleDiv",200,30,!1);v.innerHTML="比例尺  1:"+this.printScale,v.style.marginLeft="50px",v.style.marginTop="35px",v.style.fontSize="1em",v.style.fontWeight="bold",v.style.color="#333";var w=gEcnu.Util.createDiv("_infoDiv",500,30,!0),x=gEcnu.Util.getTimeInfo(),y=x.year,z=x.month,A=x.day;w.innerHTML="《上海市农业布局动态管理模式研究》课题组\n\n  "+y+"年"+z+"月"+A+"日",w.style.bottom="5px",w.style.right="50px",w.style.fontSize="1em",w.style.fontWeight="bold",w.style.color="#333",l.appendChild(m),l.appendChild(n),l.appendChild(v),l.appendChild(w),a.appendChild(l),h.onclick=function(){a.style.display="none"},g.onclick=function(){$("#_printDiv").jqprint(),i.onclick=null,g.onclick=null,h.onclick=null,d.outerDiv.style.display="none"},b*c>4e6&&(i.disabled="disabled"),i.onclick=function(){var a=d.cavas.toDataURL("image/png");d._downloadScaleImg(a),d.outerDiv.style="none"}},_reqImageByScale:function(a,b,c){var d=this,e=this.webMapURL;try{gEcnu.Util.ajax("get",e,a,!0,function(b){if(b=JSON.parse(b),!b.mapURL)return void alert("地图请求失败！");var e=(a.lyrs.toLowerCase(),b.visibleLayers.toLowerCase(),parseInt(a.zoom,10),parseInt(b.mapZoom,10),Math.round(a.cx),Math.round(a.cy),Math.round(b.centerX)),f=Math.round(b.centerY),g=d.getFitedImg(c,e,f);g.src=d.fileServer+b.mapURL,g.onload=function(){if(d.dynImgCount++,d.dynImgCount>=d.totalDynImgNum){d.drawImageOnCavs(d._dynctx,c);var a=d.cavas.toDataURL("image/png");a.replace("image/png","image/octet-stream");d.cavasImg_export.setAttribute("crossOrigin","anonymous"),d.cavasImg_export.src=a}}})}catch(f){}},_downloadScaleImg:function(a){var b=document.createElement("a");b.href=a,b.download=this._printTitle+".png",b.click()},getFitedImg:function(a,b,c){for(var d=a.getElementsByTagName("img"),e=0,f=d.length;f>e;e++){var g=d[e],h=g.getAttribute("cx"),i=g.getAttribute("cy");if(Math.abs(h-b)<5&&Math.abs(i-c)<5)return g}},drawImageOnCavs:function(a,b){for(var c=b.getElementsByTagName("img"),d=0,e=c.length;e>d;d++){var f=c[d],g=gEcnu.Util.delpx(gEcnu.Util.getEleStyle(f,"left")),h=gEcnu.Util.delpx(gEcnu.Util.getEleStyle(f,"top"));a.drawImage(f,g,h)}}}),gEcnu.Graph={},gEcnu.Graph.drawPoint=function(a,b){a.beginPath(),a.arc(b.x,b.y,4,0,2*Math.PI,!0),a.closePath(),a.fill()},gEcnu.Graph.drawLine=function(a,b,c){a.beginPath(),a.moveTo(b.x,b.y),a.lineTo(c.x,c.y),a.closePath(),a.stroke()},gEcnu.Graph.drawPoint_geo=function(a,b){var c=gEcnu.Util.worldToScreen(b.x,b.y);a.beginPath(),a.arc(c.x,c.y,3,0,2*Math.PI,!0),a.closePath(),a.fill()},gEcnu.Graph.drawLine_geo=function(a,b,c){var d=gEcnu.Util.worldToScreen(b.x,b.y),e=gEcnu.Util.worldToScreen(c.x,c.y);a.beginPath(),a.moveTo(d.x,d.y),a.lineTo(e.x,e.y),a.closePath(),a.stroke()},gEcnu.Graph.drawPoints=function(a,b){for(var c=0;c<b.length;c++){var d={x:b[c].x,y:b[c].y};this.drawPoint(a,d)}},gEcnu.Graph.drawLines=function(a,b){b.length;a.beginPath();var c={x:b[0].x,y:b[0].y};a.moveTo(c.x,c.y);for(var d=1;d<b.length;d++)c={x:b[d].x,y:b[d].y},a.lineTo(c.x,c.y);a.stroke()},gEcnu.Graph.drawPoints_geo=function(a,b){for(var c=0;c<b.length;c++){var d=gEcnu.Util.worldToScreen(b[c].x,b[c].y);this.drawPoint(a,d)}},gEcnu.Graph.drawLines_geo=function(a,b){b.length;a.beginPath();var c=gEcnu.Util.worldToScreen(b[0].x,b[0].y);a.moveTo(c.x,c.y);for(var d=1;d<b.length;d++)c=gEcnu.Util.worldToScreen(b[d].x,b[d].y),a.lineTo(c.x,c.y);a.stroke()},gEcnu.Graph.catchPoint=function(a,b){var c="false",d=3;if(0==b.length)return c;for(var e=0;e<b.length;e++){var f=b[e]._lineStrings;if("undefined"==typeof f)var g=b[e]._lineRings;else var g=b[e]._lineStrings;for(var h=0;h<g.length;h++)for(var i=g[h].points,j=i.length,k=0;j>k;k++){var l=i[k],m=gEcnu.Util.worldToScreen(l.x,l.y),n=Math.sqrt((a.x-m.x)*(a.x-m.x)+(a.y-m.y)*(a.y-m.y));if(d>=n&&(a.x=m.x,a.y=m.y,"false"==c))return c="true|"+a.x+","+a.y+","+l.x+","+l.y+"|"+h+","+k}}return c},gEcnu.Graph.catchLine=function(a,b){for(var c=a.x,d=a.y,e=3,f="false",g=gEcnu.Util.screenToWorld(c,d),h=g.x,i=g.y,j=b.length,k=0;j>k;k++){var l=b[k]._lineStrings;if("undefined"==typeof l)var m=b[k]._lineRings;else var m=b[k]._lineStrings;for(var n=0;n<m.length;n++)for(var o=m[n].points,p=o.length,q=0;p>q;q++){var r=o[q];if(p-1>q){var s=o[q+1],t=gEcnu.Util.worldToScreen(r.x,r.y),u=r.x,v=r.y,w=gEcnu.Util.worldToScreen(s.x,s.y),x=s.x,y=s.y,z=Math.min(u,x),A=Math.max(u,x),B=Math.min(v,y),C=Math.max(v,y);if(u!=x&&v!=y){var D=(y-v)/(x-u),E=-1/D,F=v-D*u,G=i-E*h,H=(G-F)/(D-E),I=D*H+F;if(H>z&&A>H&&I>B&&C>I){var J=(w.y-t.y)/(w.x-t.x),K=-1/J,L=t.y-J*t.x,M=d-K*c,N=(M-L)/(J-K),O=J*N+L,P=Math.sqrt((c-N)*(c-N)+(d-O)*(d-O));if(e>P){f="true|"+N+","+O+","+H+","+I+"|"+t.x+","+t.y+"|"+w.x+","+w.y+"|"+n+","+q+","+k;break}}}if(u==x){var H=t.x,I=d,Q=gEcnu.Util.screenToWorld(H,I);if(u>=z&&A>=u&&Q.y>=B&&Q.y<=C){var P=Math.abs(H-c);if(e>P){f="true|"+H+","+I+","+u+","+Q.y+"|"+t.x+","+t.y+"|"+w.x+","+w.y+"|"+n+","+q+","+k;break}}}if(v==y){var H=c,I=t.y,Q=gEcnu.Util.screenToWorld(H,I);if(Q.x>=z&&Q.x<=A&&v>=B&&C>=v){var P=Math.abs(d-I);if(e>P){f="true|"+H+","+I+","+Q.x+","+v+"|"+t.x+","+t.y+"|"+w.x+","+w.y+"|"+n+","+q+","+k;break}}}}}}return f},gEcnu.Graph.pointInPoly=function(a,b){for(var c=!1,d=-1,e=b.length,f=e-1;++d<e;f=d)(b[d].y<=a.y&&a.y<b[f].y||b[f].y<=a.y&&a.y<b[d].y)&&a.x<(b[f].x-b[d].x)*(a.y-b[d].y)/(b[f].y-b[d].y)+b[d].x&&(c=!c);return c},gEcnu.Graph.pointJionLine=function(a,b){var c=b.length,d=!1;return 0>=c?d:d},gEcnu.Geometry=gClass.extend({init:function(a){this.name=a},getVertices:function(){},getBounds:function(){},calcBounds:function(){}}),gEcnu.Geometry.Point=gClass.extend({init:function(a,b){this.x=a,this.y=b,this.className="point"}}),gEcnu.Geometry.LineString=gEcnu.Geometry.extend({init:function(a){this.className="line",this.points=[];for(var b=0;b<a.length;b++){var c=a[b];c instanceof gEcnu.Geometry.Point?this.points.push(c):alert("初始化节点失败！")}},addPoint:function(a,b){var c=/^\d+$/;c.test(b)?this.points.splice(b,0,a):this.points.push(a)},delPoint:function(a){this.points.splice(a,1)},removePoint:function(a){for(var b=0;b<this.points.length;b++)if(this.points[b]==a){this.points.splice(b,1);break}},getLength:function(){for(var a=this.points.length,b=0,c=0;a-1>c;c++){var d=Math.sqrt((this.points[c].x-this.points[c+1].x)*(this.points[c].x-this.points[c+1].x)+(this.points[c].y-this.points[c+1].y)*(this.points[c].y-this.points[c+1].y));b+=d}return b}}),gEcnu.Geometry.LinearRing=gEcnu.Geometry.LineString.extend({init:function(a){var b=a.length;if(2>=b)return void alert("组成多边形节点个数不足！");this._super(a),this.className="polygon";var c=a[0];this.points.push(c)},addPoint:function(a,b){this.points.splice(b,0,a)},delPoint:function(a){if(4==this.points.length)return void alert("节点数低于3个，不能删除！");if(this.points.splice(a,1),0==a){this.points.pop();var b=this.points[0];this.points.push(b)}},getCenterPoint:function(){for(var a=this.points,b=a.length,c=0,d=0,e=0;b>e;e++)c+=a[e].x,d+=a[e].y;var f=c/b,g=d/b,h=new gEcnu.Geometry.Point(f,g);return h},getArea:function(){for(var a=0,b=this.points,c=0;c<b.length;c++)a+=b[c].x*b[(c+1)%b.length].y-b[(c+1)%b.length].x*b[c].y;var d=parseInt(Math.abs(.5*a));return d}}),gEcnu.Geometry.RectRing=gEcnu.Geometry.LineString.extend({init:function(a){var b=a.length;return 4>b?void alert("组成矩形节点个数不足！"):(this._super(a),void(this.className="rect"))},addPoint:function(a,b){this.points.splice(b,0,a)},delPoint:function(a){if(4==this.points.length)return void alert("节点数低于3个，不能删除！");if(this.points.splice(a,1),0==a){this.points.pop();var b=this.points[0];this.points.push(b)}},getArea:function(){for(var a=0,b=this.points,c=0;c<b.length;c++)a+=b[c].x*b[(c+1)%b.length].y-b[(c+1)%b.length].x*b[c].y;var d=parseInt(Math.abs(.5*a));return d}}),gEcnu.Geometry.RadiusRing=gEcnu.Geometry.extend({init:function(a,b){this.radius=b,this.centerPoint=a,this.className="radius"},getArea:function(){return 6.28318*this.radius*this.radius}}),gEcnu.Feature=gClass.extend({init:function(a){this.name=a},getVertices:function(){},getBounds:function(){},calcBounds:function(){}}),gEcnu.Feature.Point=gEcnu.Feature.extend({init:function(a,b){this._gpoints=a,this.shape={},this.shape.shpType=8,this.shape.shpBox=gEcnu.Util.getShpBox(a);var c=a.length;this.shape.NumPoints=c,this.shape.Points=[];for(var d=0;c>d;d++){var e=a[d],f={X:e.x,Y:e.y};this.shape.Points.push(f)}this.fields={},"object"==typeof b&&(this.fields=b)},onAdd:function(a){this._layer=a,this.onDraw(a)},onRemove:function(a){},addFields:function(a){for(var b in a)this.fields[b]=a[b]},delFields:function(a){for(var b=a.length,c=0;b>c;c++){var d=a[c];delete this.fields[d]}},delAllFields:function(){this.fields={}},onDraw:function(a){var b=a.getCtx(),c=a.style;a.resetStyle;if(c instanceof gEcnu.Style_Ex){var d=c.mappingField,e=this.fields,f="default";for(var g in e)if(g==d){f=e[g];break}for(var h=c.styles,i=h.length,j=0;i>j;j++){var k=h[j];k.mappingValue!=f||(this.style=k)}}else{if(!(c instanceof gEcnu.Style))return void alert("style样式有问题！");this.style=c}"undefined"==typeof this.style&&(this.style=new gEcnu.Style({}));for(var l=(gEcnu.Util.setStyle(b,this.style),a.getMap(),this.shape.NumPoints),m=0;l>m;m++){var n=this._gpoints[m],o=gEcnu.Util.worldToScreen(n.x,n.y);b.beginPath(),b.arc(o.x,o.y,this.style.cirRadius,0,2*Math.PI),b.stroke()}var p=this.style.fillColor;p=p.replace(/(^\s*)|(\s*$)/g,""),""!=p&&b.fill()},onSelect:function(){var a=this._gpoints,b=gSelf;null!=gEcnu.Edit.selectedPoint&&(gEcnu.Edit.selectedPoint=null,b.overLayer.clear());var c=new gEcnu.Style({cirRadius:6,opacity:1,fillColor:"#00FFFF",strokeColor:"#00FFFF",lineWeight:1});b.overLayer.setStyle(c);var d=b.overLayer._ctx;gEcnu.Util.setStyle(d,c),gEcnu.Graph.drawPoints_geo(d,a)},highLight:function(a,b,c){var d=this,e=this,b=(d.shape.shpType,arguments.length>1?arguments[1]:{isTwinkle:!1}),f=arguments.length>2?arguments[2]:{radius:6,isFill:!0,fillColor:"red",strokeColor:"red"},g=f.radius||6,h=void 0!=f.isFill?f.isFill:!0;if(h)var i=f.fillColor||"red";else var i="";var j=f.strokeColor||"red",k=b.isTwinkle,l=parseInt(b.twinkleCount)||3,m=parseInt(b.twinkleInterval)||1e3;
if(k)var n=0,o=setInterval(function(){return n>=2*l-1?void window.clearInterval(o):(n%2==0?e._drawHighlightFea(a,g,i,j):a.removeAllFeatures(),void n++)},m);else e._drawHighlightFea(a,g,i,j)},_drawHighlightFea:function(a,b,c,d){var e=this,f=new gEcnu.Style({cirRadius:b,opacity:.5,fillColor:c,strokeColor:d});a.setStyle(f),a.addFeature(e)},getLayer:function(){return this._layer},getGeometrys:function(){return this._gpoints}}),gEcnu.Feature.Polyline=gEcnu.Feature.extend({init:function(a,b){this.shape={},this.shape.shpType=3,this._lineStrings=a;var c=a.length,d=[];this.shape.Parts=[];for(var e=0;c>e;e++){var f=a[e].points,g=d.length;this.shape.Parts.push(g),d=d.concat(f)}this.shape.shpBox=gEcnu.Util.getShpBox(d);var h=d.length;this.shape.NumPoints=h,this.shape.NumParts=c,this.shape.Points=[];for(var i=0;h>i;i++){var j=d[i],l={x:j.x,y:j.y};this.shape.Points.push(l)}if(this.fields={},"object"==typeof b)for(k in b)this.fields[k]=b[k];this._data=this.fields},onAdd:function(a){this._layerID=a.id,this.onDraw(a)},onRemove:function(a){},addFields:function(a){for(var b in a)this.fields[b]=a[b]},delFields:function(a){for(var b=a.length,c=0;b>c;c++){var d=a[c];delete this.fields[d]}},delAllFields:function(){this.fields={}},onDraw:function(a){var b=a.getCtx(),c=a.style;a.resetStyle;if(c instanceof gEcnu.Style_Ex){var d=c.mappingField,e=this.fields,f="default";for(var g in e)if(g==d){f=e[g];break}for(var h=c.styles,i=h.length,j=!1,k=0;i>k;k++){var l=h[k];l.mappingValue!=f||(this.style=l,j=!0)}if(!j){var m=new gEcnu.Style({});this.style=m}}else{if(!(c instanceof gEcnu.Style))return void alert("style样式有问题！");this.style=c}"undefined"==typeof this.style&&(this.style=new gEcnu.Style({}));for(var n=(gEcnu.Util.setStyle(b,this.style),a.getMap(),this.shape.NumParts),o=0;n>o;o++){var p=this._lineStrings[o],q=p.points.length;if(q>=2){b.beginPath();var r=gEcnu.Util.worldToScreen(p.points[0].x,p.points[0].y);b.moveTo(r.x,r.y);for(var s=1;q>s;s++)r=gEcnu.Util.worldToScreen(p.points[s].x,p.points[s].y),b.lineTo(r.x,r.y)}b.stroke()}},onSelect:function(){var a=this._lineStrings.length,b=gSelf;b.overLayer.clear();for(var c=0;a>c;c++){var d=this._lineStrings[c].points,e=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"#118811",strokeColor:"#118811",lineWeight:1});b.overLayer.setStyle(e);var f=b.overLayer._ctx;gEcnu.Util.setStyle(f,e),gEcnu.Graph.drawPoints_geo(f,d);var g=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});b.overLayer.setStyle(g);var f=b.overLayer._ctx;gEcnu.Util.setStyle(f,g),gEcnu.Graph.drawLines_geo(f,d)}},onSelect_ex:function(){var a=this._lineStrings.length,b=gSelf;null!=gEcnu.Edit.selectedLine&&(gEcnu.Edit.selectedLine=null,b.overLayer.clear());for(var c=0;a>c;c++){var d=this._lineStrings[c].points,e=b.overLayer._ctx,f=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});b.overLayer.setStyle(f);var e=b.overLayer._ctx;gEcnu.Util.setStyle(e,f),gEcnu.Graph.drawLines_geo(e,d)}},highLight:function(a,b,c){var d=this,e=this,b=(d.shape.shpType,arguments.length>1?arguments[1]:{isTwinkle:!1}),f=arguments.length>2?arguments[2]:{strokeColor:"red",lineWeight:2},g=f.strokeColor||"red",h=f.lineWeight||2,i=b.isTwinkle,j=b.twinkleCount||3,k=parseInt(b.twinkleInterval)||1e3;if(i)var l=0,m=setInterval(function(){return l>=2*j-1?void window.clearInterval(m):(l%2==0?e._drawHighlightFea(a,g,h):a.removeAllFeatures(),void l++)},k);else e._drawHighlightFea(a,g,h)},_drawHighlightFea:function(a,b,c){var d=this,e=new gEcnu.Style({opacity:.5,strokeColor:b,lineWeight:c});a.setStyle(e),a.addFeature(d)},getLayer:function(){return this._layerID},getGeometrys:function(){return this._lineStrings}}),gEcnu.Feature.Polygon=gEcnu.Feature.extend({init:function(a,b){this.shape={},this.shape.shpType=5,this._lineRings=a;var c=a.length,d=[];this.shape.Parts=[];for(var e=0;c>e;e++){var f=a[e].points,g=d.length;this.shape.Parts.push(g),d=d.concat(f)}this.shape.shpBox=gEcnu.Util.getShpBox(d);var h=d.length;this.shape.NumPoints=h,this.shape.NumParts=c,this.shape.Points=[];for(var i=0;h>i;i++){var j=d[i],l={x:j.x,y:j.y};this.shape.Points.push(l)}if(this.fields={},"object"==typeof b)for(k in b)this.fields[k]=b[k];this._data=this.fields},onAdd:function(a){this._layerID=a.id,this.onDraw(a)},onRemove:function(a){},addFields:function(a){for(var b in a)this.fields[b]=a[b]},delFields:function(a){for(var b=a.length,c=0;b>c;c++){var d=a[c];delete this.fields[d]}},delAllFields:function(){this.fields={}},onDraw:function(a){var b=a.getCtx(),c=a.style;a.resetStyle;if(c instanceof gEcnu.Style_Ex){var d=c.mappingField,e=this.fields,f="default";for(var g in e)if(g==d){f=e[g];break}for(var h=c.styles,i=h.length,j=0;i>j;j++){var k=h[j];k.mappingValue!=f||(this.style=k)}}else{if(!(c instanceof gEcnu.Style))return void alert("style样式有问题！");this.style=c}"undefined"==typeof this.style&&(this.style=new gEcnu.Style({}));var l=gEcnu.Util.setStyle(b,this.style);a.getMap();b.globalAlpha=1;var m=this.shape.NumParts,n=parseInt(gEcnu.Util.getOuterPolyIndex(this._lineRings)),o=this._lineRings[n],p=this._lineRings[n].points,q=gEcnu.Util.isClockWise(this._lineRings[n].points);this._lineRings.splice(n,1),this._lineRings.unshift(o);for(var r=0;m>r;r++){var s=this._lineRings[r],t=s.points.length,u="normal";if(r!=n){var v=gEcnu.Util.isPolyInPoly(s.points,p);if(v){var w=gEcnu.Util.isClockWise(s.points);u=q&&!w||!q&&w?"hole":"island"}}if(t>=2){b.beginPath();var x=gEcnu.Util.worldToScreen(s.points[0].x,s.points[0].y);b.moveTo(x.x,x.y);for(var y=1;t>y;y++)x=gEcnu.Util.worldToScreen(s.points[y].x,s.points[y].y),b.lineTo(x.x,x.y);b.closePath()}b.stroke(),a._opacity?b.globalAlpha=.1:b.globalAlpha=l.opacity;var z=this.style.fillColor;if(z=z.replace(/(^\s*)|(\s*$)/g,""),""!=z)switch(u){case"island":break;case"hole":b.globalAlpha=1,b.fillStyle="#fff",b.fill();break;default:b.fill()}if(a._autoLabel){b.globalAlpha=1;var A="null",B=this.fields;if("undefined"==typeof a._labelFieldMapping)"undefined"!=typeof B[a._labelField]&&(A=B[a._labelField]);else if("undefined"!=typeof B[a._labelField]){var C=B[a._labelField];"undefined"!=typeof a._labelFieldMapping[C]&&(A=a._labelFieldMapping[C])}var D=(this.shape.shpBox[0]+this.shape.shpBox[2])/2,E=(this.shape.shpBox[1]+this.shape.shpBox[3])/2,F=gEcnu.Util.worldToScreen(D,E);b.font="11px serif",b.fillStyle="#ffffff",b.fillText(A,F.x-20,F.y)}}},onDraw_bak20160113:function(a){var b=a.getCtx(),c=a.style;a.resetStyle;if(c instanceof gEcnu.Style_Ex){var d=c.mappingField,e=this.fields,f="default";for(var g in e)if(g==d){f=e[g];break}for(var h=c.styles,i=h.length,j=0;i>j;j++){var k=h[j];k.mappingValue!=f||(this.style=k)}}else{if(!(c instanceof gEcnu.Style))return void alert("style样式有问题！");this.style=c}"undefined"==typeof this.style&&(this.style=new gEcnu.Style({}));var l=gEcnu.Util.setStyle(b,this.style);a.getMap();b.globalAlpha=1;for(var m=this.shape.NumParts,n=0;m>n;n++){var o=this._lineRings[n],p=o.points.length;if(p>=2){b.beginPath();var q=gEcnu.Util.worldToScreen(o.points[0].x,o.points[0].y);b.moveTo(q.x,q.y);for(var r=1;p>r;r++)q=gEcnu.Util.worldToScreen(o.points[r].x,o.points[r].y),b.lineTo(q.x,q.y);b.closePath()}b.stroke(),a._opacity?b.globalAlpha=.1:b.globalAlpha=l.opacity;var s=this.style.fillColor;if(s=s.replace(/(^\s*)|(\s*$)/g,""),""!=s&&b.fill(),a._autoLabel){b.globalAlpha=1;var t="null",u=this.fields;if("undefined"==typeof a._labelFieldMapping)"undefined"!=typeof u[a._labelField]&&(t=u[a._labelField]);else if("undefined"!=typeof u[a._labelField]){var v=u[a._labelField];"undefined"!=typeof a._labelFieldMapping[v]&&(t=a._labelFieldMapping[v])}var w=(this.shape.shpBox[0]+this.shape.shpBox[2])/2,x=(this.shape.shpBox[1]+this.shape.shpBox[3])/2,y=gEcnu.Util.worldToScreen(w,x);b.font="11px serif",b.fillStyle="#ffffff",b.fillText(t,y.x-20,y.y)}}},onSelect:function(){var a=this._lineRings.length,b=gSelf;b.overLayer.clear();for(var c=0;a>c;c++){var d=this._lineRings[c].points,e=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});b.overLayer.setStyle(e);var f=b.overLayer._ctx;gEcnu.Util.setStyle(f,e),gEcnu.Graph.drawPoints_geo(f,d);var g=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});b.overLayer.setStyle(g);var f=b.overLayer._ctx;gEcnu.Util.setStyle(f,g),gEcnu.Graph.drawLines_geo(f,d)}},onSelect_ex:function(){var a=this._lineRings.length,b=gSelf;null!=gEcnu.Edit.selectedPolygon&&(gEcnu.Edit.selectedPolygon=null,b.overLayer.clear());for(var c=0;a>c;c++){var d=this._lineRings[c].points,e=b.overLayer._ctx,f=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});b.overLayer.setStyle(f);var e=b.overLayer._ctx;gEcnu.Util.setStyle(e,f),gEcnu.Graph.drawLines_geo(e,d)}},highLight:function(a,b,c){var d=this,e=this,b=(d.shape.shpType,arguments.length>1?arguments[1]:{isTwinkle:!1}),f=arguments.length>2?arguments[2]:{isFill:!0,fillColor:"#00FFFF",strokeColor:"red",lineWeight:2},g=void 0!=f.isFill?f.isFill:!0;if(g)var h=f.fillColor||"#00FFFF";else var h="";var i=f.strokeColor||"red",j=f.lineWeight||2,k=b.isTwinkle,l=b.twinkleCount||3,m=parseInt(b.twinkleInterval)||1e3;if(k)var n=0,o=setInterval(function(){return n>=2*l-1?void window.clearInterval(o):(n%2==0?e._drawHighlightFea(a,h,i,j):a.removeAllFeatures(),void n++)},m);else e._drawHighlightFea(a,h,i,j)},_drawHighlightFea:function(a,b,c,d){var e=this,f=new gEcnu.Style({opacity:.5,fillColor:b,strokeColor:c,lineWeight:d});a.setStyle(f),a.addFeature(e)},getLayer:function(){return this._layerID},getGeometrys:function(){return this._lineRings},pointInFeature:function(a){for(var b=this._lineRings.length,c=0;b>c;c++){var d=this._lineRings[c].points;if(gEcnu.Graph.pointInPoly(a,d))return!0}return!1}}),gEcnu.WebSQLServices=gClass.extend({init:function(){}}),gEcnu.ActType={},gEcnu.ActType.ADD="ADD",gEcnu.ActType.DELETE="DELETE",gEcnu.ActType.UPDATE="UPDATE",gEcnu.ActType.SQLQUERY="SQLQUERY",gEcnu.ActType.SQLEXEC="SQLEXEC",gEcnu.ActType.SQLTask="SQLTask",gEcnu.WebSQLServices.SQLServices=gEcnu.WebSQLServices.extend({init:function(a){"undefined"!=typeof a&&(this.events._events.processCompleted=a.processCompleted,this.events._events.processFailed=a.processFailed)},processAscyn:function(a,b,c,d){var e=gEcnu.config.geoserver+"WebSQL";if("ADD"==a)var f={mt:"SQLInsert",GeoDB:b,tablename:c,fldnames:d.Fields,data:d.Data},g=JSON.stringify(f),h={req:g};else if("SQLQUERY"==a){var i="select "+c.fields+" from "+c.lyr;"undefined"!=typeof c.filter&&""!=c.filter&&(i=i+" where "+c.filter);var j={mt:"SQLQuery",GeoDB:b,SQL:i},g=JSON.stringify(j),h={req:g}}else if("DELETE"==a)var k={mt:"SQLDelete",GeoDB:b,tablename:c,KeyFld:d.Fields,key:d.Data},g=JSON.stringify(k),h={req:g};else if("UPDATE"==a)var l={mt:"SQLUpdate",GeoDB:b,tablename:c,fldnames:d.Fields,data:d.Data},g=JSON.stringify(l),h={req:g};else if("SQLEXEC"==a)var m={mt:"SQLExec",GeoDB:b,SQL:c},g=JSON.stringify(m),h={req:g};else if("SQLTask"==a)var n={mt:"SQLTask",GeoDB:b,task:c},g=JSON.stringify(n),h={req:g};var o=this,p=o.events._events.processCompleted,q=o.events._events.processFailed;try{gEcnu.Util.ajax("POST",e,h,!0,function(b,d){var e=d.suc;if("undefined"!=typeof e){var f;if("SQLQUERY"==a){for(var g=JSON.parse(b),h=g.data,i=h.length,j=g.fldsDef,k=[],l=[],m=0;m<j.length;m++){var n=j[m].name;k.push(n)}for(var o=0;i>o;o++){var p=h[o];if("*"!=c.fields&&c.fields.indexOf("*")<0){var q=c.fields.split(","),r=p.length;if(r!=q.length)return void alert("查询字段与返回字段个数不统一，问题：存在数据库中不存在字段！");for(var s={},t=0;r>t;t++){var u=q[t],v=p[t];s[u]=v}l.push(s)}else{for(var s={},r=p.length,t=0;r>t;t++){var u=k[t],v=p[t];s[u]=v}l.push(s)}}f=l}else f=JSON.parse(b);e(f,j)}},function(){alert("websql请求超时")},5e5,{suc:p,fail:q})}catch(r){"undefined"!=typeof q&&q(r)}},events:{_events:{},on:function(a,b){switch(a){case"processCompleted":this._events.processCompleted=b;break;case"processFailed":this._events.processFailed=b}}}}),gEcnu.WebSQLServices.SQLTasks=gEcnu.WebSQLServices.extend({init:function(a,b,c){if("ADD"==a){var d={mt:"SQLInsert",tablename:b,fldnames:c.Fields,data:c.Data};this.sqlTaskParams=d}else if("DELETE"==a){var e={mt:"SQLDelete",tablename:b,KeyFld:c.Fields,key:c.Data};this.sqlTaskParams=e}else if("UPDATE"==a){var f={mt:"SQLUpdate",tablename:b,fldnames:c.Fields,data:c.Data};this.sqlTaskParams=f}else if("SQLEXEC"==a){var g={mt:"SQLExec",SQL:b};this.sqlTaskParams=g}}}),gEcnu.WebsqlScript=gClass.extend({init:function(a){this.processCompleted=a.processCompleted||function(){},this.processFailed=a.processFailed||function(){}},processAscyn:function(a){var b={req:JSON.stringify(a)},c=gEcnu.config.geoserver+"websqlscript",d=this.processCompleted,e=this.processFailed,f=this;try{gEcnu.Util.ajax("POST",c,b,!0,function(a){if(a){var b=d,c=JSON.parse(a),e=[],g={},h=[];for(var i in c)if(/^Query_\d+$/i.test(i)){var j=c[i],k=f._formatData(j),l=j.fldsDef;e=e.concat(k),h.push(l)}else g[i]=c[i];var m={message:g,queryResult:e,fldsDef:h};void 0!=b&&b(m)}},function(){},5e5)}catch(g){void 0!=e&&e(g)}},_formatData:function(a){var b=[];if(void 0==a.data)return b.push(a),b;for(var c=a.data,d=a.fldsDef,e=d.length,f=0,g=c.length;g>f;f++){var h={},i=c[f];if(i.length!=e)return void alert("查询字段与返回字段个数不统一，可能存在数据库中不字段！");for(var j=0;e>j;j++){var k=d[j].name,l=i[j];h[k]=l}b.push(h)}return b}}),gEcnu.WebFeatureServices=gClass.extend({init:function(){}}),gEcnu.QueryType={},gEcnu.QueryType.Point="point_qry",gEcnu.QueryType.Line="line_qry",gEcnu.QueryType.Polygon="polygon_qry",gEcnu.QueryType.Rect="rect_qry",gEcnu.layerType={},gEcnu.layerType.Esri="shp",gEcnu.layerType.GeoDB="geodb",gEcnu.WebFeatureServices.QueryByGeometry=gEcnu.WebFeatureServices.extend({init:function(a){"undefined"!=typeof a&&(this.events._events.processCompleted=a.processCompleted,this.events._events.processFailed=a.processFailed)},processAscyn:function(a){var b=gEcnu.config.geoserver+"WebFeature",c=a.shape,d=a.queryLyrType||"geodb",e=a.mapOrGeodb,f=a.lyrOrFtset,g=a.returnShape||!1,h=a.returnFields||"",i=void 0==a.format?"":a.format,j=void 0!=a.zip?a.zip:!0,k=a.tolerance||1e3;console.log(a);var l=0;if(l=g?1:0,c instanceof gEcnu.Geometry.Point){var n={};"geodb"==d?n={mt:"SeachAt",geoDB:e,ftSet:f,format:i,zip:j,Point:{x:c.x,y:c.y},Err:k,"return":{shape:l,fields:h}}:"shp"==d&&(n={mt:"SeachAt",map:e,lyr:f,format:i,zip:j,Point:{x:c.x,y:c.y},Err:k,"return":{shape:l,fields:h}});var o=JSON.stringify(n),p={req:o}}else if(c instanceof gEcnu.Geometry.LineString&&"line"==c.className);else if(c instanceof gEcnu.Geometry.LinearRing&&"polygon"==c.className){var q={},r=new gEcnu.Feature.Polygon([c],{}),s=r.shape;"geodb"==d?q={mt:"SelectByShape",geoDB:e,ftSet:f,format:i,zip:j,shape:s,sMode:0,"return":{shape:l,fields:h}}:"shp"==d&&(q={mt:"SelectByShape",map:e,lyr:f,format:i,zip:j,shape:s,sMode:0,"return":{shape:l,fields:h}});var o=JSON.stringify(q),p={req:o}}else if(c instanceof gEcnu.Geometry.RectRing&&"rect"==c.className){var t={},u=gEcnu.Util.getShpBox(c.points);"geodb"==d?t={mt:"SelectByRect",geoDB:e,ftSet:f,format:i,zip:j,rect:{xmin:u[0],ymin:u[1],xmax:u[2],ymax:u[3]},"return":{shape:l,fields:h}}:"shp"==d&&(t={mt:"SelectByRect",map:e,lyr:f,format:i,zip:j,rect:{xmin:u[0],ymin:u[1],xmax:u[2],ymax:u[3]},"return":{shape:l,fields:h}});var o=JSON.stringify(t),p={req:o}}else if(c instanceof gEcnu.Geometry.RadiusRing&&"radius"==c.className){var v={};"geodb"==d?v={mt:"SelectByRadius",geoDB:e,ftSet:f,format:i,zip:j,Point:{x:c.centerPoint.x,y:c.centerPoint.y},R:c.radius,"return":{shape:l,fields:h}}:"shp"==d&&(v={mt:"SelectByRadius",map:e,lyr:f,format:i,zip:j,Point:{x:c.centerPoint.x,y:c.centerPoint.y},R:c.radius,"return":{shape:l,fields:h}});var o=JSON.stringify(v),p={req:o}}var w=this,x=w.events._events.processCompleted,y=w.events._events.processFailed;try{gEcnu.Util.ajax("POST",b,p,!0,function(a,b){var c=b.suc,d=JSON.parse(a),e=[];if("geojson"==i.toLowerCase()){if(e=d.features,0==e.length)"undefined"!=typeof c&&c(e);else if(1==l){var f=[],g=gEcnu.Util.decode(d);e=g.features;for(var h=0;h<e.length;h++){var j=e[h],k=j.geometry,n=k.coordinates,o=j.properties,p=k.type,q={};switch(p){case"Polygon":for(var r=n.length,s=[],t=0;r>t;t++){for(var u=n[t],v=[],w=0,x=u.length;x>w;w++){var y=u[w],z=y[0],A=y[1],B=new gEcnu.Geometry.Point(z,A);v.push(B)}var C=new gEcnu.Geometry.LinearRing(v);s.push(C)}for(var D in o)q[D]=o[D];q.FID=j.id;var E=new gEcnu.Feature.Polygon(s,q);f.push(E);break;case"Polyline":for(var r=n.length,F=[],t=0;r>t;t++){for(var u=n[t],G=[],w=0,x=u.length;x>w;w++){var y=u[w],z=y[0],A=y[1],B=new gEcnu.Geometry.Point(z,A);G.push(B)}var H=new gEcnu.Geometry.LineString(G);F.push(H)}for(var D in o)q[D]=o[D];q.FID=j.id;var E=new gEcnu.Feature.Polyline(F,q);f.push(E);break;case"Point":case"MultiPoint":for(var r=n.length,F=[],t=0;r>t;t++)for(var u=n[t],I=[],w=0,x=u.length;x>w;w++){var y=u[w],z=y[0],A=y[1],B=new gEcnu.Geometry.Point(z,A);I.push(B)}for(var D in o)q[D]=o[D];q.FID=j.id;var E=new gEcnu.Feature.Point(I,q);f.push(E)}}"undefined"!=typeof c&&c(f)}else if(0==l){for(var f=[],h=0;h<e.length;h++){var j=e[h],J=j.properties,K=J.cp,q={};for(var D in J)q[D]=J[D];q.FID=j.id,q.cx=K[0],q.cy=K[1],f.push(q)}"undefined"!=typeof c&&c(f)}}else if(e=d.Features,0==e.length)"undefined"!=typeof c&&c(e);else if(1==l){for(var f=[],h=0;h<e.length;h++){var j=e[h],L=j.shape.shpType;if(5==L){for(var M=j.shape.Parts,N=M.length,O=j.shape.Points,s=[],w=0;N>w;w++){var P=M[w];if(w==N-1)var Q=O.length;else var Q=M[w+1];for(var v=[],R=P;Q-1>R;R++){var B=new gEcnu.Geometry.Point(O[R].X,O[R].Y);v.push(B)}var C=new gEcnu.Geometry.LinearRing(v);s.push(C)}var J=j.fields,q={};if("undefined"!=typeof J)for(var S=J.length,T=0;S>T;T++){var U=J[T];for(m in U)q[m]=U[m]}q.FID=j.FID;var E=new gEcnu.Feature.Polygon(s,q);f.push(E)}else if(3==L){for(var M=j.shape.Parts,N=M.length,O=j.shape.Points,F=[],w=0;N>w;w++){var P=M[w];if(w==N-1)var Q=O.length;else var Q=M[w+1];for(var G=[],R=P;Q>R;R++){var B=new gEcnu.Geometry.Point(O[R].X,O[R].Y);G.push(B)}var H=new gEcnu.Geometry.LineString(G);F.push(H)}var J=j.fields,q={};if("undefined"!=typeof J)for(var S=J.length,T=0;S>T;T++){var U=J[T];for(m in U)q[m]=U[m]}q.FID=j.FID;var E=new gEcnu.Feature.Polyline(F,q);f.push(E)}else{for(var O=j.shape.Points,I=[],w=0;w<O.length;w++){var B=new gEcnu.Geometry.Point(O[w].X,O[w].Y);I.push(B)}var J=j.fields,q={};if("undefined"!=typeof J)for(var S=J.length,T=0;S>T;T++){var U=J[T];for(m in U)q[m]=U[m]}q.FID=j.FID;var E=new gEcnu.Feature.Point(I,q);f.push(E)}}"undefined"!=typeof c&&c(f)}else if(0==l){for(var f=[],h=0;h<e.length;h++){var j=e[h],J=j.fields,q={};if("undefined"!=typeof J)for(var S=J.length,T=0;S>T;T++){var U=J[T];for(m in U)q[m]=U[m]}q.FID=j.FID,q.cx=j.cx,q.cy=j.cy,f.push(q)}"undefined"!=typeof c&&c(f)}},function(){alert("webfeature请求超时")},5e4,{suc:x,fail:y})}catch(z){"undefined"!=typeof y&&y(z)}},events:{_events:{},on:function(a,b){switch(a){case"processCompleted":this._events.processCompleted=b;break;case"processFailed":this._events.processFailed=b}}}}),gEcnu.WebFeatureServices.QueryByGeometry_ex=gEcnu.WebFeatureServices.extend({init:function(a){"undefined"!=typeof a&&(this.events._events.processCompleted=a.processCompleted,this.events._events.processFailed=a.processFailed)},processAscyn:function(a){var b=(gEcnu.config.geoserver+"WebFeature",a.geometry),c=a.qryLyr,d=a.targetLyr,e=c.name,f=c.LyrType,g=c.mapOrGeodb,h=d.name,i=d.LyrType,j=d.mapOrGeodb,k=d.returnShape,l=d.returnFields,m=0;m=k?1:0;var n=this,o=(n.events._events.processCompleted,n.events._events.processFailed),p=this._getQueryParam(b,f,g,e,1,"");this._execute(p,function(a){var b=[],c=0,d=a.length,e=function(){if(c>=d)return b;var f=a[c].getGeometrys()[0],g=n._getQueryParam(f,i,j,h,m,l);n._execute(g,function(a){b=b.concat(a),c++,e()})};e()},function(){void 0!=o&&o()})},_getQueryParam:function(a,b,c,d,e,f){var g="geojson",h=!0;if(a instanceof gEcnu.Geometry.Point){var i={};"geodb"==b?i={mt:"SeachAt",geoDB:c,ftSet:d,format:g,zip:h,Point:{x:a.x,y:a.y},Err:1e3,"return":{shape:e,fields:f}}:"shp"==b&&(i={mt:"SeachAt",map:c,lyr:d,format:g,zip:h,Point:{x:a.x,y:a.y},Err:1e3,"return":{shape:e,fields:f}});var j=JSON.stringify(i),k={req:j}}else if(a instanceof gEcnu.Geometry.LineString&&"line"==a.className);else if(a instanceof gEcnu.Geometry.LinearRing&&"polygon"==a.className){var l={},m=new gEcnu.Feature.Polygon([a],{}),n=m.shape;"geodb"==b?l={mt:"SelectByShape",geoDB:c,ftSet:d,format:g,zip:h,shape:n,sMode:0,"return":{shape:e,fields:f}}:"shp"==b&&(l={mt:"SelectByShape",map:c,lyr:d,format:g,zip:h,shape:n,sMode:0,"return":{shape:e,fields:f}});var j=JSON.stringify(l),k={req:j}}else if(a instanceof gEcnu.Geometry.RectRing&&"rect"==a.className){var o={},p=gEcnu.Util.getShpBox(a.points);"geodb"==b?o={mt:"SelectByRect",geoDB:c,ftSet:d,format:g,zip:h,rect:{xmin:p[0],ymin:p[1],xmax:p[2],ymax:p[3]},"return":{shape:e,fields:f}}:"shp"==b&&(o={mt:"SelectByRect",map:c,lyr:d,format:g,zip:h,rect:{xmin:p[0],ymin:p[1],xmax:p[2],ymax:p[3]},"return":{shape:e,fields:f}});var j=JSON.stringify(o),k={req:j}}else if(a instanceof gEcnu.Geometry.RadiusRing&&"radius"==a.className){var q={};"geodb"==b?q={mt:"SelectByRadius",geoDB:c,ftSet:d,format:g,zip:h,Point:{x:a.centerPoint.x,y:a.centerPoint.y},R:a.radius,"return":{shape:e,fields:f}}:"shp"==b&&(q={mt:"SelectByRadius",map:c,lyr:d,format:g,zip:h,Point:{x:a.centerPoint.x,y:a.centerPoint.y},R:a.radius,"return":{shape:e,fields:f}});var j=JSON.stringify(q),k={req:j}}return k},_execute:function(a,b,c){var d=gEcnu.config.geoserver+"WebFeature",e=arguments.length>1?arguments[1]:function(){},f=arguments.length>2?arguments[2]:function(){},g=JSON.parse(a.req),h=g.format,i=g["return"].shape;try{gEcnu.Util.ajax("POST",d,a,!0,function(a,b){var c=b.suc,d=JSON.parse(a),e=[];if("geojson"==h.toLowerCase()){if(e=d.features,0==e.length)"undefined"!=typeof c&&c(e);else if(1==i){var f=[],g=gEcnu.Util.decode(d);e=g.features;for(var j=0;j<e.length;j++){var k=e[j],l=k.geometry,n=l.coordinates,o=k.properties,p=l.type,q={};switch(p){case"Polygon":for(var r=n.length,s=[],t=0;r>t;t++){for(var u=n[t],v=[],w=0,x=u.length;x>w;w++){var y=u[w],z=y[0],A=y[1],B=new gEcnu.Geometry.Point(z,A);v.push(B)}var C=new gEcnu.Geometry.LinearRing(v);s.push(C)}for(var D in o)q[D]=o[D];q.FID=k.id;var E=new gEcnu.Feature.Polygon(s,q);f.push(E);break;case"Polyline":for(var r=n.length,F=[],t=0;r>t;t++){for(var u=n[t],G=[],w=0,x=u.length;x>w;w++){var y=u[w],z=y[0],A=y[1],B=new gEcnu.Geometry.Point(z,A);G.push(B)}var H=new gEcnu.Geometry.LineString(G);F.push(H)}for(var D in o)q[D]=o[D];q.FID=k.id;var E=new gEcnu.Feature.Polyline(F,q);f.push(E);break;case"Point":case"MultiPoint":for(var r=n.length,F=[],t=0;r>t;t++)for(var u=n[t],I=[],w=0,x=u.length;x>w;w++){var y=u[w],z=y[0],A=y[1],B=new gEcnu.Geometry.Point(z,A);I.push(B)}for(var D in o)q[D]=o[D];q.FID=k.id;var E=new gEcnu.Feature.Point(I,q);f.push(E)}}"undefined"!=typeof c&&c(f)}else if(0==i){for(var f=[],j=0;j<e.length;j++){var k=e[j],J=k.properties,K=J.cp,q={};for(var D in J)q[D]=J[D];q.FID=k.id,q.cx=K[0],q.cy=K[1],f.push(q)}"undefined"!=typeof c&&c(f)}}else if(e=d.Features,0==e.length)"undefined"!=typeof c&&c(e);else if(1==i){for(var f=[],j=0;j<e.length;j++){var k=e[j],L=k.shape.shpType;if(5==L){for(var M=k.shape.Parts,N=M.length,O=k.shape.Points,s=[],w=0;N>w;w++){var P=M[w];if(w==N-1)var Q=O.length;else var Q=M[w+1];for(var v=[],R=P;Q-1>R;R++){var B=new gEcnu.Geometry.Point(O[R].X,O[R].Y);v.push(B)}var C=new gEcnu.Geometry.LinearRing(v);s.push(C)}var J=k.fields,q={};if("undefined"!=typeof J)for(var S=J.length,T=0;S>T;T++){var U=J[T];for(m in U)q[m]=U[m]}q.FID=k.FID;var E=new gEcnu.Feature.Polygon(s,q);f.push(E)}else if(3==L){for(var M=k.shape.Parts,N=M.length,O=k.shape.Points,F=[],w=0;N>w;w++){var P=M[w];if(w==N-1)var Q=O.length;else var Q=M[w+1];for(var G=[],R=P;Q>R;R++){var B=new gEcnu.Geometry.Point(O[R].X,O[R].Y);G.push(B)}var H=new gEcnu.Geometry.LineString(G);F.push(H)}var J=k.fields,q={};if("undefined"!=typeof J)for(var S=J.length,T=0;S>T;T++){var U=J[T];for(m in U)q[m]=U[m]}q.FID=k.FID;var E=new gEcnu.Feature.Polyline(F,q);f.push(E)}else{for(var O=k.shape.Points,I=[],w=0;w<O.length;w++){var B=new gEcnu.Geometry.Point(O[w].X,O[w].Y);I.push(B)}var J=k.fields,q={};if("undefined"!=typeof J)for(var S=J.length,T=0;S>T;T++){var U=J[T];for(m in U)q[m]=U[m]}q.FID=k.FID;var E=new gEcnu.Feature.Point(I,q);f.push(E)}}"undefined"!=typeof c&&c(f)}else if(0==i){for(var f=[],j=0;j<e.length;j++){var k=e[j],J=k.fields,q={};if("undefined"!=typeof J)for(var S=J.length,T=0;S>T;T++){var U=J[T];for(m in U)q[m]=U[m]}q.FID=k.FID,q.cx=k.cx,q.cy=k.cy,f.push(q)}"undefined"!=typeof c&&c(f)}},function(){alert("webfeature请求超时")},5e4,{suc:e,fail:f})}catch(j){"undefined"!=typeof f&&f(j)}},events:{_events:{},on:function(a,b){switch(a){case"processCompleted":this._events.processCompleted=b;break;case"processFailed":this._events.processFailed=b}}}}),gEcnu.WebFeatureServices.QueryBySQL=gEcnu.WebFeatureServices.extend({init:function(a){"undefined"!=typeof a&&(this.events._events.processCompleted=a.processCompleted,this.events._events.processFailed=a.processFailed)},processAscyn:function(a){var b=gEcnu.config.geoserver+"WebFeature",c=a.sql||"",d=a.lyrType,e=a.mapOrGeodb,f=a.lyrOrFtset,g=a.returnFields||"",h=a.returnShape||!1,i=a.format||"",j=void 0!=a.zip?a.zip:!0,k=0;k=h?1:0;var l={};if("geodb"==d)l={mt:"SQLQuery",geoDB:e,ftSet:f,format:i,zip:j,sql:c,"return":{shape:k,fields:g}};else if("shp"==d)return void alert("暂时不支持shp图层查询");var n=JSON.stringify(l),o={req:n},p=this,q=p.events._events.processCompleted,r=p.events._events.processFailed;try{gEcnu.Util.ajax("POST",b,o,!0,function(a,b){var c=b.suc,d=JSON.parse(a),e=[];if("geojson"==i.toLowerCase())if(e=d.features,console.log("geojson",d),0==e.length)"undefined"!=typeof c&&c(e);else if(1==k){var f=[],g=gEcnu.Util.decode(d);e=g.features;for(var h=0;h<e.length;h++){var j=e[h],l=j.geometry,n=l.coordinates,o=j.properties,p=l.type,q={},r=!1;switch(p){case"Polygon":for(var s=n.length,t=[],u=0;s>u;u++){for(var v=n[u],w=[],x=0,y=v.length;y>x;x++){var z=v[x],A=z[0],B=z[1],C=new gEcnu.Geometry.Point(A,B);w.push(C)}w.pop();var D=new gEcnu.Geometry.LinearRing(w);if("polygon"!=D.className){r=!0;break}t.push(D)}if(r)continue;for(var E in o)q[E]=o[E];q.FID=j.id;var F=new gEcnu.Feature.Polygon(t,q);f.push(F);break;case"Polyline":for(var s=n.length,G=[],u=0;s>u;u++){for(var v=n[u],H=[],x=0,y=v.length;y>x;x++){var z=v[x],A=z[0],B=z[1],C=new gEcnu.Geometry.Point(A,B);H.push(C)}var I=new gEcnu.Geometry.LineString(H);G.push(I)}for(var E in o)q[E]=o[E];q.FID=j.id;var F=new gEcnu.Feature.Polyline(G,q);f.push(F);break;case"Point":case"MultiPoint":for(var s=n.length,G=[],u=0;s>u;u++)for(var v=n[u],J=[],x=0,y=v.length;y>x;x++){var z=v[x],A=z[0],B=z[1],C=new gEcnu.Geometry.Point(A,B);J.push(C)}for(var E in o)q[E]=o[E];q.FID=j.id;var F=new gEcnu.Feature.Point(J,q);f.push(F)}}"undefined"!=typeof c&&c(f)}else{for(var f=[],h=0;h<e.length;h++){var j=e[h],K=j.properties,L=K.cp,q={};for(var E in K)q[E]=K[E];q.FID=j.id,q.cx=L[0],q.cy=L[1],f.push(q)}"undefined"!=typeof c&&c(f)}else if(e=d.Features,0==e.length)"undefined"!=typeof c&&c(e);else if(1==k){for(var f=[],h=0;h<e.length;h++){var r=!1,j=e[h],M=j.shape.shpType;if(5==M){for(var N=j.shape.Parts,O=N.length,P=j.shape.Points,t=[],x=0;O>x;x++){var Q=N[x];if(x==O-1)var R=P.length;else var R=N[x+1];for(var w=[],S=Q;R-1>S;S++){var C=new gEcnu.Geometry.Point(P[S].X,P[S].Y);w.push(C)}var D=new gEcnu.Geometry.LinearRing(w);if("polygon"!=D.className){r=!0;break}t.push(D)}if(r)continue;var K=j.fields,q={};if("undefined"!=typeof K)for(var T=K.length,U=0;T>U;U++){var V=K[U];for(m in V)q[m]=V[m]}q.FID=j.FID;var F=new gEcnu.Feature.Polygon(t,q);f.push(F)}else if(3==M){for(var N=j.shape.Parts,O=N.length,P=j.shape.Points,G=[],x=0;O>x;x++){var Q=N[x];if(x==O-1)var R=P.length;else var R=N[x+1];for(var H=[],S=Q;R>S;S++){var C=new gEcnu.Geometry.Point(P[S].X,P[S].Y);H.push(C)}var I=new gEcnu.Geometry.LineString(H);G.push(I)}var K=j.fields,q={};if("undefined"!=typeof K)for(var T=K.length,U=0;T>U;U++){var V=K[U];for(m in V)q[m]=V[m]}q.FID=j.FID;var F=new gEcnu.Feature.Polyline(G,q);f.push(F)}else{for(var P=j.shape.Points,J=[],x=0;x<P.length;x++){var C=new gEcnu.Geometry.Point(P[x].X,P[x].Y);J.push(C)}var K=j.fields,q={};if("undefined"!=typeof K)for(var T=K.length,U=0;T>U;U++){var V=K[U];for(m in V)q[m]=V[m]}q.FID=j.FID;var F=new gEcnu.Feature.Point(J,q);f.push(F)}}"undefined"!=typeof c&&c(f)}else if(0==k){for(var f=[],h=0;h<e.length;h++){var j=e[h],K=j.fields,q={};if("undefined"!=typeof K)for(var T=K.length,U=0;T>U;U++){var V=K[U];for(m in V)q[m]=V[m]}q.FID=j.FID,q.cx=j.cx,q.cy=j.cy,f.push(q)}"undefined"!=typeof c&&c(f)}},function(){alert("webfeature请求超时")},5e5,{suc:q,fail:r})}catch(s){"undefined"!=typeof r&&r(s)}},events:{_events:{},on:function(a,b){switch(a){case"processCompleted":this._events.processCompleted=b;break;case"processFailed":this._events.processFailed=b}}}}),gEcnu.ActType={},gEcnu.ActType.ADD="ADD",gEcnu.ActType.DELETE="DELETE",gEcnu.ActType.UPDATE="UPDATE",gEcnu.ActType.SQLQUERY="SQLQUERY",gEcnu.ActType.SQLEXEC="SQLEXEC",gEcnu.ActType.SQLTask="SQLTask",gEcnu.WebFeatureServices.FeatureServices=gEcnu.WebFeatureServices.extend({init:function(a){"undefined"!=typeof a&&(this.events._events.processCompleted=a.processCompleted,this.events._events.processFailed=a.processFailed)},processAscyn:function(a,b,c,d,e){var f=gEcnu.config.geoserver+"WebFeature";if("ADD"==a){for(var g={},h=e.length,i=[],j=0;h>j;j++){var k={};k.shape=e[j].shape,k.fields=[];var l=e[j].fields;for(var m in l){var n={};n[m]=escape(l[m]),k.fields.push(n)}i.push(k)}"geodb"==b?g={mt:"SQLInsert",geoDB:c,ftSet:d,features:i}:"shp"==b&&(g={mt:"SQLInsert",map:c,lyr:d,features:i});var o=JSON.stringify(g),p={req:o}}else if("DELETE"==a){var q={};"geodb"==b?q={mt:"SQLDelete",geoDB:c,ftSet:d,sql:e}:"shp"==b&&(q={mt:"SQLDelete",map:c,lyr:d,sql:e});var o=JSON.stringify(q),p={req:o}}else if("UPDATE"==a){for(var r={},h=e.length,s=[],j=0;h>j;j++){var t={};if(t.FID=e[j].FID,"SHP"==e[j].UPDATE)t.shape=e[j].Feature.shape;else if("FIELDS"==e[j].UPDATE){t.fields=[];var l=e[j].Feature.fields;for(var m in l){var n={};n[m]=l[m],t.fields.push(n)}}else{t.shape=e[j].Feature.shape,t.fields=[];var l=e[j].Feature.fields;for(var m in l){var n={};n[m]=l[m],t.fields.push(n)}}s.push(t)}"geodb"==b?r={mt:"SQLUpdate",geoDB:c,ftSet:d,features:s}:"shp"==b&&(r={mt:"SQLUpdate",map:c,lyr:d,features:s});var o=JSON.stringify(r),p={req:o}}else if("SQLTask"==a){var u={};"geodb"==b?u={mt:"SQLTask",geoDB:c,task:d}:"shp"==b&&(alert("对不起，暂时不支持shp图层批量操作！"),u={mt:"SQLTask",map:c,task:d});var o=JSON.stringify(u),p={req:o}}var v=this;try{gEcnu.Util.ajax("POST",f,p,!0,function(a){"undefined"!=typeof v.events._events.processCompleted&&v.events._events.processCompleted()},function(){alert("webfeature请求超时")},5e5)}catch(w){"undefined"!=typeof v.events._events.processFailed&&v.events._events.processFailed(w)}},events:{_events:{},on:function(a,b){switch(a){case"processCompleted":this._events.processCompleted=b;break;case"processFailed":this._events.processFailed=b}}}}),gEcnu.WebFeatureServices.SQLTasks=gEcnu.WebFeatureServices.extend({init:function(a,b,c,d){if("ADD"==a){for(var e={},f=d.length,g=[],h=0;f>h;h++){var i={};i.shape=d[h].shape,i.fields=[];var j=d[h].fields;for(var k in j){var l={};l[k]=j[k],i.fields.push(l)}g.push(i)}"geodb"==b?e={mt:"SQLInsert",ftSet:c,features:g}:"shp"==b&&(e={mt:"SQLInsert",lyr:c,features:g}),this.taskParams=e}else if("DELETE"==a){var m={};"geodb"==b?m={mt:"SQLDelete",ftSet:c,sql:d}:"shp"==b&&(m={mt:"SQLDelete",lyr:c,sql:d}),this.taskParams=m}else if("UPDATE"==a){for(var n={},f=d.length,o=[],h=0;f>h;h++){var p={};if(p.FID=d[h].FID,"SHP"==d[h].UPDATE)p.shape=d[h].Feature.shape;else if("FIELDS"==d[h].UPDATE){p.fields=[];var j=d[h].Feature.fields;for(var k in j){var l={};l[k]=j[k],p.fields.push(l)}}else{p.shape=d[h].Feature.shape,p.fields=[];var j=d[h].Feature.fields;for(var k in j){var l={};l[k]=j[k],p.fields.push(l)}}o.push(p)}"geodb"==b?n={mt:"SQLUpdate",ftSet:c,features:o}:"shp"==b&&(n={mt:"SQLUpdate",lyr:c,features:o}),this.taskParams=n}}}),gEcnu.FtSetParams={},gEcnu.FtSetParams.PUBLICDB="publicdb",
gEcnu.FtSetParams.FIELDMETEDATA="fieldinfo",gEcnu.FtSetParams.FEATURESETLIST="ftSetList",gEcnu.FtSetParams.META="g_Meta",gEcnu.WebFeatureServices.createService=gEcnu.WebFeatureServices.extend({init:function(){},createMap:function(a,b,c,d,e){this.mapName=a,this.mapAlias=b,this.mapCoords=c,this.mapExtent=d,this._callback=e,this._checkMapExist()},createFeatureSet:function(a,b,c,d,e,f){this._create(a,b,c,d,e,f)},_checkMapExist:function(){var a=this.mapName,b=this,c=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(a){return a.length>0?void alert("已经存在该地图，请更换地图名"):void b._addMapRecord()},processFailed:function(){}}),d={lyr:"g_map",fields:"map_name,map_id",filter:"map_name='"+a+"'"};c.processAscyn(gEcnu.ActType.SQLQUERY,gEcnu.FtSetParams.PUBLICDB,d)},_addMapRecord:function(){var a=this._callback,b=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(b){void 0!=a&&a()},processFailed:function(){}}),c=this.mapName,d=this.mapAlias,e=this.mapExtent,f=this.mapCoords,g={Fields:["map_name","map_alias","ViewExtent","coordsys"],Data:[[c,d,e,f]]};b.processAscyn(gEcnu.ActType.ADD,gEcnu.FtSetParams.PUBLICDB,"g_map",g)},_create:function(a,b,c,d,e,f){this.ftsetName=a,this.shpType=b,this.viewExtent=c,this.coordSystem=d,this.fields=[],this.fields=this.fields.concat(e),this._callback=f,this._createFtset()},_createFtset:function(){var a=this,b="f_"+this.ftsetName,c=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(b){a._addftsetRecord()},processFailed:function(){}}),d="create table if not exists "+b+" (FID integer PRIMARY KEY,shpType integer,xmin double,ymin double,xmax double,ymax double,shpLen double,shpArea double,shpData blob,V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10,V11,V12,V13,V14,V15)";c.processAscyn(gEcnu.ActType.SQLEXEC,gEcnu.FtSetParams.PUBLICDB,d)},_addftsetRecord:function(){var a=this,b=this.ftsetName,c=this.shpType,d=this.viewExtent,e=this.coordSystem,f=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(b){a._insertMetaRecord()},processFailed:function(){}}),g={Fields:["ftsetName","shptype","viewextent","coordsys","datasource"],Data:[[b,c,d,e,b]]};f.processAscyn(gEcnu.ActType.ADD,gEcnu.FtSetParams.PUBLICDB,gEcnu.FtSetParams.FEATURESETLIST,g)},_insertMetaRecord:function(){var a=this,b=this.ftsetName,c=this.shpType,d=this.viewExtent,e=d.split(","),f=e[0],g=e[1],h=e[2],i=e[3],j=[b,c,f,g,h,i],k=[j],l=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(b){a._addFieldinfoRecord()},processFailed:function(){}}),m={Fields:["name","shptype","xmin","ymin","xmax","ymax"],Data:k};l.processAscyn(gEcnu.ActType.ADD,gEcnu.FtSetParams.PUBLICDB,gEcnu.FtSetParams.META,m)},_addFieldinfoRecord:function(){var a=[],b=this.fields;a=a.concat(b);var c="f_"+this.ftsetName,d=this._callback,e=[];if(a.length<1)return void(void 0!=d&&d());for(var f=0,g=a.length;g>f;f++){var h=a[f],i=h.field,j=h.fieldType,k="V"+f,l=[k,c,i,j];e.push(l)}var m=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(a){void 0!=d&&d()},processFailed:function(){}}),n={Fields:["field","tabname","fieldRealname","fieldtype"],Data:e};console.log("addfield",n),m.processAscyn(gEcnu.ActType.ADD,gEcnu.FtSetParams.PUBLICDB,gEcnu.FtSetParams.FIELDMETEDATA,n)}}),gEcnu.WebFeatureServices.mapService=gEcnu.WebFeatureServices.extend({init:function(a){this.mapName=a},addLyrs:function(a,b){this._callback=b,this.lyrArr=a,this._insertFtset(a)},deleteLyrs:function(a){var b=this.mapName;this.delLyrs=a;var c=this;if(!(a.length<1)){var d=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(a){var b=a[0].map_id;c._execDel(b)},processFailed:function(){}}),e={lyr:"g_map",fields:"map_id",filter:"map_name='"+b+"'"};d.processAscyn(gEcnu.ActType.SQLQUERY,gEcnu.FtSetParams.PUBLICDB,e)}},_execDel:function(a){for(var b=this.delLyrs,c="",d=b.length,e=0;d>e;e++)c=e!=d-1?c+"lyr_name='"+b[e]+"' or ":c+"lyr_name='"+b[e]+"'";var f=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(a){},processFailed:function(){alert("删除图层出错")}}),g="delete from g_layers where map_id="+a+" and ("+c+")";f.processAscyn(gEcnu.ActType.SQLEXEC,gEcnu.FtSetParams.PUBLICDB,g)},_insertFtset:function(a){var b=this.mapName,c=this;if(!(a.length<1)){var d=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(a){if(a.length<1)return void alert("不存在该地图");var b=a[0].map_id;c._getFtsetInfo(b)},processFailed:function(){}}),e={lyr:"g_map",fields:"map_id",filter:"map_name='"+b+"'"};d.processAscyn(gEcnu.ActType.SQLQUERY,gEcnu.FtSetParams.PUBLICDB,e)}},removeLyr:function(){},removeFtset:function(){},_getFtsetInfo:function(a){var b=this,c=[],d=[];d=d.concat(this.lyrArr);for(var e=0,f=d.length,g="",e=0;f>e;e++)g=e!=f-1?g+" ftsetName='"+d[e]+"' or ":g+" ftsetName='"+d[e]+"'";var h=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(d){c=c.concat(d),b._addFtsetRecord(a,c)},processFailed:function(){}}),i={lyr:gEcnu.FtSetParams.FEATURESETLIST,fields:"ftsetName,shptype,datasource,viewExtent",filter:g};h.processAscyn(gEcnu.ActType.SQLQUERY,gEcnu.FtSetParams.PUBLICDB,i)},_addFtsetRecord:function(a,b){console.log(b);var c=this._callback,d=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(a){void 0!=c&&(console.log("向地图中添加图层成功"),c())},processFailed:function(){}}),e=[];e=e.concat(this.ftsets);for(var f="134,宋体,0,-14,0",g=[],h=0,i=b.length;i>h;h++){var j=[],k=b[h].ftsetName,l=b[h].shptype;switch(l){case"8":case"1":var m="GeoSymbols,35,$00c0c0c0,6";break;case"3":var m="0,$00ffff80,1";break;case"5":var m="0,$00006432,1,0,$00006432";break;default:var m="0,$00ff8000,1,0,$00ff0000"}j[0]=k,j[1]=b[h].shptype,j[2]=a,j[3]=k,j[4]=b[h].datasource,j[5]=f,j[6]=m,j[7]=1e3,g.push(j)}var n={Fields:["lyr_name","lyr_type","map_id","alias","datasource","labelstyle","lyr_style","z_index"],Data:g};d.processAscyn(gEcnu.ActType.ADD,gEcnu.FtSetParams.PUBLICDB,"g_layers",n)}}),gEcnu.DrawFeature=gClass.extend({init:function(a){this.name=a}}),gEcnu.DrawFeature.setting=null,gEcnu.DrawFeature.Marker=gEcnu.DrawFeature.extend({init:function(){this._layer=gSelf.mLayer},activate:function(){this._layer._map.setMode("drawMarker"),gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(a,b){switch(a){case"added":this._events.added=b}}}}),gEcnu.DrawFeature.Point=gEcnu.DrawFeature.extend({init:function(a){this._layer=a},reVoke:function(){},activate:function(){this._layer._map.setMode("drawPoint"),gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(a,b){switch(a){case"added":this._events.added=b}}}}),gEcnu.DrawFeature.Line=gEcnu.DrawFeature.extend({init:function(a,b){this._layer=a,this._catchable=!0,arguments.length>1&&(this._catchable=b)},setCatchable:function(a){this._catchable=a},reVoke:function(){if(gEcnu.Edit.draw_line_points.length>0){gEcnu.Edit.draw_line_points.pop();var a=new gEcnu.Style({opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});this._layer._map.overLayer.setStyle(a);var b=this._layer._map.overLayer._ctx;gEcnu.Util.setStyle(b,a);var c=gEcnu.Edit.draw_line_points.length,d=gEcnu.Edit.draw_line_points;if(this._layer._map.overLayer.clear(),c>=1){var e=gEcnu.Util.worldToScreen(d[c-1].x,d[c-1].y);if(gEcnu.Graph.drawLine(b,e,gEcnu.Edit.NowPoint),c>=2){var f=gEcnu.Util.worldToScreen(d[0].x,d[0].y);gEcnu.Graph.drawLine(b,f,gEcnu.Edit.NowPoint)}gEcnu.Graph.drawLines_geo(b,d)}gEcnu.Graph.drawPoints_geo(b,d)}else alert("节点为空，不能撤销节点")},activate:function(){this._layer._map.setMode("drawLine"),gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(a,b){switch(a){case"added":this._events.added=b}}}}),gEcnu.DrawFeature.Polygon=gEcnu.DrawFeature.extend({init:function(a,b){this._layer=a,this._catchable=!0,arguments.length>1&&(this._catchable=b)},setCatchable:function(a){this._catchable=a},reVoke:function(){if(gEcnu.Edit.draw_polygon_points.length>0){gEcnu.Edit.draw_polygon_points.pop();var a=new gEcnu.Style({opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});this._layer._map.overLayer.setStyle(a);var b=this._layer._map.overLayer._ctx;gEcnu.Util.setStyle(b,a);var c=gEcnu.Edit.draw_polygon_points.length,d=gEcnu.Edit.draw_polygon_points;if(this._layer._map.overLayer.clear(),c>=1){var e=gEcnu.Util.worldToScreen(d[c-1].x,d[c-1].y);if(gEcnu.Graph.drawLine(b,e,gEcnu.Edit.NowPoint),c>=2){var f=gEcnu.Util.worldToScreen(d[0].x,d[0].y);gEcnu.Graph.drawLine(b,f,gEcnu.Edit.NowPoint)}gEcnu.Graph.drawLines_geo(b,d)}gEcnu.Graph.drawPoints_geo(b,d)}else alert("节点为空，不能撤销节点")},activate:function(){this._layer._map.setMode("drawPolygon"),gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(a,b){switch(a){case"added":this._events.added=b}}}}),gEcnu.DrawFeature.Rect=gEcnu.DrawFeature.extend({init:function(a){this._layer=a},activate:function(){this._layer._map.setMode("drawRect"),gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(a,b){switch(a){case"added":this._events.added=b}}}}),gEcnu.DrawFeature.Circle=gEcnu.DrawFeature.extend({init:function(a,b){this._layer=a,this.isDisplayRadius=arguments.length>1?arguments[1]:!1},activate:function(){this._layer._map.setMode("drawCircle"),gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(a,b){switch(a){case"added":this._events.added=b}}}}),gEcnu.DrawFeature.Text=gEcnu.DrawFeature.extend({init:function(a){this._layer=a},activate:function(){this._layer._map.setMode("drawText"),gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(a,b){switch(a){case"added":this._events.added=b}}}}),gEcnu.EditFeature=gClass.extend({init:function(){}}),gEcnu.EditFeature.setting=null,gEcnu.EditFeature.Polygon=gEcnu.EditFeature.extend({init:function(a,b){this._layer=a,this._catchable=!0,this._reshape=!1,arguments.length>1&&(this._catchable=b)},activate:function(a){this._layer._map.setMode("selectPolygon"),arguments.length>0&&(this._reshape=a),gEcnu.EditFeature.setting=this},deactivate:function(){this._layer._map.setMode("map"),this._layer._map.overLayer.clear(),gEcnu.EditFeature.setting=null,gEcnu.Edit.selectedPolygon=null,gEcnu.Edit.selectedPolygon_pre=null,gEcnu.Edit.Poly_sellineRing_index=-1,gEcnu.Edit.Poly_selPoint_index=-1,gEcnu.Edit.multiSelectedFeatures=[],this._layer._map.mLayer.getLayerContainer().style.cursor="default"},addPoint:function(){null!=gEcnu.EditFeature.setting&&null!=gEcnu.Edit.selectedPolygon&&this._layer._map.setMode("addPoint")},delPoint:function(){null!=gEcnu.EditFeature.setting&&null!=gEcnu.Edit.selectedPolygon&&this._layer._map.setMode("delPoint")},reShape:function(){this._reshape=!0},offReShape:function(){this._reshape=!1},setCatchable:function(a){this._catchable=a},events:{_events:{},on:function(a,b){switch(a){case"selected":this._events.selected=b;break;case"multiSelected":this._events.multiSelected=b;break;case"updateCompleted":this._events.updateCompleted=b}}}}),gEcnu.EditFeature.Line=gEcnu.EditFeature.extend({init:function(a,b){this._layer=a,this._catchable=!0,arguments.length>1&&(this._catchable=b),this._reshape=!1},activate:function(a){this._layer._map.setMode("selectLine"),arguments.length>0&&(this._reshape=a),gEcnu.EditFeature.setting=this},deactivate:function(){this._layer._map.setMode("map"),this._layer._map.overLayer.clear(),gEcnu.EditFeature.setting=null,gEcnu.Edit.selectedLine=null,gEcnu.Edit.selectedLine_pre=null,gEcnu.Edit.Line_sellineString_index=-1,gEcnu.Edit.Line_selPoint_index=-1,gEcnu.Edit.multiSelectedFeatures=[],this._layer._map.mLayer.getLayerContainer().style.cursor="default"},addPoint:function(){null!=gEcnu.EditFeature.setting&&null!=gEcnu.Edit.selectedLine&&this._layer._map.setMode("addPoint_line")},delPoint:function(){null!=gEcnu.EditFeature.setting&&null!=gEcnu.Edit.selectedLine&&this._layer._map.setMode("delPoint_line")},reShape:function(){this._reshape=!0},offReShape:function(){this._reshape=!1},setCatchable:function(a){this._catchable=a},events:{_events:{},on:function(a,b){switch(a){case"selected":this._events.selected=b;break;case"multiSelected":this._events.multiSelected=b;break;case"updateCompleted":this._events.updateCompleted=b}}}}),gEcnu.EditFeature.Point=gEcnu.EditFeature.extend({init:function(a){this._layer=a},activate:function(){this._layer._map.setMode("selectPoint"),gEcnu.EditFeature.setting=this},deactivate:function(){this._layer._map.setMode("map"),this._layer._map.overLayer.clear(),gEcnu.EditFeature.setting=null,gEcnu.Edit.selectedPoint=null,gEcnu.Edit.multiSelectedFeatures=[],this._layer._map.mLayer.getLayerContainer().style.cursor="default"},events:{_events:{},on:function(a,b){switch(a){case"selected":this._events.selected=b;break;case"multiSelected":this._events.multiSelected=b;break;case"updateCompleted":this._events.updateCompleted=b}}}}),gEcnu.EditFeature.Text=gEcnu.EditFeature.extend({init:function(a){this._layer=a},activate:function(){this._layer._map.setMode("selectText"),gEcnu.EditFeature.setting=this},deactivate:function(){this._layer._map.setMode("map"),this._layer._map.overLayer.clear(),gEcnu.EditFeature.setting=null,this._layer._map.mLayer.getLayerContainer().style.cursor="default"},events:{_events:{},on:function(a,b){switch(a){case"selected":this._events.selected=b}}}}),gEcnu.Edit={},gEcnu.Edit.moving=!1,gEcnu.Edit.draw_line_points=[],gEcnu.Edit.draw_polygon_points=[],gEcnu.Edit.selectedPolygon=null,gEcnu.Edit.selectedPolygon_pre=null,gEcnu.Edit.selectedLine=null,gEcnu.Edit.selectedLine_pre=null,gEcnu.Edit.Poly_sellineRing_index=-1,gEcnu.Edit.Poly_selPoint_index=-1,gEcnu.Edit.Line_sellineString_index=-1,gEcnu.Edit.Line_selPoint_index=-1,gEcnu.Edit.NowPoint=null,gEcnu.Edit.selectedPoint=null,gEcnu.Edit.multiSelectedFeatures=[],gEcnu.Edit.draw_rect_points=[],gEcnu.Edit.draw_circle_points=[],gEcnu.Edit.drawCircleEnd=!1,gEcnu.Edit.graphMouseDownEvt=function(a,b){var c=b.getMode(),d=gEcnu.Util.getMouseXY(gSelf._container,a);gSelf.startX=d.x,gSelf.startY=d.y;var e=gEcnu.Util.screenToWorld(d.x,d.y),f=b.overLayer.getCtx();switch(gEcnu.Edit.moving=!0,c){case"drawMarker":var g=new gEcnu.Geometry.Point(e.x,e.y);b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.mark;var h=gEcnu.DrawFeature.setting.events._events.added;"undefined"!=typeof h&&h(a,g);break;case"drawPoint":var g=new gEcnu.Geometry.Point(e.x,e.y),h=gEcnu.DrawFeature.setting.events._events.added;"undefined"!=typeof h&&h(a,g);break;case"drawLine":var i=gEcnu.DrawFeature.setting,j=i._catchable,k=i._layer;if(j){var l="",m="",n=k.getAllFeatures();if(l=gEcnu.Graph.catchPoint(d,n),l.indexOf("true")>=0){var o=parseFloat(l.split("|")[1].split(",")[0]),p=parseFloat(l.split("|")[1].split(",")[1]),q=parseFloat(l.split("|")[1].split(",")[2]),r=parseFloat(l.split("|")[1].split(",")[3]);d={x:o,y:p},e={x:q,y:r}}else if(b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.draw,m=gEcnu.Graph.catchLine(d,n),m.indexOf("true")>=0){var s=parseFloat(m.split("|")[1].split(",")[0]),t=parseFloat(m.split("|")[1].split(",")[1]),u=parseFloat(m.split("|")[1].split(",")[2]),v=parseFloat(m.split("|")[1].split(",")[3]);d={x:s,y:t},e={x:u,y:v}}}var g=new gEcnu.Geometry.Point(e.x,e.y);gEcnu.Edit.draw_line_points.push(g);var w=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});b.overLayer.setStyle(w);var f=b.overLayer._ctx;gEcnu.Util.setStyle(f,w),gEcnu.Graph.drawPoint(f,d);var x=gEcnu.Edit.draw_line_points.length;if(x>1){var y=new gEcnu.Style({opacity:1,fillColor:"#82D900",strokeColor:"#118811",lineWeight:1});b.overLayer.setStyle(y);var f=b.overLayer._ctx;gEcnu.Util.setStyle(f,y),gEcnu.Graph.drawLines_geo(f,gEcnu.Edit.draw_line_points)}break;case"drawPolygon":var i=gEcnu.DrawFeature.setting,j=i._catchable,k=i._layer;if(j){var l="",m="",n=k.getAllFeatures();if(l=gEcnu.Graph.catchPoint(d,n),l.indexOf("true")>=0){var o=parseFloat(l.split("|")[1].split(",")[0]),p=parseFloat(l.split("|")[1].split(",")[1]),q=parseFloat(l.split("|")[1].split(",")[2]),r=parseFloat(l.split("|")[1].split(",")[3]);d={x:o,y:p},e={x:q,y:r}}else if(b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.draw,m=gEcnu.Graph.catchLine(d,n),m.indexOf("true")>=0){var s=parseFloat(m.split("|")[1].split(",")[0]),t=parseFloat(m.split("|")[1].split(",")[1]),u=parseFloat(m.split("|")[1].split(",")[2]),v=parseFloat(m.split("|")[1].split(",")[3]);d={x:s,y:t},e={x:u,y:v}}}var g=new gEcnu.Geometry.Point(e.x,e.y);gEcnu.Edit.draw_polygon_points.push(g);var z=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});b.overLayer.setStyle(z);var f=b.overLayer._ctx;gEcnu.Util.setStyle(f,z),gEcnu.Graph.drawPoint(f,d);var x=gEcnu.Edit.draw_polygon_points.length;if(x>1){var y=new gEcnu.Style({opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});b.overLayer.setStyle(y);var f=b.overLayer._ctx;gEcnu.Util.setStyle(f,y),gEcnu.Graph.drawLines_geo(f,gEcnu.Edit.draw_polygon_points)}break;case"selectPolygon":if(gEcnu.Util.ifshift(a)){for(var i=gEcnu.EditFeature.setting,k=i._layer,n=k.getAllFeatures(),x=n.length,A=null,B=0;x>B;B++){for(var C=!1,D=n[B]._lineRings.length,E=0;D>E;E++){var F=n[B]._lineRings[E].points;if(gEcnu.Graph.pointInPoly(e,F)){for(var G=!1,H=gEcnu.Edit.multiSelectedFeatures,I=H.length,J=0;I>J;J++){var K=H[J];if(K==n[B]){G=!0,b.overLayer.clear(),gEcnu.Edit.multiSelectedFeatures.splice(J,1);break}}if(G)for(var L=gEcnu.Edit.multiSelectedFeatures,M=L.length,N=0;M>N;N++)L[N].onSelect_ex();else gEcnu.Edit.multiSelectedFeatures.push(n[B]),n[B].onSelect_ex();A=n[B],C=!0;break}}if(C)break}var h=gEcnu.EditFeature.setting.events._events.multiSelected,O=[];null!=A&&O.push(A),"undefined"!=typeof h&&h(a,O)}else{for(var i=gEcnu.EditFeature.setting,k=i._layer,n=k.getAllFeatures(),x=n.length,A=null,B=0;x>B;B++){for(var C=!1,D=n[B]._lineRings.length,E=0;D>E;E++){var F=n[B]._lineRings[E].points;if(gEcnu.Graph.pointInPoly(e,F)){gEcnu.EditFeature.setting._reshape?n[B].onSelect():n[B].onSelect_ex(),A=n[B],gEcnu.Edit.selectedPolygon=A,gEcnu.Edit.selectedPolygon_pre=A,C=!0;break}}if(C)break}var h=gEcnu.EditFeature.setting.events._events.selected,O=[];null!=A&&O.push(A),"undefined"!=typeof h&&h(a,O)}break;case"addPoint":var m="false";if(null==gEcnu.Edit.selectedPolygon)return;if(m=gEcnu.Graph.catchLine(d,[gEcnu.Edit.selectedPolygon]),m.indexOf("true")>=0){var q=parseFloat(m.split("|")[1].split(",")[2]),r=parseFloat(m.split("|")[1].split(",")[3]),P=parseFloat(m.split("|")[4].split(",")[0]),Q=parseFloat(m.split("|")[4].split(",")[1]),R=gEcnu.Edit.selectedPolygon._lineRings[P],S=new gEcnu.Geometry.Point(q,r),T=parseInt(Q)+1;R.addPoint(S,T);for(var i=gEcnu.EditFeature.setting,k=i._layer,U=k.getAllFeatures(),V=[],W=0;W<U.length;W++)U[W]!=gEcnu.Edit.selectedPolygon_pre&&V.push(U[W]);var X=new gEcnu.Feature.Polygon(gEcnu.Edit.selectedPolygon._lineRings,gEcnu.Edit.selectedPolygon._data);V.push(X),gEcnu.Edit.selectedPolygon.shape=X.shape,gEcnu.Edit.selectedPolygon_pre=X,gEcnu.Edit.selectedPolygon=X,k.removeAllFeatures(),k.addFeatures(V),X.onSelect(),b.setMode("moveNode_mouseDwon");var h=gEcnu.EditFeature.setting.events._events.updateCompleted;"undefined"!=typeof h&&h(a,X)}break;case"delPoint":var l="false";if(null==gEcnu.Edit.selectedPolygon)return;if(l=gEcnu.Graph.catchPoint(d,[gEcnu.Edit.selectedPolygon]),l.indexOf("true")>=0){var Y=parseFloat(l.split("|")[2].split(",")[0]),Z=parseFloat(l.split("|")[2].split(",")[1]),R=gEcnu.Edit.selectedPolygon._lineRings[Y],T=parseInt(Z);R.delPoint(T);for(var i=gEcnu.EditFeature.setting,k=i._layer,U=k.getAllFeatures(),V=[],W=0;W<U.length;W++)U[W]!=gEcnu.Edit.selectedPolygon_pre&&V.push(U[W]);var X=new gEcnu.Feature.Polygon(gEcnu.Edit.selectedPolygon._lineRings,gEcnu.Edit.selectedPolygon._data);V.push(X),gEcnu.Edit.selectedPolygon.shape=X.shape,gEcnu.Edit.selectedPolygon_pre=X,gEcnu.Edit.selectedPolygon=X,k.removeAllFeatures(),k.addFeatures(V),X.onSelect(),b.setMode("moveNode_mouseDwon");var h=gEcnu.EditFeature.setting.events._events.updateCompleted;"undefined"!=typeof h&&h(a,X)}break;case"moveNode_mouseDwon":b.setMode("moveNode");break;case"selectLine":if(gEcnu.Util.ifshift(a)){console.log("shift");var i=gEcnu.EditFeature.setting,k=i._layer,n=k.getAllFeatures(),x=n.length,A=null,$=gEcnu.Graph.catchLine(d,n);if($.indexOf("true")>=0){var _=parseFloat($.split("|")[4].split(",")[2]);_=parseInt(_);for(var aa=n[_],G=!1,H=gEcnu.Edit.multiSelectedFeatures,I=H.length,J=0;I>J;J++){var K=H[J];if(K==aa){G=!0,b.overLayer.clear(),gEcnu.Edit.multiSelectedFeatures.splice(J,1);break}}G||gEcnu.Edit.multiSelectedFeatures.push(aa);for(var L=gEcnu.Edit.multiSelectedFeatures,M=L.length,N=0;M>N;N++)L[N].onSelect_ex();A=aa}var h=gEcnu.EditFeature.setting.events._events.multiSelected,O=[];null!=A&&O.push(A),"undefined"!=typeof h&&h(a,O)}else{var i=gEcnu.EditFeature.setting,k=i._layer,n=k.getAllFeatures(),x=n.length,A=null,$=gEcnu.Graph.catchLine(d,n);if($.indexOf("true")>=0){var _=parseFloat($.split("|")[4].split(",")[2]);_=parseInt(_);var aa=n[_];gEcnu.EditFeature.setting._reshape?aa.onSelect():aa.onSelect_ex(),A=aa,gEcnu.Edit.selectedLine=A,gEcnu.Edit.selectedLine_pre=A}var h=gEcnu.EditFeature.setting.events._events.selected,O=[];null!=A&&O.push(A),"undefined"!=typeof h&&h(a,O)}break;case"moveNodeLine_mouseDwon":b.setMode("moveNode_Line");break;case"addPoint_line":var m="false";if(null==gEcnu.Edit.selectedLine)return;if(m=gEcnu.Graph.catchLine(d,[gEcnu.Edit.selectedLine]),m.indexOf("true")>=0){var q=parseFloat(m.split("|")[1].split(",")[2]),r=parseFloat(m.split("|")[1].split(",")[3]),P=parseFloat(m.split("|")[4].split(",")[0]),Q=parseFloat(m.split("|")[4].split(",")[1]),R=gEcnu.Edit.selectedLine._lineStrings[P],S=new gEcnu.Geometry.Point(q,r),T=parseInt(Q)+1;R.addPoint(S,T);for(var i=gEcnu.EditFeature.setting,k=i._layer,U=k.getAllFeatures(),V=[],W=0;W<U.length;W++)U[W]!=gEcnu.Edit.selectedLine_pre&&V.push(U[W]);var X=new gEcnu.Feature.Polyline(gEcnu.Edit.selectedLine._lineStrings,gEcnu.Edit.selectedLine._data);V.push(X),gEcnu.Edit.selectedLine.shape=X.shape,gEcnu.Edit.selectedLine_pre=X,gEcnu.Edit.selectedLine=X,k.removeAllFeatures(),k.addFeatures(V),X.onSelect(),b.setMode("moveNodeLine_mouseDwon");var h=gEcnu.EditFeature.setting.events._events.updateCompleted;"undefined"!=typeof h&&h(a,X)}break;case"delPoint_line":var l="false";if(null==gEcnu.Edit.selectedLine)return;if(l=gEcnu.Graph.catchPoint(d,[gEcnu.Edit.selectedLine]),l.indexOf("true")>=0){var Y=parseFloat(l.split("|")[2].split(",")[0]),Z=parseFloat(l.split("|")[2].split(",")[1]),R=gEcnu.Edit.selectedLine._lineStrings[Y],T=parseInt(Z);R.delPoint(T);for(var i=gEcnu.EditFeature.setting,k=i._layer,U=k.getAllFeatures(),V=[],W=0;W<U.length;W++)U[W]!=gEcnu.Edit.selectedLine_pre&&V.push(U[W]);var X=new gEcnu.Feature.Polyline(gEcnu.Edit.selectedLine._lineStrings,gEcnu.Edit.selectedLine._data);V.push(X),gEcnu.Edit.selectedLine.shape=X.shape,gEcnu.Edit.selectedLine_pre=X,gEcnu.Edit.selectedLine=X,k.removeAllFeatures(),k.addFeatures(V),X.onSelect(),b.setMode("moveNodeLine_mouseDwon");var h=gEcnu.EditFeature.setting.events._events.updateCompleted;"undefined"!=typeof h&&h(a,X)}break;case"selectPoint":for(var i=gEcnu.EditFeature.setting,k=i._layer,n=k.getAllFeatures(),x=n.length,A=null,B=0;x>B;B++)for(var ba=n[B],ca=ba.shape.NumPoints,E=0;ca>E;E++){var da=gEcnu.Util.worldToScreen(ba.shape.Points[E].X,ba.shape.Points[E].Y),ea=Math.sqrt((da.x-d.x)*(da.x-d.x)+(da.y-d.y)*(da.y-d.y));if(5>ea){A=ba;break}}if(!A)return;if(gEcnu.Util.ifshift(a)){for(var G=!1,H=gEcnu.Edit.multiSelectedFeatures,I=H.length,J=0;I>J;J++){var K=H[J];if(K==A){G=!0,b.overLayer.clear(),gEcnu.Edit.multiSelectedFeatures.splice(J,1);break}}G||gEcnu.Edit.multiSelectedFeatures.push(A);for(var L=gEcnu.Edit.multiSelectedFeatures,M=L.length,N=0;M>N;N++)L[N].onSelect();var fa=gEcnu.EditFeature.setting.events._events.multiSelected,O=[];null!=A&&O.push(A),"undefined"!=typeof fa&&fa(a,O)}else{A&&(gEcnu.Edit.selectedPoint=A,A.onSelect());var h=gEcnu.EditFeature.setting.events._events.selected,O=[];null!=A&&O.push(A),"undefined"!=typeof h&&h(a,O)}break;case"selectText":for(var i=gEcnu.EditFeature.setting,k=i._layer,ga=k.getTextsInWindow(),x=ga.length,ha=null,B=0;x>B;B++){var ia=ga[B];if(d.x>=ia.boxScrSize.xmin&&d.x<=ia.boxScrSize.xmax&&d.y>=ia.boxScrSize.ymin&&d.y<=ia.boxScrSize.ymax){ha=ia;break}}var h=gEcnu.EditFeature.setting.events._events.selected,ja=[];null!=ha&&ja.push(ha),"undefined"!=typeof h&&h(a,ja);break;case"drawRect":var ka=new gEcnu.Geometry.Point(e.x,e.y);gEcnu.Edit.draw_rect_points.push(ka);break;case"drawCircle":gEcnu.Edit.draw_circle_points=[];var ka=new gEcnu.Geometry.Point(e.x,e.y);gEcnu.Edit.draw_circle_points.push(ka);break;case"drawText":var h=gEcnu.DrawFeature.setting.events._events.added;"undefined"!=typeof h&&h(a)}},gEcnu.Edit.graphMouseMoveEvt=function(a,b){var c=b.getMode(),d=gEcnu.Util.getMouseXY(gSelf._container,a);gEcnu.Edit.NowPoint=d;var e=b.overLayer.getCtx();switch(c){case"drawLine":var f=gEcnu.Edit.draw_line_points,g=f.length,h=gEcnu.DrawFeature.setting,i=h._catchable,j=h._layer;if(b.overLayer.clear(),b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.draw,i){var k="",l="",m=j.getAllFeatures();if(k=gEcnu.Graph.catchPoint(d,m),k.indexOf("true")>=0){b.overLayer.clear(),b.mLayer.getLayerContainer().style.cursor="crosshair";var n=parseFloat(k.split("|")[1].split(",")[0]),o=parseFloat(k.split("|")[1].split(",")[1]);d={x:n,y:o};var p=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"red",strokeColor:"red",lineWeight:2});b.overLayer.setStyle(p);var e=b.overLayer._ctx;gEcnu.Util.setStyle(e,p),gEcnu.Graph.drawPoint(e,d)}else if(l=gEcnu.Graph.catchLine(d,m),l.indexOf("true")>=0){var q=parseFloat(l.split("|")[2].split(",")[0]),r=parseFloat(l.split("|")[2].split(",")[1]),s=parseFloat(l.split("|")[3].split(",")[0]),t=parseFloat(l.split("|")[3].split(",")[1]),u={x:q,y:r},v={x:s,y:t},p=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"red",strokeColor:"red",lineWeight:2});b.overLayer.setStyle(p);var e=b.overLayer._ctx;gEcnu.Util.setStyle(e,p),gEcnu.Graph.drawLine(e,u,v)}}if(g>=1){var p=new gEcnu.Style({opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});b.overLayer.setStyle(p);var e=b.overLayer._ctx;gEcnu.Util.setStyle(e,p);var w=gEcnu.Util.worldToScreen(f[g-1].x,f[g-1].y);gEcnu.Graph.drawLine(e,w,d),gEcnu.Graph.drawLines_geo(e,f)}gEcnu.Graph.drawPoints_geo(e,f);break;case"drawPolygon":var f=gEcnu.Edit.draw_polygon_points,g=f.length,h=gEcnu.DrawFeature.setting,i=h._catchable,j=h._layer;if(b.overLayer.clear(),b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.draw,i){var k="",l="",m=j.getAllFeatures();if(k=gEcnu.Graph.catchPoint(d,m),k.indexOf("true")>=0){b.overLayer.clear(),b.mLayer.getLayerContainer().style.cursor="crosshair";var n=parseFloat(k.split("|")[1].split(",")[0]),o=parseFloat(k.split("|")[1].split(",")[1]);d={x:n,y:o};var p=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"red",strokeColor:"red",lineWeight:2});b.overLayer.setStyle(p);var e=b.overLayer._ctx;gEcnu.Util.setStyle(e,p),gEcnu.Graph.drawPoint(e,d)}else if(l=gEcnu.Graph.catchLine(d,m),l.indexOf("true")>=0){var q=parseFloat(l.split("|")[2].split(",")[0]),r=parseFloat(l.split("|")[2].split(",")[1]),s=parseFloat(l.split("|")[3].split(",")[0]),t=parseFloat(l.split("|")[3].split(",")[1]),u={x:q,y:r},v={x:s,y:t},p=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"red",strokeColor:"red",lineWeight:2});b.overLayer.setStyle(p);var e=b.overLayer._ctx;gEcnu.Util.setStyle(e,p),gEcnu.Graph.drawLine(e,u,v)}}if(g>=1){var p=new gEcnu.Style({opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});b.overLayer.setStyle(p);var e=b.overLayer._ctx;gEcnu.Util.setStyle(e,p);var w=gEcnu.Util.worldToScreen(f[g-1].x,f[g-1].y);if(gEcnu.Graph.drawLine(e,w,d),g>=2){var x=gEcnu.Util.worldToScreen(f[0].x,f[0].y);gEcnu.Graph.drawLine(e,x,d)}gEcnu.Graph.drawLines_geo(e,f),k.indexOf("true")>=0&&gEcnu.Graph.drawPoint(e,d)}gEcnu.Graph.drawPoints_geo(e,f);break;case"moveNode_mouseDwon":case"selectPolygon":if(b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.select,null!=gEcnu.Edit.selectedPolygon&&gEcnu.EditFeature.setting._reshape){b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.select;for(var y=gEcnu.Edit.selectedPolygon._lineRings.length,z=0;y>z;z++)for(var A=gEcnu.Edit.selectedPolygon._lineRings[z].points,B=A.length,C=0;B>C;C++){var D=gEcnu.Util.worldToScreen(A[C].x,A[C].y),E=Math.sqrt((d.x-D.x)*(d.x-D.x)+(d.y-D.y)*(d.y-D.y));if(5>E)return gEcnu.Edit.Poly_selPoint_index=C,gEcnu.Edit.Poly_sellineRing_index=z,b.mLayer.getLayerContainer().style.cursor="move",void b.setMode("moveNode_mouseDwon")}}b.setMode("selectPolygon");break;case"moveNode":if(-1!=gEcnu.Edit.Poly_selPoint_index){var F=gEcnu.Edit.selectedPolygon,G=F._lineRings[gEcnu.Edit.Poly_sellineRing_index].points[gEcnu.Edit.Poly_selPoint_index],H=F._lineRings[gEcnu.Edit.Poly_sellineRing_index].points.length,I=F._lineRings[gEcnu.Edit.Poly_sellineRing_index].points[H-1],h=gEcnu.EditFeature.setting,i=h._catchable,j=h._layer;if(b.overLayer.clear(),i){for(var J=j.getAllFeatures(),K=new Array,z=0;z<J.length;z++)J[z]!=F&&K.push(J[z]);var k=gEcnu.Graph.catchPoint(d,K);if(k.indexOf("true")>=0){b.mLayer.getLayerContainer().style.cursor="crosshair";var n=parseFloat(k.split("|")[1].split(",")[0]),o=parseFloat(k.split("|")[1].split(",")[1]);d={x:n,y:o},G.x=parseFloat(k.split("|")[1].split(",")[2]),G.y=parseFloat(k.split("|")[1].split(",")[3]),0==gEcnu.Edit.Poly_selPoint_index&&(I.x=G.x,I.y=G.y);var e=b.overLayer._ctx;gEcnu.Graph.drawPoint(e,d)}else{b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.select;var l=gEcnu.Graph.catchLine(d,K);if(l.indexOf("true")>=0){b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.select;var q=parseFloat(l.split("|")[2].split(",")[0]),r=parseFloat(l.split("|")[2].split(",")[1]),s=parseFloat(l.split("|")[3].split(",")[0]),t=parseFloat(l.split("|")[3].split(",")[1]),u={x:q,y:r},v={x:s,y:t};G.x=parseFloat(l.split("|")[1].split(",")[2]),G.y=parseFloat(l.split("|")[1].split(",")[3]),0==gEcnu.Edit.Poly_selPoint_index&&(I.x=G.x,I.y=G.y);var e=b.overLayer._ctx;gEcnu.Graph.drawLine(e,u,v)}else{b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.select;var v=gEcnu.Util.screenToWorld(d.x,d.y);G.x=v.x,G.y=v.y,0==gEcnu.Edit.Poly_selPoint_index&&(I.x=G.x,I.y=G.y)}}var e=b.overLayer._ctx,L=new gEcnu.Style({opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});b.overLayer.setStyle(L),gEcnu.Util.setStyle(e,L),gEcnu.Graph.drawPoints_geo(e,F._lineRings[gEcnu.Edit.Poly_sellineRing_index].points);var M=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});b.overLayer.setStyle(M),gEcnu.Util.setStyle(e,M),gEcnu.Graph.drawLines_geo(e,F._lineRings[gEcnu.Edit.Poly_sellineRing_index].points)}else{b.mLayer.getLayerContainer().style.cursor="pointer";var v=gEcnu.Util.screenToWorld(d.x,d.y);G.x=v.x,G.y=v.y,0==gEcnu.Edit.Poly_selPoint_index&&(I.x=G.x,I.y=G.y);var e=b.overLayer._ctx,L=new gEcnu.Style({opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});b.overLayer.setStyle(L),gEcnu.Util.setStyle(e,L),gEcnu.Graph.drawPoints_geo(e,F._lineRings[gEcnu.Edit.Poly_sellineRing_index].points);var M=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});b.overLayer.setStyle(M),gEcnu.Util.setStyle(e,M),gEcnu.Graph.drawLines_geo(e,F._lineRings[gEcnu.Edit.Poly_sellineRing_index].points)}}break;case"addPoint":var l="false";if(null==gEcnu.Edit.selectedPolygon)return;if(l=gEcnu.Graph.catchLine(d,[gEcnu.Edit.selectedPolygon]),l.indexOf("true")>=0){b.mLayer.getLayerContainer().style.cursor="crosshair";var N=parseFloat(l.split("|")[1].split(",")[0]),O=parseFloat(l.split("|")[1].split(",")[1]),e=b.overLayer._ctx;gEcnu.Edit.selectedPolygon.onSelect();var p=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});return b.overLayer.setStyle(p),gEcnu.Util.setStyle(e,p),void gEcnu.Graph.drawPoint(e,{x:N,y:O})}b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.select,
gEcnu.Edit.selectedPolygon.onSelect();break;case"delPoint":var k="false";if(null==gEcnu.Edit.selectedPolygon)return;if(k=gEcnu.Graph.catchPoint(d,[gEcnu.Edit.selectedPolygon]),k.indexOf("true")>=0){b.mLayer.getLayerContainer().style.cursor="pointer";var n=parseFloat(k.split("|")[1].split(",")[0]),o=parseFloat(k.split("|")[1].split(",")[1]),e=b.overLayer._ctx;gEcnu.Edit.selectedPolygon.onSelect();var p=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});return b.overLayer.setStyle(p),gEcnu.Util.setStyle(e,p),void gEcnu.Graph.drawPoint(e,{x:n,y:o})}b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.select,gEcnu.Edit.selectedPolygon.onSelect();break;case"moveNodeLine_mouseDwon":case"selectLine":if(b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.select,null!=gEcnu.Edit.selectedLine&&gEcnu.EditFeature.setting._reshape){b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.select;for(var y=gEcnu.Edit.selectedLine._lineStrings.length,z=0;y>z;z++)for(var A=gEcnu.Edit.selectedLine._lineStrings[z].points,B=A.length,C=0;B>C;C++){var D=gEcnu.Util.worldToScreen(A[C].x,A[C].y),E=Math.sqrt((d.x-D.x)*(d.x-D.x)+(d.y-D.y)*(d.y-D.y));if(5>E)return gEcnu.Edit.Line_sellineString_index=z,gEcnu.Edit.Line_selPoint_index=C,b.mLayer.getLayerContainer().style.cursor="move",void b.setMode("moveNodeLine_mouseDwon")}}b.setMode("selectLine");break;case"selectPoint":case"selectText":b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.select;break;case"moveNode_Line":if(-1!=gEcnu.Edit.Line_selPoint_index){var P=gEcnu.Edit.selectedLine,G=P._lineStrings[gEcnu.Edit.Line_sellineString_index].points[gEcnu.Edit.Line_selPoint_index],h=gEcnu.EditFeature.setting,i=h._catchable,j=h._layer;if(b.overLayer.clear(),i){for(var J=j.getAllFeatures(),K=new Array,z=0;z<J.length;z++)J[z]!=P&&K.push(J[z]);var k=gEcnu.Graph.catchPoint(d,K);if(k.indexOf("true")>=0){b.mLayer.getLayerContainer().style.cursor="crosshair";var n=parseFloat(k.split("|")[1].split(",")[0]),o=parseFloat(k.split("|")[1].split(",")[1]);d={x:n,y:o},G.x=parseFloat(k.split("|")[1].split(",")[2]),G.y=parseFloat(k.split("|")[1].split(",")[3]);var e=b.overLayer._ctx;gEcnu.Graph.drawPoint(e,d)}else{b.mLayer.getLayerContainer().style.cursor="move";var l=gEcnu.Graph.catchLine(d,K);if(l.indexOf("true")>=0){b.mLayer.getLayerContainer().style.cursor="default";var q=parseFloat(l.split("|")[2].split(",")[0]),r=parseFloat(l.split("|")[2].split(",")[1]),s=parseFloat(l.split("|")[3].split(",")[0]),t=parseFloat(l.split("|")[3].split(",")[1]),u={x:q,y:r},v={x:s,y:t};G.x=parseFloat(l.split("|")[1].split(",")[2]),G.y=parseFloat(l.split("|")[1].split(",")[3]);var e=b.overLayer._ctx;gEcnu.Graph.drawLine(e,u,v)}else{b.mLayer.getLayerContainer().style.cursor="move";var v=gEcnu.Util.screenToWorld(d.x,d.y);G.x=v.x,G.y=v.y}}var e=b.overLayer._ctx;gEcnu.Graph.drawPoints_geo(e,P._lineStrings[gEcnu.Edit.Line_sellineString_index].points),gEcnu.Graph.drawLines_geo(e,P._lineStrings[gEcnu.Edit.Line_sellineString_index].points)}else{b.mLayer.getLayerContainer().style.cursor="pointer";var v=gEcnu.Util.screenToWorld(d.x,d.y);G.x=v.x,G.y=v.y;var e=b.overLayer._ctx;gEcnu.Graph.drawPoints_geo(e,P._lineStrings[gEcnu.Edit.Line_sellineString_index].points),gEcnu.Graph.drawLines_geo(e,P._lineStrings[gEcnu.Edit.Line_sellineString_index].points)}}break;case"addPoint_line":var l="false";if(null==gEcnu.Edit.selectedLine)return;if(l=gEcnu.Graph.catchLine(d,[gEcnu.Edit.selectedLine]),l.indexOf("true")>=0){b.mLayer.getLayerContainer().style.cursor="crosshair";var N=parseFloat(l.split("|")[1].split(",")[0]),O=parseFloat(l.split("|")[1].split(",")[1]),e=b.overLayer._ctx;gEcnu.Edit.selectedLine.onSelect();var p=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});return b.overLayer.setStyle(p),gEcnu.Util.setStyle(e,p),void gEcnu.Graph.drawPoint(e,{x:N,y:O})}b.mLayer.getLayerContainer().style.cursor="default",gEcnu.Edit.selectedLine.onSelect();break;case"delPoint_line":var k="false";if(null==gEcnu.Edit.selectedLine)return;if(k=gEcnu.Graph.catchPoint(d,[gEcnu.Edit.selectedLine]),k.indexOf("true")>=0){b.mLayer.getLayerContainer().style.cursor="pointer";var n=parseFloat(k.split("|")[1].split(",")[0]),o=parseFloat(k.split("|")[1].split(",")[1]),e=b.overLayer._ctx;gEcnu.Edit.selectedLine.onSelect();var p=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});return b.overLayer.setStyle(p),gEcnu.Util.setStyle(e,p),void gEcnu.Graph.drawPoint(e,{x:n,y:o})}b.mLayer.getLayerContainer().style.cursor="default",gEcnu.Edit.selectedLine.onSelect();break;case"drawRect":b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.draw;var Q=gEcnu.Util.screenToWorld(d.x,d.y);new gEcnu.Geometry.Point(Q.x,Q.y);if(gEcnu.Edit.draw_rect_points.length>0){gSelf.overLayer.clear();var e=gSelf.overLayer.getCtx();e.strokeStyle="red";var R=d.x-gSelf.startX,S=d.y-gSelf.startY;e.strokeRect(gSelf.startX,gSelf.startY,R,S)}break;case"drawCircle":b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.draw;var Q=gEcnu.Util.screenToWorld(d.x,d.y);new gEcnu.Geometry.Point(Q.x,Q.y);if(gEcnu.Edit.draw_circle_points.length>0){gSelf.overLayer.clear();var e=gSelf.overLayer.getCtx();e.strokeStyle="red",e.beginPath();var T=Math.sqrt((d.x-gSelf.startX)*(d.x-gSelf.startX)+(d.y-gSelf.startY)*(d.y-gSelf.startY));e.arc(gSelf.startX,gSelf.startY,T,0,2*Math.PI,!0),e.stroke(),e.closePath();var U=gEcnu.DrawFeature.setting.isDisplayRadius;if(U){e.beginPath(),e.moveTo(gSelf.startX,gSelf.startY),e.lineTo(d.x,d.y),e.stroke();var V=gEcnu.Util.screenToWorld_geo(d.x,d.y),W=gEcnu.Util.screenToWorld_geo(gSelf.startX,gSelf.startY),E=Math.sqrt((W.x-V.x)*(W.x-V.x)+(W.y-V.y)*(W.y-V.y)),X=(d.x+gSelf.startX)/2,Y=(d.y+gSelf.startY)/2;e.fillStyle="red",e.font="14px Arial";var Z=Number(E).toFixed(0)+"米";parseInt(E/1e3)>0&&(Z=(E/1e3).toFixed(0)+"千米"),e.fillText(Z,X-50,Y-10)}}break;case"drawMarker":b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.mark;break;case"drawPoint":b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.draw;break;case"drawText":b.mLayer.getLayerContainer().style.cursor=b.cursorStyle.draw}},gEcnu.Edit.graphMouseUpEvt=function(a,b){var c=b.getMode(),d=gEcnu.Util.getMouseXY(gSelf._container,a),e=gEcnu.Util.screenToWorld(d.x,d.y);switch(gEcnu.Edit.moving=!1,c){case"moveNode":for(var f=gEcnu.EditFeature.setting,g=f._layer,h=g.getAllFeatures(),i=[],j=0;j<h.length;j++)h[j]!=gEcnu.Edit.selectedPolygon_pre&&i.push(h[j]);var k=gEcnu.Edit.selectedPolygon._data,l={};for(var m in k)l[m]=k[m];var n=new gEcnu.Feature.Polygon(gEcnu.Edit.selectedPolygon._lineRings,l);i.push(n),gEcnu.Edit.selectedPolygon.shape=n.shape,gEcnu.Edit.selectedPolygon_pre=n,gEcnu.Edit.selectedPolygon=n,g.removeAllFeatures(),g.addFeatures(i),n.onSelect(),b.setMode("moveNode_mouseDwon");var o=gEcnu.EditFeature.setting.events._events.updateCompleted;"undefined"!=typeof o&&o(a,n);break;case"moveNode_Line":for(var f=gEcnu.EditFeature.setting,g=f._layer,h=g.getAllFeatures(),i=[],j=0;j<h.length;j++)h[j]!=gEcnu.Edit.selectedLine_pre&&i.push(h[j]);var k=gEcnu.Edit.selectedLine._data,l={};for(var m in k)l[m]=k[m];var n=new gEcnu.Feature.Polyline(gEcnu.Edit.selectedLine._lineStrings,l);i.push(n),gEcnu.Edit.selectedLine.shape=n.shape,gEcnu.Edit.selectedLine_pre=n,gEcnu.Edit.selectedLine=n,g.removeAllFeatures(),g.addFeatures(i),n.onSelect(),b.setMode("moveNodeLine_mouseDwon");var o=gEcnu.EditFeature.setting.events._events.updateCompleted;"undefined"!=typeof o&&o(a,n);break;case"drawRect":console.log("up");var p=new gEcnu.Geometry.Point(e.x,e.y);gEcnu.Edit.draw_rect_points.push(p);var q=gEcnu.Edit.draw_rect_points[1].x,r=gEcnu.Edit.draw_rect_points[0].y,s=gEcnu.Edit.draw_rect_points[1].x,t=gEcnu.Edit.draw_rect_points[1].y,u=gEcnu.Edit.draw_rect_points[0].x,v=gEcnu.Edit.draw_rect_points[1].y,w=new gEcnu.Geometry.Point(q,r),x=new gEcnu.Geometry.Point(s,t),y=new gEcnu.Geometry.Point(u,v);gEcnu.Edit.draw_rect_points[1]=w,gEcnu.Edit.draw_rect_points.push(x),gEcnu.Edit.draw_rect_points.push(y);var z=new gEcnu.Geometry.RectRing(gEcnu.Edit.draw_rect_points),A=gEcnu.DrawFeature.setting.events._events.added;"undefined"!=typeof A&&(A(a,z),gEcnu.Edit.draw_rect_points=[]),gSelf.overLayer.clear();break;case"drawCircle":var p=new gEcnu.Geometry.Point(e.x,e.y);gEcnu.Edit.draw_circle_points.push(p);var B=gEcnu.Edit.draw_circle_points[0];if(gEcnu.Edit.draw_circle_points.length>=2){var C=gEcnu.Edit.draw_circle_points[0],D=gEcnu.Edit.draw_circle_points[1],E=Math.sqrt((D.x-C.x)*(D.x-C.x)+(D.y-C.y)*(D.y-C.y)),F=new gEcnu.Geometry.RadiusRing(B,E),A=gEcnu.DrawFeature.setting.events._events.added;"undefined"!=typeof A&&(A(a,F),gEcnu.Edit.draw_circle_points=[])}}},gEcnu.Edit.graphMouseDblClickEvt=function(a,b){var c=b.getMode();switch(c){case"drawLine":gEcnu.Edit.draw_line_points.pop();var d=new gEcnu.Geometry.LineString(gEcnu.Edit.draw_line_points),e=gEcnu.DrawFeature.setting.events._events.added;"undefined"!=typeof e&&(e(a,d),gEcnu.Edit.draw_line_points=[]),b.overLayer.clear();break;case"drawPolygon":gEcnu.Edit.draw_polygon_points.pop();var f=new gEcnu.Geometry.LinearRing(gEcnu.Edit.draw_polygon_points),e=gEcnu.DrawFeature.setting.events._events.added;"undefined"!=typeof e&&(e(a,f),gEcnu.Edit.draw_polygon_points=[]),b.overLayer.clear()}},gEcnu.Style=gClass.extend({init:function(a){this.oStyle="singleStyle",void 0==a.fillColor?this.fillColor="#00DD00":this.fillColor=a.fillColor,void 0==a.strokeColor?this.strokeColor="#00DD00":this.strokeColor=a.strokeColor,void 0==a.lineWeight?this.lineWeight=1:this.lineWeight=a.lineWeight,void 0==a.borderStatus?this.borderStatus=!0:this.borderStatus=!1,void 0==a.cirRadius?this.cirRadius=3:this.cirRadius=a.cirRadius,void 0==a.fillStatus?this.fillStatus=!0:this.fillStatus=!1,void 0==a.vtxStatus?this.vtxStatus=!1:this.vtxStatus=!0,void 0==a.vtxRadius?this.vtxRadius=3:this.vtxRadius=a.vtxRadius,void 0==a.tlr?this.tlr=5:this.tlr=a.tlr,void 0==a.opacity?this.opacity=.4:this.opacity=a.opacity,void 0==a.mappingValue?this.mappingValue="default":this.mappingValue=a.mappingValue,void 0==a.fontSize?this.fontSize=13:this.fontSize=a.fontSize,void 0==a.fontFamily?this.fontFamily="KaiTi":this.fontFamily=a.fontFamily,void 0==a.fontColor?this.fontColor="#333333":this.fontColor=a.fontColor,void 0==a.bgColor?this.bgColor="#ffffff":this.bgColor=a.bgColor}}),gEcnu.Style_Ex=gClass.extend({init:function(a,b){this.oStyle="multiStyles",this.styles=a,this.mappingField=b}}),gEcnu.Export=gClass.extend({init:function(){}}),gEcnu.exportParams={},gEcnu.exportParams.DB="mapb",gEcnu.Export.Feature=gEcnu.Export.extend({init:function(a,b,c,d){this.ftset=b,this.geodb=a,this.ftsetid=c,this.filter=d,this.webfeatureUrl=gEcnu.config.geoserver+"WebFeature",this.websqlUrl=gEcnu.config.geoserver+"WebSQL"},processAscyn:function(a,b){this._succCallback=a,this._failCallback=b;var c=this,d=(this.ftset,this.filter);this._getFtsetNum(function(a){if(!(1>a)){var b=Math.ceil(a/5e3),e=0,f=5e3*e,g=[],h={type:"FeatureCollection",FeatureNum:a,UTF8Encoding:!1},i=function(){if(e>=b)return h.features=g,void c._download(JSON.stringify(h));var a={start:f,filter:d};c._getFtsetGeojson(a,function(a){var b=a.features;void 0==h.scale&&(h.scale=a.scale),g=g.concat(b),e++,f=5e3*e,i()})};i()}})},_getFtsetNum:function(a){var b=this.ftset,c="f_"+b,d=this.websqlUrl,e=this._failCallback,f="select count(*) from "+c,g=this.geodb,h={mt:"SQLQuery",GeoDB:g,SQL:f},i=JSON.stringify(h),j={req:i};try{gEcnu.Util.ajax("POST",d,j,!0,function(b){var c=JSON.parse(b),d=c.data,e=d[0][0];a(e)})}catch(k){void 0!=e&&e()}},_getFtsetGeojson:function(a,b){var c=this.ftsetid,d=this.geodb,e=this.webfeatureUrl,f=this._failCallback,g=a.start||0,h=a.filter;h=void 0==h||""==h?"1=1":h;var i=h+" limit 5000 offset "+g,j={mt:"SQLQuery",geoDB:d,ftSet:c,format:"geojson",zip:!0,sql:i,"return":{shape:1,fields:"%all%"}},k=JSON.stringify(j),l={req:k};try{gEcnu.Util.ajax("POST",e,l,!0,function(a){var c=JSON.parse(a),d=gEcnu.Util.decode(c);void 0!=b&&b(d)})}catch(m){void 0!=f&&f()}},_download:function(a){var b=this._succCallback,c=this._failCallback,d=this.ftset,e=new Blob([a],{type:"text"}),f=document.getElementById("downloadFtsetBtn");void 0==f&&(f=document.createElement("a"),f.id="downloadFtsetBtn",f.style.display="none",f.target="_blank",document.body.appendChild(f));try{var g=window.URL||window.webkitURL;f.href=g.createObjectURL(e),f.download=d+".json","function"==typeof navigator.msSaveBlob&&navigator.msSaveBlob(e,d+".json"),f.click(),void 0!=b&&b()}catch(h){void 0!=c&&c()}}}),gEcnu.Export.Data=gEcnu.Export.extend({init:function(a,b,c){this.tabName=b,this.filter=c,this.geodb=a,this.websqlUrl=gEcnu.config.geoserver+"WebSQL"},processAscyn:function(a,b){this._succCallback=a,this._failCallback=b;var c=this;this.tabName,this.filter;this._getTabData(function(a){for(var b="",d=a.fldsDef,e=[],f=0,g=d.length;g>f;f++){var h=d[f].name;e.push(h)}var i=e.join(",");b=b+i+"\r\n";for(var j=0,k=a.data.length;k>j;j++){var l=a.data[j];b+=l.join(",")+"\r\n"}c._download(b)})},_getTabData:function(a){var b=this.websqlUrl,c=this.tabName,d=this.filter,e=this.geodb;if(void 0!=d&&""!=d)var f="select * from "+c+" where "+d;else var f="select * from "+c;var g={mt:"SQLQuery",GeoDB:e,SQL:f},h=JSON.stringify(g),i={req:h};try{gEcnu.Util.ajax("POST",b,i,!0,function(b){var c=JSON.parse(b);a(c)})}catch(j){void 0!=failCallback&&failCallback()}},_download:function(a){var b=this._succCallback,c=this._failCallback,d=this.tabName,e=new Blob([a],{type:"text"}),f=document.getElementById("downloadTabBtn");void 0==f&&(f=document.createElement("a"),f.id="downloadTabBtn",f.style.display="none",f.download=d+".csv",f.target="_blank",document.body.appendChild(f));try{var g=window.URL||window.webkitURL;f.href=g.createObjectURL(e),"function"==typeof navigator.msSaveBlob&&navigator.msSaveBlob(e,d+".csv"),f.click(),void 0!=b&&b()}catch(h){void 0!=c&&c()}}}),gEcnu.Upload=gClass.extend({init:function(a,b){var c=gEcnu.config.cat||"data/userdata/upload/";this.requrl=gEcnu.config.geoserver+"fileserver?req=putstream&cat="+c+"&fn="+b+"/",this.uploadSizeByBlock=1e6,this.files=a,this.inum=0,this.itotal=0,this.uploaded=0,this.abortFlag=!1,this.totalFileSize=this._getFilesize()},processAscyn:function(a,b){this.fileCount=0,this.succCallback=arguments[0]?arguments[0]:function(){},this.failCallback=arguments[1]?arguments[1]:function(){};var c=this.files;return c.length?void this._uploadFile():(alert("请选择文件"),!1)},_uploadFile:function(){var a=this.files,b=a.length;if(this.fileCount>b-1)return void this.succCallback();var c=a[this.fileCount],d=c.size;if(d>2147483648)return alert("文件太大"),!1;var e=this.uploadSizeByBlock,f=d/e;this.inum=0,this.itotal=f,this._uploadblob(c,0,e-1)},_uploadblob:function(a,b,c){var d=this,e=new FileReader;if(c>=a.size&&(c=a.size-1),!(b>c)){var f,g=c-b+1;a.webkitSlice?f=a.webkitSlice(b,c+1):a.mozSlice?f=a.mozSlice(b,c+1):a.slice&&(f=a.slice(b,c+1)),this.abortFlag||(e.onloadend=function(){a.type.search(/zip/)>=0&&d.requrl.replace(/putstream/,"putzip");var c=d.requrl+a.name;$.ajax({async:!0,url:c,type:"POST",contentType:"application/octet-stream",processData:!1,headers:{filesize:a.size,start:b,blobsize:g},data:this.result,success:function(){f=null,this.result=null,d.inum++,d.uploaded=d.uploaded+g,d.onProgress(d.uploaded,d.totalFileSize),d.inum>d.itotal?(d.fileCount++,d._uploadFile()):d._uploadblob(a,d.inum*g,(d.inum+1)*g-1)},error:function(){d.failCallback()}})},e.readAsArrayBuffer(f))}},events:{on:function(a,b){switch(a){case"onProgress":b&&(gEcnu.Upload.prototype.onProgress=function(a,c){b(a,c)})}}},_getFilesize:function(){var a=this.files,b=0;if(!a.length)return 0;for(var c=0,d=a.length;d>c;c++)b+=a[c].size;return b},abort:function(){this.abortFlag=!0},setParam:function(a){this.uploadSizeByBlock=sliceSize}}),gEcnu.Upload.prototype.onProgress=function(){},gEcnu.UploadString=gClass.extend({init:function(a,b,c){var d=arguments.length;b=d>1?arguments[1]:"index.html",c=d>2?arguments[2]:"data/userdata/",this.requrl=gEcnu.config.geoserver+"fileserver?req=putstring",this.param={fn:b,cat:c,con:a}},processAscyn:function(a,b){var c=this.requrl;this.succCallback=arguments.length>0?arguments[0]:function(){},this.failCallback=arguments.length>1?arguments[1]:function(){};var d=this,e=this.param;$.ajax({async:!0,url:c,type:"POST",data:e,success:function(){d.succCallback()},error:function(){d.failCallback()}})}}),gEcnu.UploadBase64=gClass.extend({}),gEcnu.UploadCSVToDB=gClass.extend({init:function(a){this.file=a},processAscyn:function(a,b){this.succCallback=a,this.failCallback=b;var c=this.file,d=c.name.split(".")[0],e=this,f=new FileReader;f.readAsText(c,"UTF-8"),f.onload=function(){var a=this.result;e._read2DB(d,a)}},_read2DB:function(a,b){var c=this,d=b.split(/\r\n/);if(!(d.length<1)){var e=d[0];c._createDBTab(a,e,function(){c._insert2DBTab(a,d)})}},_createDBTab:function(a,b,c){var d=gEcnu.config.geoserver+"WebSQL",e=this.failCallback,f=b,g="create table if not exists "+a+" ("+f+")",h={mt:"SQLExec",GeoDB:"publicdb",SQL:g},i=JSON.stringify(h),j={req:i};try{gEcnu.Util.ajax("POST",d,j,!0,function(a){void 0!=c&&c()})}catch(k){void 0!=e&&e()}},_insert2DBTab:function(a,b){var c=gEcnu.config.geoserver+"WebSQL",d=this.succCallback,e=this.failCallback;if(!(b.length<=1)){for(var f=b[0].split(","),g=[],h=1,i=b.length;i>h;h++){var j=b[h];if(""!=j){var k=j.split(",");g.push(k)}}var l={mt:"SQLInsert",GeoDB:"publicdb",tablename:a,fldnames:f,data:g},m=JSON.stringify(l),n={req:m};try{gEcnu.Util.ajax("POST",c,n,!0,function(a){void 0!=d&&d()})}catch(o){void 0!=e&&e()}}}}),gEcnu.DynLayerStyle=gClass.extend({init:function(a,b,c){this.ws=a,this.lyrName=b},update:function(){}}),gEcnu.DynLayerStyle.PointStyle=gEcnu.DynLayerStyle.extend({init:function(a,b,c){this._super(a,b),this.ptStyle=c,this._getmapName()},_getmapName:function(){var a=this.ws;a.indexOf("/")>0?(this.dbName=a.split("/")[0],this.mapName=a.split("/")[1]):(this.dbName="ecnugis",this.mapName=a)},update:function(a){var b=this,c=this.dbName,d=this.mapName,e=this.lyrName;this.succCallback=a?a.success:function(){},this.failCallback=a?a.fail:function(){};var f=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(a){var c=a[0]["g_layers.map_id"],d={},f=b._getNewLyrStyle(a),g=b._getLabelStyle_all(a[0].labelstyle),h=b._getZindex();h&&(d.zIndex=h),f&&(d.lyrStyle=f),g&&(d.labelStyle_all=g),b._exec(c,e,d)},processFailed:function(){}}),g={lyr:"g_layers,g_map",fields:"lyr_style,labelstyle,g_layers.map_id",filter:"lyr_name='"+e+"'and g_map.map_id=g_layers.map_id and g_map.map_id='"+d+"'"};f.processAscyn(gEcnu.ActType.SQLQUERY,c,g)},_getNewLyrStyle:function(a){var b=this.ptStyle,c=b.color,d=b.size,e=a[0].lyr_style,f=(a[0]["g_layers.map_id"],e.split(",")),g=f[2],h=f[3];void 0!=c&&(g=this._webColor2dbcolor(c)),void 0!=d&&(h=d),f[2]=g,f[3]=h;var i=f.join(",");return i},_getLabelStyle_all:function(a){var b=this.ptStyle,c=b.autoLabel,d=b.labelField,e=b.labelStyle,f={},g=a.split(",");if(void 0!=c&&(f.autoLabel=c),d&&""!=d&&(f.labelField=d),e&&""!=e){var h=e.fontColor,i=e.fontType?e.fontType:g[1],j=h?this._webColor2dbcolor(h):g[2],k=e.fontSize?"-"+e.fontSize:g[3],l=e.fontStyle?e.fontStyle:g[4];f.labelStyle="134,"+i+","+j+","+k+","+l}return f},_getZindex:function(){var a=this.ptStyle,b=a.zIndex;return b&&""!=b?b:!1},_exec:function(a,b,c){var d=this.succCallback,e=this.failCallback,f=this.dbName,g=c.lyrStyle,h=c.labelStyle_all,i=c.zIndex,j="",k=g?"lyr_style='"+g+"'":"",l=i?"z_index="+i:"",m=void 0!=h.autoLabel?"autolabel="+h.autoLabel:"",n=void 0!=h.labelField?"lablefield='"+h.labelField+"'":"",o=void 0!=h.labelStyle?"labelstyle='"+h.labelStyle+"'":"";if(""!=k&&(j+=k+","),""!=l&&(j+=l+","),""!=m&&(j+=m+","),""!=n&&(j+=n+","),""!=o&&(j+=o+","),j=j.substr(0,j.length-1),""!=j){var p=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(a){void 0!=d&&d()},processFailed:function(){void 0!=e&&e()}}),q="update g_layers set "+j+" where map_id="+a+" and lyr_name='"+b+"'";p.processAscyn(gEcnu.ActType.SQLEXEC,f,q)}},_webColor2dbcolor:function(a){var b=a.substring(1),c=b.substr(0,2),d=b.substr(2,2),e=b.substr(4,2);return newColor="$00"+e+d+c,newColor},_getColor:function(a){}}),gEcnu.DynLayerStyle.LineStyle=gEcnu.DynLayerStyle.extend({init:function(a,b,c){this._super(a,b),this.lineStyle=c,this._getmapName()},_getmapName:function(){var a=this.ws;a.indexOf("/")>0?(this.dbName=a.split("/")[0],this.mapName=a.split("/")[1]):(this.dbName="ecnugis",this.mapName=a)},update:function(a){var b=this,c=this.dbName,d=this.mapName,e=this.lyrName;this.succCallback=a?a.success:function(){},this.failCallback=a?a.fail:function(){};var f=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(a){var c=a[0]["g_layers.map_id"],d={},f=b._getNewLyrStyle(a),g=b._getLabelStyle_all(a[0].labelstyle),h=b._getZindex();h&&(d.zIndex=h),f&&(d.lyrStyle=f),g&&(d.labelStyle_all=g),b._exec(c,e,d)},processFailed:function(){}}),g={lyr:"g_layers,g_map",fields:"lyr_style,labelstyle,g_layers.map_id",filter:"lyr_name='"+e+"'and g_map.map_id=g_layers.map_id and g_map.map_id='"+d+"'"};f.processAscyn(gEcnu.ActType.SQLQUERY,c,g)},_getNewLyrStyle:function(a){var b,c,d,e=this.lineStyle,f=e.lineType,g=e.strokeColor,h=e.lineWidth,i=a[0].lyr_style,j=(a[0]["g_layers.map_id"],i.split(","));c=void 0!=g?this._webColor2dbcolor(g):j[1],b=void 0!=f?f:j[0],d=void 0!=h?h:j[2],j[0]=b,j[1]=c,j[2]=d;var k=j.join(",");return k},_getLabelStyle_all:function(a){var b=this.lineStyle,c=b.autoLabel,d=b.labelField,e=b.labelStyle,f={},g=a.split(",");if(void 0!=c&&(f.autoLabel=c),d&&""!=d&&(f.labelField=d),e&&""!=e){var h=e.fontColor,i=e.fontType?e.fontType:g[1],j=h?this._webColor2dbcolor(h):g[2],k=e.fontSize?"-"+e.fontSize:g[3],l=e.fontStyle?e.fontStyle:g[4];f.labelStyle="134,"+i+","+j+","+k+","+l}return f},_getZindex:function(){var a=this.lineStyle,b=a.zIndex;return b&&""!=b?b:!1},_exec:function(a,b,c){var d=this.succCallback,e=this.failCallback,f=this.dbName,g=c.lyrStyle,h=c.labelStyle_all,i=c.zIndex,j="",k=g?"lyr_style='"+g+"'":"",l=i?"z_index="+i:"",m=void 0!=h.autoLabel?"autolabel="+h.autoLabel:"",n=void 0!=h.labelField?"lablefield='"+h.labelField+"'":"",o=void 0!=h.labelStyle?"labelstyle='"+h.labelStyle+"'":"";if(""!=k&&(j+=k+","),""!=l&&(j+=l+","),""!=m&&(j+=m+","),""!=n&&(j+=n+","),""!=o&&(j+=o+","),j=j.substr(0,j.length-1),""!=j){var p=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(a){void 0!=d&&d()},processFailed:function(){void 0!=e&&e()}}),q="update g_layers set "+j+" where map_id="+a+" and lyr_name='"+b+"'";p.processAscyn(gEcnu.ActType.SQLEXEC,f,q)}},_webColor2dbcolor:function(a){var b=a.substring(1),c=b.substr(0,2),d=b.substr(2,2),e=b.substr(4,2);return newColor="$00"+e+d+c,newColor},_getColor:function(a){}}),gEcnu.DynLayerStyle.PolygonStyle=gEcnu.DynLayerStyle.extend({init:function(a,b,c){this._super(a,b),this.polyStyle=c,this._getmapName()},_getmapName:function(){var a=this.ws;a.indexOf("/")>0?(this.dbName=a.split("/")[0],this.mapName=a.split("/")[1]):(this.dbName="ecnugis",this.mapName=a)},update:function(a){var b=this,c=this.dbName,d=this.mapName,e=this.lyrName;this.succCallback=a?a.success:function(){},this.failCallback=a?a.fail:function(){};var f=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(a){var c=a[0]["g_layers.map_id"],d={},f=b._getNewLyrStyle(a),g=b._getLabelStyle_all(a[0].labelstyle),h=b._getZindex();h&&(d.zIndex=h),f&&(d.lyrStyle=f),g&&(d.labelStyle_all=g),b._exec(c,e,d)},processFailed:function(){}}),g={lyr:"g_layers,g_map",fields:"lyr_style,labelstyle,g_layers.map_id",filter:"lyr_name='"+e+"'and g_map.map_id=g_layers.map_id and g_map.map_id='"+d+"'"};f.processAscyn(gEcnu.ActType.SQLQUERY,c,g)},_getNewLyrStyle:function(a){var b,c,d,e,f,g=this.polyStyle,h=g.borderType,i=g.strokeColor,j=g.borderWidth,k=g.fillType,l=g.fillColor,m=a[0].lyr_style,n=(a[0]["g_layers.map_id"],m.split(","));b=void 0!=h?h:n[0],c=i?this._webColor2dbcolor(i):n[1],d=void 0!=j?j:n[2],e=void 0!=k?k:n[3],f=l?this._webColor2dbcolor(l):n[4],n[0]=b,n[1]=c,n[2]=d,n[3]=e,n[4]=f;var o=n.join(",");return o},_getLabelStyle_all:function(a){var b=this.polyStyle,c=b.autoLabel,d=b.labelField,e=b.labelStyle,f={},g=a.split(",");if(void 0!=c&&(f.autoLabel=c),d&&""!=d&&(f.labelField=d),e&&""!=e){var h=e.fontColor,i=e.fontType?e.fontType:g[1],j=h?this._webColor2dbcolor(h):g[2],k=e.fontSize?"-"+e.fontSize:g[3],l=e.fontStyle?e.fontStyle:g[4];f.labelStyle="134,"+i+","+j+","+k+","+l}return f},_getZindex:function(){var a=this.polyStyle,b=a.zIndex;return b&&""!=b?b:!1},_exec:function(a,b,c){var d=this.dbName,e=this.succCallback,f=this.failCallback,g=c.lyrStyle,h=c.labelStyle_all,i=c.zIndex,j="",k=g?"lyr_style='"+g+"'":"",l=i?"z_index="+i:"",m=void 0!=h.autoLabel?"autolabel="+h.autoLabel:"",n=void 0!=h.labelField?"lablefield='"+h.labelField+"'":"",o=void 0!=h.labelStyle?"labelstyle='"+h.labelStyle+"'":"";if(""!=k&&(j+=k+","),""!=l&&(j+=l+","),""!=m&&(j+=m+","),""!=n&&(j+=n+","),""!=o&&(j+=o+","),j=j.substr(0,j.length-1),""!=j){var p=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(a){void 0!=e&&e()},processFailed:function(){void 0!=f&&f()}}),q="update g_layers set "+j+" where map_id="+a+" and lyr_name='"+b+"'";p.processAscyn(gEcnu.ActType.SQLEXEC,d,q)}},_webColor2dbcolor:function(a){var b=a.substring(1),c=b.substr(0,2),d=b.substr(2,2),e=b.substr(4,2);return newColor="$00"+e+d+c,newColor},_get16Color:function(a){}}),gEcnu.DynLayerStyle.getStyle=gEcnu.DynLayerStyle.extend({init:function(a,b){this.ws=a,this.lyrArr=b,this._getmapName()},processAscyn:function(a,b){this.succCallback=arguments.length>0?arguments[0]:function(){},this.failCallback=arguments.length>1?arguments[1]:function(){},this._queryStyle()},_getmapName:function(){var a=this.ws;a.indexOf("/")>0?(this.dbName=a.split("/")[0],this.mapName=a.split("/")[1]):(this.dbName="ecnugis",this.mapName=a)},_queryStyle:function(){for(var a=this,b=(this.ws,this.lyrArr),c=this.dbName,d=this.mapName,e="",f=0,g=b.length;g>f;f++)e+=f!=g-1?"'"+b[f]+"',":"'"+b[f]+"'";e=" ("+e+") ";var h=this._processResult,i=this.failCallback,j=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(b){a.bindContext(a,h,[b])},processFailed:function(){i()}}),k={lyr:"g_layers,g_map",fields:"lyr_name,alias,lyr_type,autolabel,lyr_style,labelstyle,lablefield",filter:"lyr_name in"+e+"and g_map.map_id=g_layers.map_id and g_map.map_id="+d};j.processAscyn(gEcnu.ActType.SQLQUERY,c,k)},_processResult:function(a){for(var b=this.succCallback,c=[],d=0,e=a.length;e>d;d++){var f=a[d],g=f.lyr_name,h=f.alias,i=f.lyr_type,j=f.lyr_style,k=f.labelstyle,l=f.autolabel,m=f.lablefield,n=this._getLyrStyle(i,j),o=this._getLabelStyle(l,m,k),p={lyrName:g,alias:h,shpType:i,lyrStyle:n,labelStyle:o};c.push(p)}b(c)},_getLabelStyle:function(a,b,c){var d={},e=c.split(","),f=e[1]||"宋体",g=gEcnu.Util.dbColor2webColor(e[2]),h=e[3].toString().substring(1);return d={autoLabel:a,labelFld:b,fontFamily:f,fontColor:g,fontSize:h}},_getLyrStyle:function(a,b){var c=b.split(","),d={};switch(a){case 1:case 8:var e=gEcnu.Util.dbColor2webColor(c[2]),f=c[3];d={radius:f,fillColor:e};break;case 3:var g=gEcnu.Util.dbColor2webColor(c[1]),h=c[2];d={strokeColor:g,lineWidth:h};break;case 5:var g=gEcnu.Util.dbColor2webColor(c[1]),h=c[2],e=(c[3],gEcnu.Util.dbColor2webColor(c[4]));d={strokeColor:g,lineWidth:h,fillColor:e}}return d},bindContext:function(a,b,c){b.apply(a,c)}}),gEcnu.polyNode={hexNode:function(a,b,c,d){this.id=a,this.x=b,this.y=c,this.r=d,this.arnd={up:null,rup:null,rdwn:null,dwn:null,ldwn:null,lup:null},this.contain=null},squareNode:function(){}},gEcnu.Grid=gClass.extend({init:function(a,b){this.cent_x=a,this.cent_y=b}}),gEcnu.Grid.hexGrid=gEcnu.Grid.extend({init:function(a,b,c,d){this._super(a,b),this.init_lev="0",this.init_r=c;var e=0;if(d.hasOwnProperty("R")){var f=d.R;e=this.getMaxCirNum(f,c)}else{if(!d.hasOwnProperty("cirNum"))return void console.log("定义出错，请检查赋值对象");e=d.cirNum}this.cirNum=e,this.sqr3=Math.sqrt(3),this.initNd=new gEcnu.polyNode.hexNode("0_0_0",a,b,c),this.grid={lev_0:{ele:{"0_0_0":this.initNd},cirNum:e,leng:0}},this.createNode()},getMaxCirNum:function(a,b){var c=(2*a-b)/(3*b);return c},createNode:function(){for(var num=this.cirNum,sqr3=this.sqr3,init_r=this.init_r,cntx=this.cent_x,cnty=this.cent_y,last_mx,last_my,last_sx,last_sy,m=0;num>=0;){var count=1,lev=m;r=init_r*Math.pow(sqr3,m);var dlt1=3*r/2,dlt2=r*sqr3/2;0!=m&&(this.grid["lev_"+lev]=new Object,this.grid["lev_"+lev].ele=new Object,this.grid["lev_"+lev].ele[lev+"_0_0"]=new gEcnu.polyNode.hexNode(lev+"_0_0",this.cent_x,this.cent_y,r));for(var i=0;num>i;i++)for(var k=i+1,j=0;6*k>j;j++){if(m%2==0)if(0==j){last_mx=cntx,last_my=cnty+2*k*dlt2;var tmpNd=new gEcnu.polyNode.hexNode(lev+"_"+k+"_0",last_mx,last_my,r)}else{var xgn=this._getSign(j,k,0).xgn,ygn=this._getSign(j,k,0).ygn;last_mx=""==xgn?last_mx:eval(last_mx+xgn+dlt1),last_my=eval(last_my+ygn+dlt2);var tmpNd=new gEcnu.polyNode.hexNode(lev+"_"+k+"_"+j,last_mx,last_my,r)}else if(0==j){last_sx=cntx-2*k*dlt2,last_sy=cnty;var tmpNd=new gEcnu.polyNode.hexNode(lev+"_"+k+"_0",last_sx,last_sy,r)}else{var xgn=this._getSign(j,k,1).xgn,ygn=this._getSign(j,k,1).ygn;last_sx=eval(last_sx+xgn+dlt2),last_sy=""==ygn?last_sy:eval(last_sy+ygn+dlt1);var tmpNd=new gEcnu.polyNode.hexNode(lev+"_"+k+"_"+j,last_sx,last_sy,r)}count++,this.grid["lev_"+lev].ele[tmpNd.id]=tmpNd}this.grid["lev_"+lev].leng=count,this.grid["lev_"+lev].cirNum=num,num>0&&this.addArndAttr4node(this.grid["lev_"+lev]),num=0==num?-1:lev%2==0?Math.floor((sqr3*(2*num+1)-3)/6):Math.ceil((sqr3*(2*num+1)-3)/6),m++,lev>0&&this.addContainAttr4node(this.grid["lev_"+lev])}},addArndAttr4node:function(a){var b=a.ele;for(var c in b)if("_0_0"==c.substring(1)){var d=c.substring(0,1);b[c].arnd.up=a.ele[d+"_1_0"],b[c].arnd.rup=a.ele[d+"_1_1"],b[c].arnd.rdwn=a.ele[d+"_1_2"],b[c].arnd.dwn=a.ele[d+"_1_3"],b[c].arnd.ldwn=a.ele[d+"_1_4"],b[c].arnd.lup=a.ele[d+"_1_5"],d%2==1&&this._replaceAttr4Arnd(b[c].arnd)}else{var e=b[c];this.setAroundAttr(a,e)}},addContainAttr4node:function(a){var b=a.ele;for(var c in b)if("_0_0"==c.substring(1)){var d=parseInt(c.substring(0,1)-1);b[c].contain=this.grid["lev_"+d].ele[d+"_0_0"]}else{var e=b[c];this.setContainAttr(e)}},setAroundAttr:function(a,b){var c=b.id,d=parseInt(c.split("_")[0]),e=parseInt(c.split("_")[1]),f=parseInt(c.split("_")[2]);if(f%e==0){var g=[d+"_"+(e+1)+"_"+(f*(e+1)/e-1),d+"_"+(e+1)+"_"+f*(e+1)/e,d+"_"+(e+1)+"_"+(f*(e+1)/e+1),d+"_"+e+"_"+(f+1),d+"_"+(e-1)+"_"+f*(e-1)/e,d+"_"+e+"_"+(f-1)];if(0==f)b.arnd.up=a.ele[g[1]],b.arnd.rup=a.ele[g[2]],b.arnd.rdwn=a.ele[g[3]],b.arnd.dwn=a.ele[g[4]],b.arnd.ldwn=a.ele[d+"_"+e+"_"+(6*e-1)],b.arnd.lup=a.ele[d+"_"+(e+1)+"_"+(6*(e+1)-1)],d%2==1&&this._replaceAttr4Arnd(b.arnd);else{for(var h=f/e,i=0;h-1>i;i++)g.unshift(g.pop());b.arnd.up=a.ele[g[0]],b.arnd.rup=a.ele[g[1]],b.arnd.rdwn=a.ele[g[2]],b.arnd.dwn=a.ele[g[3]],b.arnd.ldwn=a.ele[g[4]],b.arnd.lup=a.ele[g[5]],d%2==1&&this._replaceAttr4Arnd(b.arnd)}}else{var g=[d+"_"+(e+1)+"_"+(Math.floor(f/e)*(e+1)+f%e),d+"_"+(e+1)+"_"+(Math.floor(f/e)*(e+1)+f%e+1),d+"_"+e+"_"+(f+1),d+"_"+(e-1)+"_"+(Math.floor(f/e)*(e-1)+f%e),d+"_"+(e-1)+"_"+(Math.floor(f/e)*(e-1)+f%e-1),d+"_"+e+"_"+(f-1)];if(f==6*e-1)b.arnd.up=a.ele[g[1]],b.arnd.rup=a.ele[d+"_"+e+"_0"],b.arnd.rdwn=a.ele[d+"_"+(e-1)+"_0"],b.arnd.dwn=a.ele[g[4]],b.arnd.ldwn=a.ele[g[5]],b.arnd.lup=a.ele[g[0]],d%2==1&&this._replaceAttr4Arnd(b.arnd);else{for(var h=Math.floor(f/e),i=0;h>i;i++)g.unshift(g.pop());b.arnd.up=a.ele[g[0]],b.arnd.rup=a.ele[g[1]],b.arnd.rdwn=a.ele[g[2]],b.arnd.dwn=a.ele[g[3]],b.arnd.ldwn=a.ele[g[4]],b.arnd.lup=a.ele[g[5]],d%2==1&&this._replaceAttr4Arnd(b.arnd)}}},setContainAttr:function(a){var b=a.id,c=parseInt(b.split("_")[0]),d=parseInt(b.split("_")[1]),e=parseInt(b.split("_")[2]),f=this.grid["lev_"+(c-1)].ele,g=[5,0,1,2,3,4],h=[2,3,4,5,0,1],i=Math.floor(e/d),j=e%d,k=Math.floor((d+1)/2),l=(d+1)%2;k>j&&(g[1]=6,h[4]=6);var m=c%2==1?g:h,n=c-1;if(1==l)var o=2*d-k+Math.abs(j-k),p=o*m[i]+2*(j-k);else if(j>=k)var o=2*d-k+1+Math.abs(j-k),p=o*m[i]+2*(j-k)+1;else var o=2*d-k+1+Math.abs(j-k+1),p=o*m[i]+2*(j-k+1)-1;a.contain=f[n+"_"+o+"_"+p]},getEdgeCoor:function(a,b,c,d){var e=[],f=this.sqr3;
if(0==d)var g=[a-c/2,a+c/2,a+c,a+c/2,a-c/2,a-c],h=[b+f*c/2,b+f*c/2,b,b-f*c/2,b-f*c/2,b];else var g=[a-f*c/2,a,a+f*c/2,a+f*c/2,a,a-f*c/2],h=[b+c/2,b+c,b+c/2,b-c/2,b-c,b-c/2];for(var i=0;6>i;i++){var j={};j.x=g[i],j.y=h[i],e.push(j)}return e},_getSign:function(a,b,c){var d={xgn:"",ygn:""};return 0==c?(d.ygn=3*b>=a?a>b&&2*b>=a?"-2*":"-":a>4*b&&5*b>=a?"+2*":"+",d.xgn=b>=a||a>5*b?"+":a>2*b&&4*b>=a?"-":""):(d.xgn=3*b>=a?a>b&&2*b>=a?"+2*":"+":a>4*b&&5*b>=a?"-2*":"-",d.ygn=b>=a||a>5*b?"+":a>2*b&&4*b>=a?"-":""),d},_replaceAttr4Arnd:function(a){var b=a.lup;a.l=a.up,a.lup=a.rup,a.rup=a.rdwn,a.r=a.dwn,a.rdwn=a.ldwn,a.ldwn=b,delete a.up,delete a.dwn},clear:function(){this.ctx.clearRect(0,0,this.w,this.h)},gridReset:function(){this.init_r="",this.cent_x="",this.cent_y="",this.cirNum=-1,this.initNd={},this.grid={}},onDraw:function(a,b){var c=document.getElementById(a),d=c.getContext("2d"),e=c.width,f=c.height;this._container=c,this.ctx=d,this.w=e,this.h=f;var g=["#191970","#8B2500","#2E8B57","#CD9B1D","#68228B","#CD3278","#333333","#FF4500","#B22222","#668B8B","#DC143C","#1F1F1F"],h=0;if(b)for(var i in this.grid)h++;else h=1;for(var j=0;h>j;j++){var k=this.grid["lev_"+j].ele,l=j%2==0?0:1;for(var m in k){var n=this.getEdgeCoor(k[m].x,k[m].y,k[m].r,l);d.beginPath(),d.strokeStyle=g[j],d.lineWidth=.8*j+1,d.moveTo(n[0].x,n[0].y);for(var o=1;6>o;o++)d.lineTo(n[o].x,n[o].y);d.lineTo(n[0].x,n[0].y),d.stroke()}}d.beginPath(),d.fillStyle="#ff0000",d.arc(this.cent_x,this.cent_y,3,0,2*Math.PI),d.fill()}}),gEcnu.DrawGrid=gClass.extend({init:function(a,b){this._map=a,this._layer=b}}),gEcnu.DrawGrid.hexGrid=gEcnu.DrawGrid.extend({init:function(a,b){this._super(a,b),this.mapdb="mapb"},buildGridByFeat:function(a,b,c){var d=this;if(c instanceof Array||""==c||(c=[c]),a&&a instanceof gEcnu.Feature.Polygon)for(var e=a.shape.NumParts,f=0;e>f;f++){var g=a._lineRings[f],h=d.getmaxR4poly(g,c[f]);d._fillGridByPoly(g,b,h,c[f],!1)}else alert("请检查填充要素类型")},getmaxR4poly:function(a,b){for(var c=r2=0,d="undefined"==typeof b?a.getCenterPoint():b,e=a.points,f=e.length,g=0;f>g;g++){var h=Math.pow(e[g].x-d.x,2)+Math.pow(e[g].y-d.y,2);h>r2&&(r2=h)}return c=Math.sqrt(r2)},_fillGridByPoly:function(a,b,c,d,e){var f="undefined"==typeof d?a.getCenterPoint():d,b="undefined"==typeof b?5e4:b,g=new gEcnu.Grid.hexGrid(f.x,f.y,b,{R:c}),h=0;if(e)for(var i in g.grid)h++;else h=1;for(var j=0;h>j;j++){var k=g.grid["lev_"+j].ele,l=j%2==0?0:1;for(var m in k){var n,o=[],p=k[m];if(!gEcnu.Graph.pointInPoly(p,a.points)){var q=!1;n=g.getEdgeCoor(p.x,p.y,p.r,l);for(var r=0;r<n.length;r++)if(gEcnu.Graph.pointInPoly(n[r],a.points)){q=!0;break}if(!q)continue}n=g.getEdgeCoor(p.x,p.y,p.r,l);for(var s=0;s<n.length;s++){var t=new gEcnu.Geometry.Point(n[s].x,n[s].y);o.push(t)}var u=new gEcnu.Geometry.LinearRing(o),v=new gEcnu.Feature.Polygon([u]);this._layer.addFeature(v)}}},clear:function(){this._layer.removeAllFeatures()}}),gEcnu.WebGeoCoding=gClass.extend({init:function(a){"undefined"!=typeof a&&(this.events._events.processCompleted=a.processCompleted,this.events._events.processFailed=a.processFailed)},geoCoding:function(a){var b=gEcnu.config.geoserver+"GeoUtils",c={mt:"GeoCoding",shape:a.shape},d=JSON.stringify(c),e={req:d},f=this;try{gEcnu.Util.ajax("POST",b,e,!1,function(a){if("undefined"!=typeof f.events._events.processCompleted){var b=JSON.parse(a);f.events._events.processCompleted(b)}},function(){alert("webgeocoding请求超时")},5e5)}catch(g){"undefined"!=typeof f.events._events.processFailed&&f.events._events.processFailed(g)}},deGeoCoding:function(a){},events:{_events:{},on:function(a,b){switch(a){case"processCompleted":this._events.processCompleted=b;break;case"processFailed":this._events.processFailed=b}}}});